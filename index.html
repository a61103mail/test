<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V20 è‡ªé¸æ¿¾é¡ç‰ˆ)</title>
    <style>
        :root {
            --bg: #0b0e11;
            --card: #161a1e;
            --text-main: #eaecef;
            --text-sub: #848e9c;
            --green: #0ecb81;
            --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d;
            --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535;
            --yellow-bg: rgba(252, 213, 53, 0.1);
            --border: #2b3139;
            --modal-bg: #1e2329;
        }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }
        
        /* é ‚éƒ¨å°èˆª */
        .header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-filter {
            background: #2b3139;
            color: #fff;
            border: 1px solid #444;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        .btn-filter:hover { background: #3a4149; border-color: #666; }

        /* --- æ¨¡æ…‹æ¡† (Filter Modal) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            display: none; /* é è¨­éš±è— */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: var(--modal-bg);
            width: 90%; max-width: 600px;
            max-height: 80vh;
            border-radius: 8px;
            border: 1px solid #444;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .modal-header {
            padding: 15px; border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .modal-body {
            padding: 15px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }
        .modal-footer {
            padding: 15px; border-top: 1px solid #333;
            text-align: right;
        }
        
        /* æœå°‹æ¡† */
        .search-input {
            background: #0b0e11; border: 1px solid #444; color: #fff;
            padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* å¹£ç¨®é¸é … */
        .coin-option {
            background: #0b0e11;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #333;
            cursor: pointer;
            text-align: center;
            font-family: 'Roboto Mono';
            font-size: 12px;
            user-select: none;
        }
        .coin-option:hover { border-color: #666; }
        .coin-option.selected {
            background: var(--green-bg);
            border-color: var(--green);
            color: var(--green);
            font-weight: bold;
        }
        
        .btn-confirm {
            background: var(--green); color: #000; border: none;
            padding: 8px 20px; border-radius: 4px; font-weight: bold; cursor: pointer;
        }

        /* --- ä¸»å…§å®¹ (V17 æ¨£å¼) --- */
        .symbol-row {
            display: grid;
            grid-template-columns: 200px 1fr 1fr 1fr;
            gap: 10px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .close-card {
            position: absolute; top: 5px; right: 5px;
            color: #444; cursor: pointer; font-size: 16px; z-index: 10;
            padding: 0 5px;
        }
        .close-card:hover { color: var(--red); }

        .col-info { background: #1e2329; padding: 12px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid var(--border); }
        .sym-header { display: flex; justify-content: space-between; align-items: baseline; }
        .sym-name { font-size: 20px; font-weight: 900; color: #fff; }
        .sym-price { font-size: 16px; font-family: 'Roboto Mono'; font-weight: bold; }
        .up { color: var(--green); } .down { color: var(--red); }

        .vol-box { margin-top: 5px; padding-top: 5px; border-top: 1px dashed #333; font-size: 11px; }
        .vol-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .vol-tag { padding: 1px 4px; border-radius: 2px; font-weight: bold; }
        .v-high { background: var(--yellow); color: #000; } 
        .v-norm { background: #444; color: #ccc; }
        .v-low { background: #222; color: #666; }

        .flow-box { margin-top: 5px; padding-top: 5px; border-top: 1px dashed #333; }
        .flow-title { font-size: 11px; color: #aaa; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .flow-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 4px; overflow: hidden; display: flex; }
        .flow-buy { height: 100%; background: var(--green); }
        .flow-sell { height: 100%; background: var(--red); }
        .flow-val { font-size: 10px; display: flex; justify-content: space-between; margin-top: 2px; font-family: 'Roboto Mono'; }
        
        .col-tf { padding: 8px; border-right: 1px dashed #333; display: flex; flex-direction: column; }
        .col-tf:last-child { border-right: none; }

        .tf-header { margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; }
        .tf-title-row { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center; }
        .tf-title { font-weight: bold; font-size: 14px; color: #fff; }
        
        .wr-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; }
        .wr-bar-long { height: 100%; background: var(--green); transition: width 0.5s; }
        .wr-bar-short { height: 100%; background: var(--red); transition: width 0.5s; }
        .wr-text { font-size: 10px; display: flex; justify-content: space-between; color: #888; margin-top: 2px; }

        .ind-list { display: grid; grid-template-columns: 1fr; gap: 4px; margin-bottom: 8px; }
        .ind-item { font-size: 11px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.03); padding: 4px 6px; border-radius: 3px; }
        .ind-left { display: flex; flex-direction: column; }
        .ind-right { text-align: right; }
        .ind-name { color: #aaa; font-size: 10px; }
        .ind-val { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }
        
        .win-dual { font-size: 10px; font-family: 'Roboto Mono'; display: flex; gap: 5px; }
        .w-l { color: var(--green); opacity: 0.5; }
        .w-s { color: var(--red); opacity: 0.5; }
        .active-side { opacity: 1; font-weight: bold; text-decoration: underline; }

        .strat-box { margin-top: auto; padding: 6px; border-radius: 4px; text-align: center; border: 1px solid transparent; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .strat-chop { background: var(--yellow-bg); border-color: var(--yellow); border-style: dashed; color: var(--yellow); }
        .strat-wait { background: #2b3139; border-color: #444; color: #888; }

        .strat-title { font-size: 13px; font-weight: bold; margin-bottom: 6px; display: block; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 4px; }
        .s-long { color: var(--green); } .s-short { color: var(--red); } .s-chop { color: var(--yellow); }

        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 10px; font-size: 11px; text-align: left; }
        .sg-item { display: flex; flex-direction: column; }
        .sg-label { color: var(--text-sub); scale: 0.9; transform-origin: left; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }
        .blur-text { filter: blur(4px); opacity: 0.5; }

        .loading-text { text-align: center; color: #666; margin-top: 50px; font-size: 16px; }

        @media (max-width: 900px) {
            .symbol-row { display: flex; flex-direction: column; gap: 0; margin-bottom: 20px; border: 1px solid #444; }
            .col-info { flex-direction: column; gap: 10px; padding: 15px; border-right: none; border-bottom: 1px solid var(--border); background: #252a30; }
            .col-tf { border-right: none; border-bottom: 1px dashed #333; padding: 15px; }
            .col-tf:last-child { border-bottom: none; }
            .ind-list { grid-template-columns: 1fr 1fr; gap: 8px; }
            .ind-item { flex-direction: column; align-items: flex-start; gap: 4px; }
            .ind-right { width: 100%; text-align: left; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="filterModal">
    <div class="modal-content">
        <div class="modal-header">
            <span style="font-size:16px; font-weight:bold;">é¸æ“‡ç›£æ§å¹£ç¨®</span>
            <span style="cursor:pointer;" onclick="closeModal()">âœ•</span>
        </div>
        <div style="padding: 0 15px; margin-top:15px;">
            <input type="text" class="search-input" id="coinSearch" placeholder="æœå°‹å¹£ç¨® (å¦‚: BTC, SOL)..." onkeyup="filterCoins()">
        </div>
        <div class="modal-body" id="coinList">
            <div style="color:#888;">æ­£åœ¨å¾ Binance ç²å–åˆç´„æ¸…å–®...</div>
        </div>
        <div class="modal-footer">
            <button class="btn-confirm" onclick="applyFilter()">ç¢ºèªä¸¦è¼‰å…¥æ•¸æ“š</button>
        </div>
    </div>
</div>

<div class="header">
    <div>
        <h1 style="margin:0; font-size:20px;">æˆ°æƒ…å®¤ V20 (è‡ªé¸æ¿¾é¡ç‰ˆ)</h1>
        <span style="color:#888; font-size:11px;">
            V17æ ¸å¿ƒ | çœŸå¯¦Taker | é‡åƒ¹çµæ§‹ | é›™å‘å›æ¸¬
        </span>
    </div>
    <div>
        <button class="btn-filter" onclick="openModal()">
            <span>â•</span> ç¯©é¸å¹£ç¨®
        </button>
    </div>
</div>

<div id="grid-container">
    <div class="loading-text">
        ğŸ‘‹ æ­¡è¿ä½¿ç”¨ï¼è«‹é»æ“Šå³ä¸Šè§’ <b>[â• ç¯©é¸å¹£ç¨®]</b> é–‹å§‹å»ºç«‹ä½ çš„æˆ°æƒ…å®¤ã€‚
    </div>
</div>

<script>
    // å…¨åŸŸé…ç½®
    const TFS = ['15m', '1h', '4h'];
    const LIMIT = 500; 
    
    const TRANS = {
        '15m': '15åˆ†é˜ (çŸ­ç·š)', '1h': '1å°æ™‚ (æ³¢æ®µ)', '4h': '4å°æ™‚ (è¶¨å‹¢)',
        'RSI': 'RSI', 'EMA': 'EMA', 'MACD': 'MACD', 'VWAP': 'VWAP', 'BOLL': 'BOLL'
    };

    // ç‹€æ…‹ç®¡ç†
    let allSymbols = []; // å¹£å®‰æ‰€æœ‰åˆç´„
    let activeSymbols = new Set(); // ä½¿ç”¨è€…é¸ä¸­çš„
    let wss = null; // WebSocket é€£ç·š
    let store = {}; // æ•¸æ“šç·©å­˜

    // --- 1. ç³»çµ±åˆå§‹åŒ–èˆ‡ API ---
    async function fetchExchangeInfo() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await res.json();
            // éæ¿¾å‡º USDT æ°¸çºŒåˆç´„
            allSymbols = data.symbols
                .filter(s => s.quoteAsset === 'USDT' && s.contractType === 'PERPETUAL' && s.status === 'TRADING')
                .map(s => s.symbol.replace('USDT', ''))
                .sort();
            
            renderCoinList();
        } catch (e) {
            document.getElementById('coinList').innerHTML = `<span style="color:red">APIé€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯</span>`;
        }
    }

    // --- 2. æ¨¡æ…‹æ¡†é‚è¼¯ ---
    function openModal() {
        if(allSymbols.length === 0) fetchExchangeInfo();
        document.getElementById('filterModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('filterModal').style.display = 'none';
    }

    function renderCoinList() {
        const container = document.getElementById('coinList');
        container.innerHTML = '';
        allSymbols.forEach(sym => {
            const div = document.createElement('div');
            div.className = `coin-option ${activeSymbols.has(sym.toLowerCase() + 'usdt') ? 'selected' : ''}`;
            div.textContent = sym;
            div.dataset.sym = sym.toLowerCase() + 'usdt'; // å­˜å®Œæ•´ä»£ç¢¼
            div.onclick = () => toggleSelect(div);
            container.appendChild(div);
        });
    }

    function toggleSelect(el) {
        el.classList.toggle('selected');
    }

    function filterCoins() {
        const txt = document.getElementById('coinSearch').value.toUpperCase();
        const opts = document.querySelectorAll('.coin-option');
        opts.forEach(opt => {
            opt.style.display = opt.textContent.includes(txt) ? 'block' : 'none';
        });
    }

    // --- 3. æ‡‰ç”¨ç¯©é¸ (æ ¸å¿ƒæµç¨‹) ---
    async function applyFilter() {
        // 1. ç²å–é¸ä¸­çš„å¹£ç¨®
        const selected = Array.from(document.querySelectorAll('.coin-option.selected'))
                              .map(el => el.dataset.sym);
        
        activeSymbols = new Set(selected);
        closeModal();

        const container = document.getElementById('grid-container');
        container.innerHTML = ''; // æ¸…ç©ºç•«é¢

        if(selected.length === 0) {
            container.innerHTML = '<div class="loading-text">æœªé¸æ“‡ä»»ä½•å¹£ç¨®ã€‚</div>';
            if(wss) wss.close();
            return;
        }

        container.innerHTML = '<div class="loading-text" style="color:var(--yellow)">æ­£åœ¨åˆå§‹åŒ–æ•¸æ“šå¼•æ“...<br>è«‹ç¨å€™ï¼Œé¿å… API é€Ÿç‡é™åˆ¶ã€‚</div>';

        // 2. é—œé–‰èˆŠé€£ç·š
        if(wss) wss.close();
        store = {}; // é‡ç½®æ•¸æ“š

        // 3. ä¾åºåˆå§‹åŒ– (é¿å…ä½µç™¼éé«˜)
        for (const sym of selected) {
            await initSymbol(sym);
            // ç°¡å–®å»¶é² 200ms
            await new Promise(r => setTimeout(r, 200));
        }

        // 4. å•Ÿå‹• WSS (åªè¨‚é–±é¸ä¸­çš„)
        connectWSS(selected);
    }

    // --- 4. å–®ä¸€å¹£ç¨®åˆå§‹åŒ– (ç¹ªè£½å¡ç‰‡ + æ‹‰å–æ­·å²) ---
    async function initSymbol(sym) {
        store[sym] = {}; // Init store
        const container = document.getElementById('grid-container');
        
        // ç§»é™¤ Loading (å¦‚æœæ˜¯ç¬¬ä¸€å€‹)
        if(container.querySelector('.loading-text')) container.innerHTML = '';

        // ç¹ªè£½éª¨æ¶ (V17 çµæ§‹)
        let html = `
        <div class="symbol-row" id="row-${sym}">
            <div class="close-card" onclick="removeCard('${sym}')">âœ•</div>
            <div class="col-info">
                <div class="sym-header">
                    <div class="sym-name">${sym.toUpperCase().replace('USDT','')}</div>
                    <div class="sym-price" id="price-${sym}">--.--</div>
                </div>
                <div class="vol-box">
                    <div class="vol-row" style="color:#aaa;">é‡èƒ½ (1h)</div>
                    <div class="vol-row">
                        <span id="vol-status-${sym}" class="vol-tag v-norm">...</span>
                        <span id="vol-ratio-${sym}" style="font-family:Roboto Mono;">x1.0</span>
                    </div>
                </div>
                <div class="flow-box">
                    <div class="flow-title"><span>Taker Flow (1h)</span></div>
                    <div class="flow-bar-bg">
                        <div class="flow-buy" id="flow-b-${sym}" style="width:50%"></div>
                        <div class="flow-sell" id="flow-s-${sym}" style="width:50%"></div>
                    </div>
                    <div class="flow-val">
                        <span style="color:var(--green)" id="flow-bv-${sym}">--%</span>
                        <span style="color:var(--red)" id="flow-sv-${sym}">--%</span>
                    </div>
                </div>
            </div>`;

        TFS.forEach(tf => {
            store[sym][tf] = {}; 
            html += `
            <div class="col-tf">
                <div class="tf-header">
                    <div class="tf-title-row"><span class="tf-title">${TRANS[tf]}</span></div>
                    <div class="wr-bar-bg">
                        <div class="wr-bar-long" id="bar-l-${sym}-${tf}" style="width:50%"></div>
                        <div class="wr-bar-short" id="bar-s-${sym}-${tf}" style="width:50%"></div>
                    </div>
                    <div class="wr-text"><span id="wr-l-${sym}-${tf}">å¤š --%</span><span id="wr-s-${sym}-${tf}">ç©º --%</span></div>
                </div>
                <div class="ind-list" id="list-${sym}-${tf}"><div style="color:#444;">ä¸‹è¼‰ä¸­...</div></div>
                <div class="strat-box strat-wait" id="strat-${sym}-${tf}">
                    <span class="strat-title" id="act-${sym}-${tf}">è§€æœ›</span>
                    <div class="strat-grid">
                        <div class="sg-item"><span class="sg-label">é€²å ´</span><span class="sg-val" id="en-${sym}-${tf}">---</span></div>
                        <div class="sg-item"><span class="sg-label">æ­¢æ</span><span class="sg-val" id="sl-${sym}-${tf}">---</span></div>
                        <div class="sg-item"><span class="sg-label">æ­¢ç›ˆ1</span><span class="sg-val" id="tp1-${sym}-${tf}">---</span></div>
                        <div class="sg-item"><span class="sg-label">æ­¢ç›ˆ2</span><span class="sg-val" id="tp2-${sym}-${tf}">---</span></div>
                    </div>
                </div>
            </div>`;
        });
        html += `</div>`;
        container.insertAdjacentHTML('beforeend', html);

        // æ‹‰å–æ­·å²æ•¸æ“š (Promise.all)
        try {
            const promises = TFS.map(tf => 
                fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym.toUpperCase()}&interval=${tf}&limit=${LIMIT}`)
                .then(res => res.json())
            );
            const results = await Promise.all(promises);
            
            results.forEach((data, i) => {
                const tf = TFS[i];
                data.pop(); // ç§»é™¤æœªå®Œæˆ
                processTimeframe(sym, tf, data);
                if(tf === '1h') {
                    calculateFlow(sym, data);
                    calculateVolume(sym, data);
                }
            });
        } catch(e) { console.error(sym, e); }
    }

    function removeCard(sym) {
        activeSymbols.delete(sym);
        document.getElementById(`row-${sym}`).remove();
        // é€™è£¡æš«æ™‚ä¸é‡é€£ WSS ä»¥ç¯€çœè³‡æºï¼Œè®“ä»–åœ¨èƒŒæ™¯è·‘æ²’é—œä¿‚ï¼Œåæ­£æ²’æœ‰ UI æ›´æ–°
    }

    // --- 5. æ•¸æ“šé‹ç®— (V17 Logic) ---
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        emaArray: (data, period) => {
            let k = 2 / (period + 1);
            let ema = [data[0]];
            for (let i = 1; i < data.length; i++) ema.push(data[i] * k + ema[i-1] * (1 - k));
            return ema;
        },
        rsiArray: (closes) => {
            let rsi = [];
            let gains = 0, losses = 0;
            for(let i=1; i<=14; i++) {
                let diff = closes[i] - closes[i-1];
                if(diff>0) gains+=diff; else losses-=diff;
            }
            let avgGain = gains/14; let avgLoss = losses/14;
            rsi[14] = 100 - (100/(1+avgGain/avgLoss));
            for(let i=15; i<closes.length; i++) {
                let diff = closes[i] - closes[i-1];
                if(diff>0) { avgGain=(avgGain*13+diff)/14; avgLoss=(avgLoss*13)/14; }
                else { avgGain=(avgGain*13)/14; avgLoss=(avgLoss*13-diff)/14; }
                rsi[i] = avgLoss===0 ? 100 : 100 - (100/(1+avgGain/avgLoss));
            }
            return rsi;
        },
        atr: (h, l, c, p=14) => {
            if(h.length < p) return 0;
            let trs = [];
            for(let i=1; i<h.length; i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
        },
        getWinRate: (signals, closes, type) => {
            let wins = 0, total = 0;
            const lookahead = 5; 
            for(let i=50; i<signals.length-lookahead; i++) {
                if(signals[i]) {
                    total++;
                    const entry = closes[i];
                    const exit = closes[i+lookahead];
                    if(type === 'long' && exit > entry * 1.001) wins++;
                    else if(type === 'short' && exit < entry * 0.999) wins++;
                }
            }
            return total === 0 ? 0 : Math.round((wins/total)*100);
        }
    };

    function calculateVolume(sym, klines) {
        const len = klines.length;
        const currentVol = parseFloat(klines[len-1][5]);
        let sumVol = 0;
        for(let i=len-21; i<len-1; i++) sumVol += parseFloat(klines[i][5]);
        const avgVol = sumVol / 20;
        const ratio = currentVol / avgVol;
        const elStatus = document.getElementById(`vol-status-${sym}`);
        const elRatio = document.getElementById(`vol-ratio-${sym}`);
        elRatio.textContent = `x${ratio.toFixed(1)}`;
        if (ratio >= 2.0) { elStatus.textContent = "ğŸ”¥ çˆ†é‡"; elStatus.className = "vol-tag v-high"; }
        else if (ratio >= 1.2) { elStatus.textContent = "ğŸ“ˆ æ”¾é‡"; elStatus.className = "vol-tag v-norm"; }
        else if (ratio <= 0.6) { elStatus.textContent = "ğŸ’¤ ç¸®é‡"; elStatus.className = "vol-tag v-low"; }
        else { elStatus.textContent = "âš–ï¸ æ­£å¸¸"; elStatus.className = "vol-tag v-norm"; }
    }

    function calculateFlow(sym, klines) {
        const recent = klines.slice(-24);
        let totalVol = 0, buyVol = 0;
        recent.forEach(k => { totalVol += parseFloat(k[5]); buyVol += parseFloat(k[9]); });
        const buyPct = (buyVol / totalVol) * 100;
        const sellPct = 100 - buyPct;
        document.getElementById(`flow-b-${sym}`).style.width = `${buyPct}%`;
        document.getElementById(`flow-s-${sym}`).style.width = `${sellPct}%`;
        document.getElementById(`flow-bv-${sym}`).textContent = `è²·${buyPct.toFixed(0)}%`;
        document.getElementById(`flow-sv-${sym}`).textContent = `è³£${sellPct.toFixed(0)}%`;
    }

    function processTimeframe(sym, tf, klines) {
        const closes = klines.map(d => parseFloat(d[4]));
        const highs = klines.map(d => parseFloat(d[2]));
        const lows = klines.map(d => parseFloat(d[3]));
        const len = closes.length;
        const last = len - 1;
        const curPrice = closes[last];

        const atr = MathEngine.atr(highs, lows, closes);
        const rsiArr = MathEngine.rsiArray(closes);
        const ema50Arr = MathEngine.emaArray(closes, 50);
        const vwapArr = MathEngine.emaArray(closes, 90); 
        
        let sma20=[], upper=[], lower=[];
        for(let i=0; i<len; i++) {
            if(i<20) { sma20.push(0); upper.push(0); lower.push(0); continue; }
            let slice = closes.slice(i-20, i);
            let avg = slice.reduce((a,b)=>a+b,0)/20;
            let std = Math.sqrt(slice.map(x=>Math.pow(x-avg,2)).reduce((a,b)=>a+b,0)/20);
            sma20.push(avg); upper.push(avg+2*std); lower.push(avg-2*std);
        }

        let ema12 = MathEngine.emaArray(closes, 12);
        let ema26 = MathEngine.emaArray(closes, 26);
        let macdArr = ema12.map((v,i) => v - ema26[i]);

        const sigs = { rsi_buy:[], rsi_sell:[], ema_buy:[], ema_sell:[], macd_buy:[], macd_sell:[], vwap_buy:[], vwap_sell:[], bb_buy:[], bb_sell:[] };
        for(let i=50; i<len; i++) {
            const c = closes[i];
            sigs.rsi_buy[i] = rsiArr[i]<40; sigs.rsi_sell[i] = rsiArr[i]>60;
            sigs.ema_buy[i] = c>ema50Arr[i]; sigs.ema_sell[i] = c<ema50Arr[i];
            sigs.macd_buy[i] = macdArr[i]>0; sigs.macd_sell[i] = macdArr[i]<0;
            sigs.vwap_buy[i] = c>vwapArr[i]; sigs.vwap_sell[i] = c<vwapArr[i];
            sigs.bb_buy[i] = c>upper[i]; sigs.bb_sell[i] = c<lower[i];
        }

        const calcWR = (b, s) => ({ long: MathEngine.getWinRate(b, closes, 'long'), short: MathEngine.getWinRate(s, closes, 'short') });
        const wrRSI = calcWR(sigs.rsi_buy, sigs.rsi_sell);
        const wrEMA = calcWR(sigs.ema_buy, sigs.ema_sell);
        const wrMACD = calcWR(sigs.macd_buy, sigs.macd_sell);
        const wrVWAP = calcWR(sigs.vwap_buy, sigs.vwap_sell);
        const wrBB = calcWR(sigs.bb_buy, sigs.bb_sell);

        const fVal = v => v<10 ? v.toFixed(4) : v.toFixed(2);
        const getDir = (b, s) => b ? 'long' : s ? 'short' : 'neu';

        const indData = [
            { id:'RSI', n:TRANS['RSI'], val: rsiArr[last].toFixed(1), dir: getDir(rsiArr[last]>55, rsiArr[last]<45), wr: wrRSI },
            { id:'EMA', n:TRANS['EMA'], val: fVal(ema50Arr[last]), dir: getDir(curPrice>ema50Arr[last], curPrice<ema50Arr[last]), wr: wrEMA },
            { id:'MACD', n:TRANS['MACD'], val: macdArr[last].toFixed(4), dir: getDir(macdArr[last]>0, macdArr[last]<0), wr: wrMACD },
            { id:'VWAP', n:TRANS['VWAP'], val: fVal(vwapArr[last]), dir: getDir(curPrice>vwapArr[last], curPrice<vwapArr[last]), wr: wrVWAP },
            { id:'BOLL', n:TRANS['BOLL'], val: curPrice>upper[last]?'ä¸Šç ´':curPrice<lower[last]?'ä¸‹ç ´':'å€é–“', dir: getDir(curPrice>upper[last], curPrice<lower[last]), wr: wrBB }
        ];

        const listEl = document.getElementById(`list-${sym}-${tf}`);
        let listHtml = '';
        let sumLongWR = 0, sumShortWR = 0, count = 0;
        let signalCount = { long: 0, short: 0 };

        indData.forEach(ind => {
            if(ind.wr.long > 0) sumLongWR += ind.wr.long;
            if(ind.wr.short > 0) sumShortWR += ind.wr.short;
            count++;
            if(ind.dir === 'long') signalCount.long++;
            if(ind.dir === 'short') signalCount.short++;

            const isLong = ind.dir === 'long';
            const isShort = ind.dir === 'short';
            const color = isLong ? 'var(--green)' : isShort ? 'var(--red)' : '#666';
            const lClass = isLong ? 'w-l active-side' : 'w-l';
            const sClass = isShort ? 'w-s active-side' : 'w-s';

            listHtml += `
                <div class="ind-item">
                    <div class="ind-left">
                        <span class="ind-name">${ind.n} <span style="font-family:Arial; opacity:0.5">(${ind.id})</span></span>
                        <span class="ind-val" style="color:${color}">${ind.val}</span>
                    </div>
                    <div class="ind-right">
                        <div class="win-dual">
                            <span class="${lClass}">å¤š${ind.wr.long}%</span> | <span class="${sClass}">ç©º${ind.wr.short}%</span>
                        </div>
                    </div>
                </div>`;
        });
        listEl.innerHTML = listHtml;

        const avgLong = Math.round(sumLongWR / count);
        const avgShort = Math.round(sumShortWR / count);
        document.getElementById(`bar-l-${sym}-${tf}`).style.width = `${(avgLong/(avgLong+avgShort))*100}%`;
        document.getElementById(`bar-s-${sym}-${tf}`).style.width = `${(avgShort/(avgLong+avgShort))*100}%`;
        document.getElementById(`wr-l-${sym}-${tf}`).textContent = `å¤š${avgLong}%`;
        document.getElementById(`wr-s-${sym}-${tf}`).textContent = `ç©º${avgShort}%`;

        // ç­–ç•¥é‚è¼¯ (V17 Logic)
        const stratBox = document.getElementById(`strat-${sym}-${tf}`);
        const actTitle = document.getElementById(`act-${sym}-${tf}`);
        const enEl = document.getElementById(`en-${sym}-${tf}`);
        const slEl = document.getElementById(`sl-${sym}-${tf}`);
        const tp1El = document.getElementById(`tp1-${sym}-${tf}`);
        const tp2El = document.getElementById(`tp2-${sym}-${tf}`);
        const sgVals = stratBox.querySelectorAll('.sg-val');

        let decision = 'wait';
        if (avgLong >= 53 && avgLong > avgShort) decision = 'long';
        else if (avgShort >= 53 && avgShort > avgLong) decision = 'short';
        else if (avgLong < 50 && avgShort < 50) decision = 'chop';

        if (decision === 'long') {
            stratBox.className = 'strat-box strat-long';
            actTitle.innerHTML = `<span class="s-long">å»ºè­°åšå¤š (å‹ç‡${avgLong}%)</span>`;
            enEl.textContent = fVal(curPrice); slEl.textContent = fVal(curPrice - atr*1.5);
            tp1El.textContent = fVal(curPrice + atr*1.2); tp2El.textContent = fVal(curPrice + atr*2.5);
            sgVals.forEach(el => el.classList.remove('blur-text'));
        } else if (decision === 'short') {
            stratBox.className = 'strat-box strat-short';
            actTitle.innerHTML = `<span class="s-short">å»ºè­°åšç©º (å‹ç‡${avgShort}%)</span>`;
            enEl.textContent = fVal(curPrice); slEl.textContent = fVal(curPrice + atr*1.5);
            tp1El.textContent = fVal(curPrice - atr*1.2); tp2El.textContent = fVal(curPrice - atr*2.5);
            sgVals.forEach(el => el.classList.remove('blur-text'));
        } else if (decision === 'chop') {
            stratBox.className = 'strat-box strat-chop';
            actTitle.innerHTML = `<span class="s-chop">âš ï¸ ç›¤æ•´ (é›™æ®ºé¢¨éšª)</span>`;
            sgVals.forEach(el => el.classList.add('blur-text'));
        } else {
            stratBox.className = 'strat-box strat-wait';
            actTitle.innerHTML = `<span>è§€æœ›</span>`;
            sgVals.forEach(el => el.classList.remove('blur-text'));
        }
    }

    function connectWSS(symbols) {
        const streams = symbols.map(s => `${s}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const sym = msg.data.s.toLowerCase();
            const price = parseFloat(msg.data.c);
            const el = document.getElementById(`price-${sym}`);
            if(el) {
                el.textContent = price;
                el.className = `sym-price ${parseFloat(msg.data.P)>=0?'up':'down'}`;
            }
        };
    }
</script>
</body>
</html>
