<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V56 GitHub éƒ¨ç½²ç‰ˆ)</title>
    <style>
        /* =========================================
           V56 è¦–è¦ºæ ¸å¿ƒæ¨£å¼ (Dark Mode / Neon)
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d; --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535; --yellow-bg: rgba(252, 213, 53, 0.1);
            --gold: #ffd700; --gold-bg: rgba(255, 215, 0, 0.25);
            --silver: #e0e0e0; --silver-bg: rgba(224, 224, 224, 0.15);
            --bronze: #ffad5e; --bronze-bg: rgba(255, 173, 94, 0.15);
            --blue: #2979ff; --blue-bg: rgba(41, 121, 255, 0.15);
            --purple: #bf5af2; --purple-bg: rgba(191, 90, 242, 0.2);
            --border: #2b3139; --modal-bg: #1e2329;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; margin: 0; padding: 15px; font-size: 13px; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;}
        .status-bar { background: #1e2329; padding: 6px 12px; border-radius: 4px; border-left: 4px solid var(--yellow); font-size: 11px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .system-log { color: #888; font-family: 'Roboto Mono'; font-size: 10px; margin-left: auto; }
        
        /* é€²åº¦æ¢ */
        .timer-container { width: 100px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--yellow); width: 0%; transition: width 0.5s linear; }

        /* å¡ç‰‡å®¹å™¨ */
        #grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 10px; }
        
        /* å¹£ç¨®å¡ç‰‡ */
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; transition: all 0.2s ease; position: relative; }
        .coin-card:hover { border-color: #555; }
        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1e2329; border-bottom: 1px solid transparent; }
        .expanded .card-header { border-bottom: 1px solid var(--border); background: #252a30; }

        .ch-left, .ch-right { display: flex; align-items: center; gap: 10px; }
        .sym-name { font-size: 16px; font-weight: 900; color: #fff; width: 80px; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 15px; min-width: 80px; }
        .up { color: var(--green); } .down { color: var(--red); }
        
        /* å¾½ç«  */
        .tier-badge { font-size: 10px; padding: 2px 6px; border-radius: 3px; font-weight: bold; display: none; }
        .tier-s { background: var(--gold-bg); color: var(--gold); border: 1px solid var(--gold); display: inline-block; box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); animation: pulse 2s infinite; }
        .tier-a { background: var(--silver-bg); color: var(--silver); border: 1px solid var(--silver); display: inline-block; }
        .tier-b { background: var(--bronze-bg); color: var(--bronze); border: 1px solid var(--bronze); display: inline-block; }
        .tier-z { background: #333; color: #666; border: 1px dashed #555; display: inline-block; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* å¡ç‰‡å…§å®¹å€ */
        .card-body { display: none; padding: 10px; background: #111; grid-template-columns: 100px 1fr 1fr 1fr; gap: 5px; }
        .expanded .card-body { display: grid; }
        
        /* è³‡è¨Šæ¬„ */
        .col-info { border-right: 1px dashed #333; display: flex; flex-direction: column; gap: 8px; padding-right: 5px; }
        .col-tf { border-right: 1px dashed #333; padding: 0 5px; display: flex; flex-direction: column; }
        .col-tf:last-child { border-right: none; }

        .tf-header { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; display: flex; justify-content: space-between; font-weight: bold; color: #ddd; font-size: 12px; }

        /* æŒ‡æ¨™åˆ—è¡¨ */
        .ind-item { display: flex; justify-content: space-between; font-size: 10px; padding: 2px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .ind-val { font-family: 'Roboto Mono'; font-weight: bold; }
        
        /* æˆ°è¡“å…­å®®æ ¼ */
        .strat-box { margin-top: auto; padding: 4px; border-radius: 4px; text-align: center; border: 1px solid #333; background: #1a1a1a; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 10px; text-align: left; margin-top: 4px; }
        .sg-row { display: flex; justify-content: space-between; }
        .sg-label { color: #666; font-size: 9px; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; }
        .blur-text { opacity: 0.3; filter: blur(1px); }

        /* è³‡é‡‘æµèˆ‡é‡èƒ½ */
        .flow-bar-bg { width: 100%; height: 4px; background: #333; border-radius: 2px; overflow: hidden; display: flex; margin: 2px 0; }
        .flow-buy { background: var(--green); height: 100%; } .flow-sell { background: var(--red); height: 100%; }
        .vol-tag { font-size: 9px; padding: 1px 3px; border-radius: 2px; float: right; }
        .v-high { background: var(--yellow); color: #000; }
        
        /* Loading */
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:999; display:flex; justify-content:center; align-items:center; flex-direction: column; color: #fff; }

        @media (max-width: 900px) { 
            .card-body { grid-template-columns: 1fr; gap: 15px; } 
            .col-info { border-right: none; border-bottom: 1px dashed #333; padding-bottom: 10px; flex-direction: row; flex-wrap: wrap; justify-content: space-between;}
            .col-tf { border-right: none; border-bottom: 1px dashed #333; padding-bottom: 10px; }
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <h2>ğŸš€ æˆ°æƒ…å®¤ç³»çµ±å•Ÿå‹•ä¸­...</h2>
    <p id="loading-text">æ­£åœ¨åˆå§‹åŒ– API éšŠåˆ—...</p>
</div>

<div class="header">
    <div>
        <h1 style="margin:0; font-size:20px; color:var(--text-main);">å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span style="font-size:12px; color:var(--yellow);">V56 æŒ‡æ®å®˜ç‰ˆ</span></h1>
    </div>
    <div class="status-bar">
        <span>BTC è¶¨å‹¢: <strong id="btc-trend">...</strong></span>
        <span>ä¸‹æ¬¡æƒæ:</span>
        <div class="timer-container"><div class="timer-fill" id="scan-timer"></div></div>
        <button onclick="testDiscord()" style="background:#5865F2; border:none; padding:4px 8px; border-radius:4px; color:#fff; cursor:pointer; font-size:10px;">ğŸ’¬ æ¸¬è©¦é€šçŸ¥</button>
        <span class="system-log" id="sys-log">ç³»çµ±å°±ç·’</span>
    </div>
</div>

<div id="grid-container">
    </div>

<script>
    // ==========================================
    // âš™ï¸ ç”¨æˆ¶è¨­å®šå€åŸŸ (USER CONFIG)
    // ==========================================
    const DISCORD_WEBHOOK_URL = ""; // è«‹åœ¨æ­¤å¡«å…¥ä½ çš„ Webhook URL
   
    // ==========================================
    // ğŸš¦ æ ¸å¿ƒ 1: API éšŠåˆ—æ§åˆ¶å™¨ (Anti-Ban System)
    // ==========================================
    const API_QUEUE = {
        items: [],
        isProcessing: false,
        delay: 350, // 350ms é–“éš”ï¼Œç¢ºä¿å®‰å…¨ä¸è¢«å°é–

        add: function(task) {
            return new Promise((resolve, reject) => {
                this.items.push({ task, resolve, reject });
                this.process();
            });
        },
        process: async function() {
            if (this.isProcessing || this.items.length === 0) return;
            this.isProcessing = true;
            const { task, resolve, reject } = this.items.shift();
            try {
                const result = await task();
                resolve(result);
            } catch (e) {
                reject(e);
            }
            setTimeout(() => {
                this.isProcessing = false;
                this.process();
            }, this.delay);
        }
    };

    async function safeFetch(url) {
        return API_QUEUE.add(() => fetch(url).then(res => {
            if(!res.ok) throw new Error(`HTTP ${res.status}`);
            return res.json();
        }));
    }

    // ==========================================
    // ğŸ§® æ ¸å¿ƒ 2: æ•¸å­¸å¼•æ“ (Math Engine)
    // ==========================================
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        emaArray: (d, p) => { 
            let k=2/(p+1), ema=[d[0]]; 
            for(let i=1;i<d.length;i++) ema.push(d[i]*k+ema[i-1]*(1-k)); 
            return ema; 
        },
        rsi: (c, p=14) => {
            let gains=0, losses=0;
            for(let i=c.length-p; i<c.length; i++) {
                let diff = c[i] - c[i-1];
                if(diff >= 0) gains += diff; else losses -= diff;
            }
            if(losses === 0) return 100;
            let rs = (gains/p) / (losses/p);
            return 100 - (100/(1+rs));
        },
        atr: (h, l, c, p=14) => {
            let tr = 0;
            for(let i=c.length-p; i<c.length; i++) {
                tr += Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1]));
            }
            return tr / p;
        },
        bollinger: (c, p=20, mult=2) => {
            const sma = c.slice(-p).reduce((a,b)=>a+b,0)/p;
            const sqDiffs = c.slice(-p).map(v => Math.pow(v-sma, 2));
            const std = Math.sqrt(sqDiffs.reduce((a,b)=>a+b,0)/p);
            return { upper: sma + mult*std, lower: sma - mult*std, width: (2*mult*std)/sma };
        },
        adx: (h, l, c, p=14) => {
            // ç°¡æ˜“ç‰ˆ ADX è¨ˆç®—ï¼Œç”¨æ–¼åˆ¤æ–·è¶¨å‹¢å¼·åº¦
            let tr=0, pdm=0, mdm=0;
            for(let i=1; i<p+1; i++) {
                let idx = h.length-1-i;
                tr += Math.max(h[idx]-l[idx], Math.abs(h[idx]-c[idx-1]), Math.abs(l[idx]-c[idx-1]));
                let up = h[idx] - h[idx-1];
                let down = l[idx-1] - l[idx];
                pdm += (up>down && up>0) ? up : 0;
                mdm += (down>up && down>0) ? down : 0;
            }
            let pdi = 100 * (pdm/tr);
            let mdi = 100 * (mdm/tr);
            return Math.abs(pdi-mdi) / (pdi+mdi) * 100;
        }
    };

    // ==========================================
    // ğŸ§  æ ¸å¿ƒ 3: ç‹€æ…‹ç®¡ç†èˆ‡é‚è¼¯
    // ==========================================
    const State = {
        activeSymbols: new Set(),
        data: {}, // { BTCUSDT: { 15m: {...}, 1h: {...} } }
        btcTrend: 'neutral',
        prices: {} // å³æ™‚åƒ¹æ ¼
    };

    const CONSTANTS = {
        BLACKLIST: ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'BUSDUSDT', 'DAIUSDT', 'EURUSDT'],
        TFS: ['15m', '1h', '4h']
    };

    let wss = null;

    // ç³»çµ±å…¥å£
    async function initSystem() {
        document.getElementById('loading-text').textContent = "æ­£åœ¨æƒæå¸‚å ´å‰ 10 åç†±é»...";
        await updateTop10();
        
        document.getElementById('loading').style.display = 'none';
        
        // å•Ÿå‹•å®šæ™‚ä»»å‹™
        // 1. æ¯ 5 åˆ†é˜æƒæä¸€æ¬¡å¸‚å ´æ’å
        setInterval(updateTop10, 5 * 60 * 1000);
        // 2. æ¯ 1 åˆ†é˜æ›´æ–°æŒ‡æ¨™æ•¸æ“š
        setInterval(refreshIndicators, 60 * 1000);
        
        startTimerBar(5 * 60);
    }

    async function updateTop10() {
        log("æƒææˆäº¤é‡æ’å...");
        try {
            const data = await safeFetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            let pairs = data.filter(t => t.symbol.endsWith('USDT') && !CONSTANTS.BLACKLIST.includes(t.symbol));
            pairs.sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
            
            const newTop10 = pairs.slice(0, 10).map(t => t.symbol);
            const newSet = new Set(newTop10);

            // 1. ç§»é™¤è½æ¦œçš„
            for(let sym of State.activeSymbols) {
                if(!newSet.has(sym)) {
                    removeCard(sym);
                    State.activeSymbols.delete(sym);
                }
            }

            // 2. æ–°å¢å…¥æ¦œçš„
            for(let sym of newSet) {
                if(!State.activeSymbols.has(sym)) {
                    State.activeSymbols.add(sym);
                    createCard(sym);
                    // é€™è£¡ä¸ awaitï¼Œè®“å®ƒåœ¨èƒŒæ™¯æ’éšŠåŸ·è¡Œ
                    loadSymbolData(sym); 
                }
            }
            
            // 3. æ›´æ–° WebSocket è¨‚é–±
            updateWebSocket();

        } catch(e) {
            log("API éŒ¯èª¤: " + e.message);
        }
    }

    async function loadSymbolData(sym) {
        const card = document.getElementById(`card-${sym}`);
        if(!card) return;
        
        // åˆå§‹åŒ–æ•¸æ“šçµæ§‹
        State.data[sym] = { '15m':{}, '1h':{}, '4h':{} };

        // ä¾åºä¸‹è¼‰ä¸‰å€‹é€±æœŸçš„ K ç·š
        for(let tf of CONSTANTS.TFS) {
            try {
                updateCardStatus(sym, `ä¸‹è¼‰ ${tf}...`);
                // ä¸‹è¼‰ 200 æ ¹ K ç·šè¶³å¤ è¨ˆç®—
                const klines = await safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=200`);
                analyzeTimeframe(sym, tf, klines);
            } catch(e) {
                console.error(sym, tf, e);
            }
        }
        
        // æŠ“å–è³‡é‡‘è²»ç‡
        try {
            const funding = await safeFetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`);
            const fr = parseFloat(funding.lastFundingRate) * 100;
            const frEl = document.getElementById(`fr-${sym}`);
            if(frEl) {
                frEl.innerText = `${fr.toFixed(4)}%`;
                frEl.style.color = fr > 0.01 ? 'var(--red)' : (fr < 0 ? 'var(--green)' : '#888');
            }
        } catch(e) {}

        updateCardStatus(sym, "ç›£æ§ä¸­");
        evaluateStrategy(sym);
    }

    function analyzeTimeframe(sym, tf, klines) {
        // æ•¸æ“šè§£æ
        const c = klines.map(d=>parseFloat(d[4])); // æ”¶ç›¤åƒ¹
        const h = klines.map(d=>parseFloat(d[2]));
        const l = klines.map(d=>parseFloat(d[3]));
        const v = klines.map(d=>parseFloat(d[5])); // é‡
        const last = c.length - 1;
        const price = c[last];

        // è¨ˆç®—æŒ‡æ¨™
        const rsiVal = MathEngine.rsi(c);
        const bb = MathEngine.bollinger(c);
        const atrVal = MathEngine.atr(h,l,c);
        const ema50 = MathEngine.emaArray(c, 50)[last];
        const adxVal = MathEngine.adx(h,l,c);

        // è¶¨å‹¢åˆ¤æ–·
        let trend = 'neutral';
        if (price > ema50 && rsiVal > 50) trend = 'long';
        if (price < ema50 && rsiVal < 50) trend = 'short';

        // å„²å­˜æ•¸æ“š
        State.data[sym][tf] = {
            price, rsi: rsiVal, bb, atr: atrVal, adx: adxVal, trend, 
            vol: v[last], prevVol: v[last-1]
        };

        // UI æ›´æ–° (æŒ‡æ¨™åˆ—è¡¨)
        const listEl = document.getElementById(`ind-${sym}-${tf}`);
        if(listEl) {
            listEl.innerHTML = `
                <div class="ind-item"><span>RSI</span><span class="ind-val" style="color:${rsiVal>70?'var(--red)':rsiVal<30?'var(--green)':'#aaa'}">${rsiVal.toFixed(1)}</span></div>
                <div class="ind-item"><span>BBå¯¬</span><span class="ind-val">${(bb.width*100).toFixed(2)}%</span></div>
                <div class="ind-item"><span>ADX</span><span class="ind-val" style="color:${adxVal>25?'var(--yellow)':'#666'}">${adxVal.toFixed(1)}</span></div>
            `;
        }

        // 1H ç‰¹æ®Šè™•ç†ï¼šé‡èƒ½èˆ‡è³‡é‡‘æµ
        if (tf === '1h') {
            const volRatio = v[last] / MathEngine.sma(v, 20);
            const vTag = document.getElementById(`vol-${sym}`);
            if(vTag) {
                vTag.innerText = `Vol x${volRatio.toFixed(1)}`;
                vTag.className = `vol-tag ${volRatio>1.5 ? 'v-high' : ''}`;
            }
            // æ¨¡æ“¬è³‡é‡‘æµ (ç”¨ Taker Buy Base Asset Volume ä¼°ç®—)
            const takerBuy = parseFloat(klines[last][9]);
            const totalVol = parseFloat(klines[last][5]);
            const buyRatio = (takerBuy / totalVol) * 100;
            document.getElementById(`flow-b-${sym}`).style.width = `${buyRatio}%`;
            document.getElementById(`flow-s-${sym}`).style.width = `${100-buyRatio}%`;
        }
    }

    function evaluateStrategy(sym) {
        const d15 = State.data[sym]['15m'];
        const d1h = State.data[sym]['1h'];
        const d4h = State.data[sym]['4h'];
        
        if(!d15 || !d1h || !d4h || !d15.trend) return;

        // ç­–ç•¥é‚è¼¯
        let signal = 'wait';
        let tier = '';
        
        // Sç´š: 15m, 1h, 4h å…±æŒ¯
        if (d15.trend === d1h.trend && d1h.trend === d4h.trend && d1h.adx > 25) {
            signal = d15.trend;
            tier = 'S';
        }
        // Aç´š: 15m, 1h å…±æŒ¯ + 4h ä¸åå‘
        else if (d15.trend === d1h.trend && d4h.trend !== (d15.trend==='long'?'short':'long')) {
            signal = d15.trend;
            tier = 'A';
        }
        // Bç´š: åƒ… 15m è¶¨å‹¢ + 1H éœ‡ç›ª
        else if (d15.adx > 30) {
            signal = d15.trend;
            tier = 'B';
        }

        // æ®­å±ç›¤éæ¿¾
        if (d1h.bb.width < 0.01 || d1h.adx < 15) {
            tier = 'Z'; signal = 'wait';
        }

        renderStrategyBox(sym, signal, tier, d15);
        updateTierBadge(sym, tier);
        
        // ç™¼é€é€šçŸ¥ (é˜²æ­¢é‡è¤‡ç™¼é€éœ€åŠ é–ï¼Œæ­¤è™•ç°¡åŒ–)
        if (tier === 'S' || tier === 'A') {
            sendDiscordAlert(sym, signal, tier, d15.price);
        }
    }

    function renderStrategyBox(sym, signal, tier, data) {
        // é¡¯ç¤ºåœ¨ 15m çš„å¡ç‰‡å€åŸŸï¼Œæˆ–å…¶ä»–åˆé©ä½ç½®
        // é€™è£¡æˆ‘å€‘çµ±ä¸€æ›´æ–°æœ€ä¸‹æ–¹çš„ 15m æˆ°è¡“æ ¼
        const box = document.getElementById(`strat-${sym}`);
        const title = document.getElementById(`st-title-${sym}`);
        
        if (!box) return;

        const atr = data.atr || (data.price * 0.01);
        const sl = signal === 'long' ? data.price - (atr * 1.5) : data.price + (atr * 1.5);
        const tp1 = signal === 'long' ? data.price + (atr * 1.5) : data.price - (atr * 1.5);
        const tp2 = signal === 'long' ? data.price + (atr * 3.0) : data.price - (atr * 3.0);
        
        // Kelly ç°¡æ˜“ä¼°ç®— (åŸºæ–¼ä¿¡è™Ÿå¼·åº¦)
        let kelly = 0;
        if(tier === 'S') kelly = 15;
        else if(tier === 'A') kelly = 8;
        else if(tier === 'B') kelly = 3;

        // UI æ¸²æŸ“
        if (signal === 'long') {
            box.className = 'strat-box strat-long';
            title.innerText = `åšå¤š (Tier ${tier})`;
        } else if (signal === 'short') {
            box.className = 'strat-box strat-short';
            title.innerText = `åšç©º (Tier ${tier})`;
        } else {
            box.className = 'strat-box';
            title.innerText = 'è§€æœ›ä¸­';
            box.style.opacity = '0.5';
        }

        document.getElementById(`val-sl-${sym}`).innerText = sl.toFixed(4);
        document.getElementById(`val-tp1-${sym}`).innerText = tp1.toFixed(4);
        document.getElementById(`val-tp2-${sym}`).innerText = tp2.toFixed(4);
        document.getElementById(`val-k-${sym}`).innerText = kelly > 0 ? `${kelly}%` : '-';
    }

    // ==========================================
    // ğŸ¨ UI æ¸²æŸ“èˆ‡æ“ä½œ
    // ==========================================
    function createCard(sym) {
        const div = document.createElement('div');
        div.className = 'coin-card expanded'; // é è¨­å±•é–‹
        div.id = `card-${sym}`;
        div.innerHTML = `
            <div class="card-header" onclick="this.parentElement.classList.toggle('expanded')">
                <div class="ch-left">
                    <span class="sym-name">${sym.replace('USDT','')}</span>
                    <span class="tier-badge" id="badge-${sym}"></span>
                    <span class="sym-price" id="price-${sym}">--.--</span>
                </div>
                <div class="ch-right">
                    <div id="status-${sym}" style="font-size:10px; color:#666;">ç­‰å¾…æ•¸æ“š...</div>
                </div>
            </div>
            <div class="card-body">
                <div class="col-info">
                    <div style="font-size:10px; color:#888;">è³‡é‡‘è²»ç‡: <span id="fr-${sym}">--</span></div>
                    <div style="margin-top:5px;">
                        <span id="vol-${sym}" class="vol-tag">Vol --</span>
                    </div>
                    <div style="margin-top:auto;">
                        <div style="font-size:9px; color:#666; margin-bottom:2px;">ä¸»å‹•è²·è³£æ¯”</div>
                        <div class="flow-bar-bg">
                            <div class="flow-buy" id="flow-b-${sym}" style="width:50%"></div>
                            <div class="flow-sell" id="flow-s-${sym}" style="width:50%"></div>
                        </div>
                    </div>
                </div>
                ${CONSTANTS.TFS.map(tf => `
                    <div class="col-tf">
                        <div class="tf-header">${tf}</div>
                        <div id="ind-${sym}-${tf}" style="flex-grow:1;"></div>
                        ${tf === '15m' ? `
                            <div class="strat-box" id="strat-${sym}">
                                <div id="st-title-${sym}" style="font-weight:bold; font-size:11px; margin-bottom:2px;">åˆ†æä¸­</div>
                                <div class="strat-grid">
                                    <div class="sg-row"><span class="sg-label">SL</span><span class="sg-val" id="val-sl-${sym}">---</span></div>
                                    <div class="sg-row"><span class="sg-label">TP1</span><span class="sg-val" id="val-tp1-${sym}">---</span></div>
                                    <div class="sg-row"><span class="sg-label">TP2</span><span class="sg-val" id="val-tp2-${sym}">---</span></div>
                                    <div class="sg-row"><span class="sg-label">Kelly</span><span class="sg-val" id="val-k-${sym}">---</span></div>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('grid-container').appendChild(div);
    }

    function removeCard(sym) {
        const el = document.getElementById(`card-${sym}`);
        if(el) el.remove();
    }

    function updateCardStatus(sym, text) {
        const el = document.getElementById(`status-${sym}`);
        if(el) el.innerText = text;
    }

    function updateTierBadge(sym, tier) {
        const el = document.getElementById(`badge-${sym}`);
        if(!el) return;
        if(tier) {
            el.className = `tier-badge tier-${tier.toLowerCase()}`;
            el.innerText = `${tier}ç´š`;
            el.style.display = 'inline-block';
        } else {
            el.style.display = 'none';
        }
    }

    function log(msg) {
        const el = document.getElementById('sys-log');
        el.innerText = msg;
        setTimeout(() => el.innerText = 'ç³»çµ±å°±ç·’', 3000);
    }

    function startTimerBar(seconds) {
        const bar = document.getElementById('scan-timer');
        bar.style.width = '0%';
        bar.style.transition = 'none';
        setTimeout(() => {
            bar.style.transition = `width ${seconds}s linear`;
            bar.style.width = '100%';
        }, 100);
    }

    async function refreshIndicators() {
        log("æ›´æ–°æŒ‡æ¨™æ•¸æ“š...");
        startTimerBar(60);
        for(let sym of State.activeSymbols) {
            loadSymbolData(sym); // é€™è£¡ä¸éœ€è¦ awaitï¼Œè®“ queue è™•ç†
        }
    }

    // ==========================================
    // ğŸ“¡ WebSocket å³æ™‚åƒ¹æ ¼
    // ==========================================
    function updateWebSocket() {
        if(wss) wss.close();
        const streams = Array.from(State.activeSymbols).map(s => `${s.toLowerCase()}@ticker`).join('/');
        if(!streams) return;
        
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            const data = msg.data;
            const sym = data.s;
            const price = parseFloat(data.c);
            
            // æ›´æ–°é¡¯ç¤º
            const el = document.getElementById(`price-${sym}`);
            if(el) {
                const oldPrice = parseFloat(el.innerText);
                el.innerText = price;
                el.className = `sym-price ${price >= oldPrice ? 'up' : 'down'}`;
            }
        };
    }

    // ==========================================
    // ğŸ“¢ Discord é€šçŸ¥
    // ==========================================
    const alertHistory = new Map(); // é¿å…é€šçŸ¥åˆ·å±

    function sendDiscordAlert(sym, signal, tier, price) {
        if(!DISCORD_WEBHOOK_URL) return;
        
        const now = Date.now();
        const key = `${sym}-${tier}`;
        // åŒä¸€å¹£ç¨®åŒä¸€ç­‰ç´šï¼Œ15åˆ†é˜å…§ä¸é‡è¤‡ç™¼é€
        if(alertHistory.has(key) && (now - alertHistory.get(key) < 15 * 60 * 1000)) return;
        
        alertHistory.set(key, now);

        const color = signal === 'long' ? 5763719 : 15548997; // Green or Red
        const emoji = signal === 'long' ? 'ğŸ“ˆ' : 'ğŸ“‰';
        
        const payload = {
            username: "V56 æˆ°æƒ…å®˜",
            embeds: [{
                title: `${emoji} ${tier}ç´šè¨Šè™Ÿ: ${sym}`,
                color: color,
                fields: [
                    { name: "æ–¹å‘", value: signal.toUpperCase(), inline: true },
                    { name: "åƒ¹æ ¼", value: String(price), inline: true },
                    { name: "ç­–ç•¥", value: "è¶¨å‹¢å…±æŒ¯çªç ´", inline: false }
                ],
                footer: { text: "V56 Commander Edition" },
                timestamp: new Date().toISOString()
            }]
        };

        fetch(DISCORD_WEBHOOK_URL, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        }).catch(err => console.error("Discord Error", err));
    }

    function testDiscord() {
        if(!DISCORD_WEBHOOK_URL) { alert("è«‹å…ˆåœ¨ä»£ç¢¼ä¸­è¨­å®š Webhook URL"); return; }
        sendDiscordAlert("TEST-USDT", "long", "S", 12345.67);
        alert("æ¸¬è©¦è¨Šè™Ÿå·²ç™¼é€");
    }

    // å•Ÿå‹•ï¼
    initSystem();

</script>
</body>
</html>
