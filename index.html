<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V71 æ·±åº¦æ€è€ƒç‰ˆ)</title>
    <style>
        /* =========================================
           V71 æ¨£å¼ï¼šç¶­æŒ V70 çš„ç‹™æ“Šé¢¨æ ¼
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --red: #f6465d; --yellow: #fcd535; --gold: #ffd700; --blue: #2979ff; --purple: #bf5af2;
            --border: #2b3139;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', 'Roboto Mono', monospace; margin: 0; padding: 20px; font-size: 13px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
        .version-tag { font-size: 12px; color: var(--purple); border: 1px solid var(--purple); padding: 3px 6px; border-radius: 4px; margin-left: 10px; font-weight: bold; }
        .btc-bar { background: #1e2329; padding: 10px 20px; border-radius: 4px; border-left: 5px solid var(--purple); font-size: 14px; display: flex; gap: 25px; align-items: center; }
        
        #grid-container { display: flex; flex-direction: column; gap: 20px; max-width: 1900px; margin: 0 auto; }
        
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: border-color 0.3s; }
        .card-header { background: #1e2329; padding: 12px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sym-title { font-size: 22px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .sym-price { font-size: 20px; font-weight: bold; font-family: 'Roboto Mono'; }
        
        .tier-badge { padding: 4px 12px; border-radius: 4px; font-weight: 900; font-size: 14px; display: none; text-transform: uppercase; letter-spacing: 1px; }
        .tier-s { background: rgba(14, 203, 129, 0.2); color: var(--green); border: 1px solid var(--green); box-shadow: 0 0 15px rgba(14, 203, 129, 0.2); animation: pulse 1s infinite; }
        .tier-a { background: rgba(252, 213, 53, 0.15); color: var(--yellow); border: 1px solid var(--yellow); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .card-body { display: grid; grid-template-columns: 280px 1fr 1fr 1fr; gap: 2px; background: var(--border); }
        .col-section { background: var(--card); padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        .info-group { margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 10px; }
        .info-label { color: #888; font-size: 11px; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .vol-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 11px; }
        .v-high { background: var(--green); color: #000; } .v-norm { background: #444; color: #ccc; } .v-low { background: #331111; color: #888; }
        
        .ai-action-area { margin-top: auto; min-height: 80px; display: flex; flex-direction: column; justify-content: flex-end; }
        .ai-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; margin-top: 10px; transition: all 0.2s; display: none; text-align: center; }
        .ai-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-s { background: linear-gradient(45deg, #0ecb81, #004d40); color: #fff; border: 1px solid #0ecb81; box-shadow: 0 0 10px rgba(14, 203, 129, 0.4); }
        .btn-a { background: linear-gradient(45deg, #fcd535, #5f4c00); color: #000; border: 1px solid #fcd535; }

        .ai-result { background: rgba(40, 30, 60, 0.6); border: 1px solid var(--purple); border-radius: 6px; padding: 10px; margin-top: 10px; display: none; }
        .ai-title { color: var(--purple); font-weight: bold; font-size: 11px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .ai-content { color: #eee; font-size: 12px; line-height: 1.4; white-space: pre-wrap; }

        .sect-title { font-size: 14px; font-weight: bold; color: #fff; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 8px; text-align: center; background: #1a1e23; border-radius: 4px; }
        .wr-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; display: flex; }
        .wr-l { background: var(--green); height: 100%; } .wr-s { background: var(--red); height: 100%; }
        .ind-row { display: flex; justify-content: space-between; font-size: 12px; padding: 3px 5px; background: rgba(255,255,255,0.02); border-radius: 3px; }
        .ind-name { color: #888; } .ind-val { font-family: 'Roboto Mono'; font-weight: bold; }
        
        .strat-box { margin-top: auto; background: #111; border: 1px solid #444; border-radius: 6px; padding: 8px; }
        .strat-long { background: rgba(14, 203, 129, 0.1); border-color: var(--green); }
        .strat-short { background: rgba(246, 70, 93, 0.1); border-color: var(--red); }
        .strat-status { text-align: center; font-weight: bold; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #444; font-size: 13px; }
        .six-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-size: 11px; }
        .sg-cell { display: flex; justify-content: space-between; }
        .sg-label { color: #666; } .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; } .sg-profit { color: var(--gold); }

        @media (max-width: 1200px) { .card-body { grid-template-columns: 1fr; } .col-section { border-bottom: 1px solid var(--border); } }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center;">
        <h1>å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span class="version-tag">V71 æ·±åº¦æ€è€ƒç‰ˆ</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC: <strong id="btc-price" style="color:#fff;">...</strong></span>
        <span>ç‹€æ…‹: <strong id="sys-status" style="color:var(--green);">å¾…å‘½</strong></span>
        <button onclick="testDiscord()" style="background:#5865F2; color:#fff; border:none; padding:5px 15px; cursor:pointer; border-radius:4px;">æ¸¬è©¦ Discord</button>
    </div>
</div>

<div id="grid-container"></div>

<script>
    // ==========================================
    // âš™ï¸ ç”¨æˆ¶è¨­å®š
    // ==========================================
    const CONFIG = {
        DISCORD_WEBHOOK: "", 
        GEMINI_API_KEY: "",       
        KLINES_LIMIT: 500,
        BLACKLIST: ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'DAIUSDT', 'BUSDUSDT', 'EURUSDT']
    };

    // ==========================================
    // ğŸ“¡ Discord Bot
    // ==========================================
    const DISCORD_BOT = {
        history: new Map(), 

        checkAndSend: function(symbol, tier, direction, strategyData) {
            // Sç´šè‡ªå‹•ç™¼é€
            if (tier !== 'S') return;

            const now = new Date();
            const minutes = now.getMinutes();
            // ç‹™æ“Šç‰ˆï¼šæ”¾å¯¬æ™‚é–“çª—ï¼Œå‰5åˆ†é˜éƒ½ç™¼
            const isWindow = (minutes % 15) < 5; 
            
            if (!isWindow) return;

            const blockID = Math.floor(now.getTime() / (15 * 60 * 1000));
            const key = `${symbol}-${blockID}`;

            if (this.history.has(key)) return;
            this.history.set(key, true);
            
            // è‡ªå‹•ç™¼é€ä¸å« AI å…§å®¹ï¼Œåªç™¼ç¡¬æ•¸æ“š
            this.sendWebhook(symbol, tier, direction, strategyData, null);
        },

        sendWebhook: async function(symbol, tier, dir, data, aiContent) {
            if (!CONFIG.DISCORD_WEBHOOK || CONFIG.DISCORD_WEBHOOK.includes("YOUR")) return;

            const isLong = dir === 'long';
            const color = isLong ? 969601 : 16139869; 
            const emoji = tier === 'S' ? 'ğŸ”¥' : 'âš ï¸';
            const title = aiContent ? `ğŸ¤– AI æ·±åº¦åˆ†æ: ${symbol}` : `${emoji} ${symbol} [${tier}ç´šç‹™æ“Šè¨Šè™Ÿ]`;

            let desc = "";
            if (aiContent) {
                // V71: AI å…§å®¹æœƒæ¯”è¼ƒé•·ï¼Œç›´æ¥æ”¾é€²å»
                desc = `${aiContent}\n\n`;
            }

            if (data.biasWarn) {
                desc += `ğŸš¨ **è­¦å‘Šï¼šä¹–é›¢ç‡éå¤§ï¼Œå»ºè­°ç­‰å¾…å›èª¿**\nå»ºè­°æ›å–®åƒ¹ï¼š${data.safeEntry}\n\n`;
            }

            const payload = {
                content: aiContent ? "ğŸ¤– AI æ·±åº¦å ±å‘Šå·²ç”Ÿæˆ" : " Sç´šè¨Šè™Ÿè§¸ç™¼!", 
                username: "V71 æˆ°ç•¥å®˜",
                avatar_url: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png",
                embeds: [{
                    title: title,
                    description: desc,
                    color: color,
                    fields: [
                        { name: "æ–¹å‘", value: isLong ? "ğŸ“ˆ åšå¤š" : "ğŸ“‰ åšç©º", inline: true },
                        { name: "ç¾åƒ¹", value: `**${data.price}**`, inline: true },
                        { name: "å»ºè­°é€²å ´", value: `\`${data.entry}\``, inline: true },
                        { name: "åœæ (SL)", value: `\`${data.sl}\``, inline: true },
                        { name: "ç›®æ¨™ (TP)", value: `\`${data.tp2}\``, inline: true },
                        { name: "æ•¸æ“š", value: `ADX: ${data.adx} | Vol: x${data.vol}`, inline: true }
                    ],
                    footer: { text: "V71 Deep Analysis" },
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                await fetch(CONFIG.DISCORD_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            } catch (e) { console.error("DC Error", e); }
        }
    };

    // ==========================================
    // ğŸ§  AI Agent (V71 æ·±åº¦æ€è€ƒæ¨¡å¼)
    // ==========================================
    const AI_AGENT = {
        renderButton: function(symbol, tier, direction, fullData) {
            const container = document.getElementById(`ai-action-${symbol}`);
            if (!container) return;
            container.innerHTML = ''; 
            if (tier !== 'S' && tier !== 'A') return;

            const btn = document.createElement('button');
            const isS = tier === 'S';
            btn.className = `ai-btn ${isS ? 'btn-s' : 'btn-a'}`;
            btn.innerHTML = isS ? `ğŸš€ AI æ·±åº¦åˆ†æ (Sç´š)` : `âš ï¸ AI é¢¨éšªè©•ä¼° (Aç´š)`;
            btn.style.display = 'block';

            btn.onclick = () => { this.askGemini(btn, symbol, tier, direction, fullData); };
            container.appendChild(btn);
            
            const resBox = document.createElement('div');
            resBox.id = `ai-res-${symbol}`;
            resBox.className = 'ai-result';
            resBox.innerHTML = `<div class="ai-title"><span>ğŸ¤– Gemini æ·±åº¦å ±å‘Š</span></div><div class="ai-content"></div>`;
            container.appendChild(resBox);
        },

        askGemini: async function(btn, symbol, tier, dir, fullData) {
            if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY.includes("YOUR")) { alert("API Key Missing"); return; }

            btn.disabled = true;
            btn.innerHTML = "â³ AI æ­£åœ¨è¾¯è­‰å„ªç¼ºé»...";
            const resBox = document.getElementById(`ai-res-${symbol}`);
            resBox.style.display = 'block';
            const content = resBox.querySelector('.ai-content');
            content.innerText = "æ’°å¯«å ±å‘Šä¸­...";

            const strat = fullData.strategy;
            const d15 = fullData['15m'];
            const d1h = fullData['1h'];
            const d4h = fullData['4h'];

            // ğŸ”¥ V71 æ·±åº¦ Promptï¼šè¦æ±‚åˆ—å‡ºå„ªç¼ºé»
            const prompt = `
            ä½ æ˜¯é ‚ç´šåŠ å¯†è²¨å¹£åˆ†æå¸«ã€‚è«‹å° ${symbol} çš„ ${dir === 'long' ? 'åšå¤š' : 'åšç©º'} äº¤æ˜“æ©Ÿæœƒé€²è¡Œã€Œæ·±åº¦è¾¯è­‰åˆ†æã€ã€‚
            ç›®å‰è¨Šè™Ÿè©•ç´šï¼š${tier}ã€‚
            
            ã€å¸‚å ´çµæ§‹ã€‘
            - 15m (åŸ·è¡Œ): RSI=${d15.rsi}, è¶¨å‹¢=${d15.emaState}, ADX=${d15.adx}, é‡èƒ½=${d15.vol}å€
            - 1H  (æˆ°è¡“): RSI=${d1h.rsi}, è¶¨å‹¢=${d1h.emaState}, ADX=${d1h.adx}, é‡èƒ½=${d1h.vol}å€
            - 4H  (æˆ°ç•¥): RSI=${d4h.rsi}, è¶¨å‹¢=${d4h.emaState}, ADX=${d4h.adx}, é‡èƒ½=${d4h.vol}å€
            
            ã€äº¤æ˜“è¨ˆç•«ã€‘
            - ç¾åƒ¹: ${strat.price}
            - å»ºè­°é€²å ´: ${strat.entry}
            - ç›®æ¨™: ${strat.tp1}
            - æ­¢æ: ${strat.sl}
            
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œä¾ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š
            
            1. **âœ… å¤šé ­/ç©ºé ­ å„ªå‹¢ (Pros)**ï¼šåˆ—å‡º 2-3 é»æ”¯æŒé€²å ´çš„æŠ€è¡“ç†ç”± (å¦‚æŒ‡æ¨™å…±æŒ¯ã€é‡èƒ½é…åˆã€è¶¨å‹¢æ–¹å‘)ã€‚
            2. **âŒ æ½›åœ¨é¢¨éšª (Cons)**ï¼šåˆ—å‡º 2-3 é»å¯èƒ½å¤±æ•—çš„éš±æ†‚ (å¦‚ä¹–é›¢ç‡ã€å¤§é€±æœŸé€†å‹¢ã€å‹•èƒ½ä¸è¶³ã€ä¸Šæ–¹å£“åŠ›)ã€‚
            3. **âš–ï¸ æœ€çµ‚è£æ±º**ï¼š
               - ä¿¡å¿ƒåˆ†æ•¸ (0-100)
               - æˆ°è¡“å»ºè­° (50å­—å…§)ï¼šæ‡‰è©²ç›´æ¥å¸‚åƒ¹é€²å ´ï¼Ÿé‚„æ˜¯æ›å–®å›èª¿ï¼Ÿé‚„æ˜¯æ”¾æ£„ï¼Ÿ
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-pro-preview:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const json = await response.json();
                const text = json.candidates[0].content.parts[0].text.trim();
                
                content.innerText = text;
                btn.innerHTML = "âœ… å ±å‘Šå·²ç”Ÿæˆ";
                DISCORD_BOT.sendWebhook(symbol, tier, dir, strat, text);

            } catch (e) {
                content.innerText = "AI Error: " + e.message;
                btn.innerHTML = "âŒ å¤±æ•—";
                btn.disabled = false;
            }
        }
    };

    // ==========================================
    // ğŸ§® æ•¸å­¸å¼•æ“
    // ==========================================
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        ema: (d, p) => { let k=2/(p+1), e=[d[0]]; for(let i=1;i<d.length;i++) e.push(d[i]*k+e[i-1]*(1-k)); return e; },
        rsi: (c, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1;i<=p;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/p, al=l/p; rsi[p]=100-(100/(1+ag/al));
            for(let i=p+1;i<c.length;i++){ 
                let d=c[i]-c[i-1]; let u=d>0?d:0; let dw=d<0?Math.abs(d):0;
                ag=(ag*(p-1)+u)/p; al=(al*(p-1)+dw)/p; 
                rsi[i]=al===0?100:100-(100/(1+ag/al)); 
            }
            return rsi;
        },
        bollinger: (c, p=20, m=2) => {
            const sma = c.slice(-p).reduce((a,b)=>a+b,0)/p;
            const sq = c.slice(-p).map(x=>Math.pow(x-sma,2)).reduce((a,b)=>a+b,0)/p;
            const std = Math.sqrt(sq);
            return { width: ((sma+m*std)-(sma-m*std))/sma };
        },
        macd: (c) => {
            const e12 = MathEngine.ema(c, 12);
            const e26 = MathEngine.ema(c, 26);
            return e12[e12.length-1] - e26[e26.length-1];
        },
        atr: (h, l, c, p=14) => {
            let trs = [h[0]-l[0]];
            for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
        },
        adx: (h, l, c, p=14) => {
            const tr = MathEngine.atr(h,l,c,p);
            const move = Math.abs(c[c.length-1] - c[c.length-p]);
            let strength = (move / (tr * p)) * 100 * 2.5; 
            return Math.min(100, strength);
        }
    };

    // ==========================================
    // ğŸš€ ä¸»æµç¨‹
    // ==========================================
    let activeSymbols = new Set();

    async function initSystem() {
        console.log("V71 å•Ÿå‹•...");
        await updateBTC();
        await scanMarket();
        setInterval(scanMarket, 60 * 1000);
    }

    async function updateBTC() {
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCUSDT');
            const d = await r.json();
            document.getElementById('btc-price').innerText = parseFloat(d.price).toFixed(2);
        } catch(e){}
    }

    async function scanMarket() {
        document.getElementById('sys-status').innerText = "æƒæä¸­...";
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const d = await r.json();
            let pairs = d.filter(t => t.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(t.symbol));
            pairs.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
            const top10 = pairs.slice(0, 10).map(t => t.symbol);

            const newSet = new Set(top10);
            for(let s of activeSymbols) if(!newSet.has(s)) document.getElementById(`card-${s}`)?.remove();
            for(let s of newSet) if(!activeSymbols.has(s)) createCard(s);
            activeSymbols = newSet;

            document.getElementById('sys-status').innerText = "åˆ†æä¸­...";
            const tasks = Array.from(activeSymbols).map(s => analyze(s));
            await Promise.all(tasks);
            
            connectWSS(Array.from(activeSymbols));
            document.getElementById('sys-status').innerText = "ç›£æ§ä¸­";
        } catch(e) { console.error(e); document.getElementById('sys-status').innerText = "API ç•°å¸¸"; }
    }

    async function analyze(symbol) {
        const tfs = ['15m', '1h', '4h'];
        const reqs = tfs.map(tf => fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${CONFIG.KLINES_LIMIT}`).then(r=>r.json()).then(k=>({tf, k})));
        
        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`).then(r=>r.json()).then(d=>{
            const fr = parseFloat(d.lastFundingRate)*100;
            const el = document.getElementById(`fr-${symbol}`);
            if(el) { el.innerText = `${fr.toFixed(4)}%`; el.style.color = fr>0.01?'var(--red)':'var(--green)'; }
        });

        const res = await Promise.all(reqs);
        let fullData = { strategy: null, '15m': {}, '1h': {}, '4h': {} };

        res.forEach(({tf, k}) => {
            const d = processData(symbol, tf, k);
            
            fullData[tf] = {
                rsi: d.rsi.toFixed(1),
                emaState: d.price > d.ema ? "Bullish" : "Bearish",
                vol: d.volRatio ? d.volRatio.toFixed(1) : "N/A",
                adx: d.adx.toFixed(1)
            };

            if(tf === '1h') { 
                fullData.strategy = { ...d.stratInfo, adx: d.adx.toFixed(1), vol: d.volRatio.toFixed(1) };
            }
        });

        const tierInfo = checkTier(symbol);
        DISCORD_BOT.checkAndSend(symbol, tierInfo.tier, tierInfo.dir, fullData.strategy);
        AI_AGENT.renderButton(symbol, tierInfo.tier, tierInfo.dir, fullData);
    }

    function processData(sym, tf, k) {
        const c = k.map(d=>parseFloat(d[4])), h=k.map(d=>parseFloat(d[2])), l=k.map(d=>parseFloat(d[3])), v=k.map(d=>parseFloat(d[5]));
        const last = c.length-1, price = c[last];

        const rsiArr = MathEngine.rsi(c); const rsi = rsiArr[last];
        const emaArr = MathEngine.ema(c, 50); const ema = emaArr[last];
        const bb = MathEngine.bollinger(c);
        const macd = MathEngine.macd(c);
        const vwapArr = MathEngine.ema(c, 90); const vwap = vwapArr[last];
        const atr = MathEngine.atr(h,l,c);
        const adx = MathEngine.adx(h,l,c);

        updateInd(sym, tf, 'RSI', rsi.toFixed(1), rsi>55?'long':rsi<45?'short':'n');
        updateInd(sym, tf, 'EMA(50)', price>ema?'ä¹‹ä¸Š':'ä¹‹ä¸‹', price>ema?'long':'short');
        updateInd(sym, tf, 'BBå¯¬', (bb.width*100).toFixed(1)+'%', 'n');
        updateInd(sym, tf, 'MACD', macd.toFixed(2), macd>0?'long':'short');
        updateInd(sym, tf, 'VWAP', price>vwap?'ä¹‹ä¸Š':'ä¹‹ä¸‹', price>vwap?'long':'short');
        
        const adxEl = document.getElementById(`adx-${sym}-${tf}`);
        if(adxEl) { adxEl.innerText = adx.toFixed(1); adxEl.style.color = adx>25?'var(--yellow)':'#666'; }

        let wL = 30; if(rsi<40) wL+=20; if(price>ema) wL+=20; if(macd>0) wL+=10; if(adx>25) wL+=10;
        let wS = 30; if(rsi>60) wS+=20; if(price<ema) wS+=20; if(macd<0) wS+=10; if(adx>25) wS+=10;
        document.getElementById(`wr-l-${sym}-${tf}`).style.width = `${Math.min(90, wL)}%`;
        document.getElementById(`wr-s-${sym}-${tf}`).style.width = `${Math.min(90, wS)}%`;

        const stratInfo = updateBox(sym, tf, price, atr, rsi, ema, adx);

        let volRatio = 1;
        if(tf==='1h') {
            const smaV = MathEngine.sma(v, 20);
            volRatio = v[last]/smaV;
            document.getElementById(`vol-val-${sym}`).innerText = `x${volRatio.toFixed(1)}`;
            const vTag = document.getElementById(`vol-tag-${sym}`);
            if(volRatio > 1.0) { vTag.innerText="æ”¾é‡"; vTag.className="vol-tag v-high"; }
            else { vTag.innerText="ç¸®é‡"; vTag.className="vol-tag v-low"; }
            
            saveStat(sym, tf, 'vol', volRatio); 
        }

        let dir = 'wait';
        if(rsi > 55 && price > ema) dir = 'long';
        else if(rsi < 45 && price < ema) dir = 'short';
        
        saveStat(sym, tf, 'dir', dir);
        saveStat(sym, tf, 'adx', adx);

        return { rsi, adx, volRatio, price, ema, stratInfo };
    }

    function saveStat(sym, tf, key, val) {
        const card = document.getElementById(`card-${sym}`);
        let s = JSON.parse(card.dataset.stats || "{}");
        if(!s[tf]) s[tf] = {};
        s[tf][key] = val;
        card.dataset.stats = JSON.stringify(s);
    }

    function updateInd(sym, tf, name, val, st) {
        const id = `ind-${sym}-${tf}-${name.replace(/[^a-zA-Z0-9]/g,'')}`;
        const el = document.getElementById(id);
        if(el) {
            el.innerText = val;
            if(st==='long') el.style.color = 'var(--green)';
            else if(st==='short') el.style.color = 'var(--red)';
            else el.style.color = '#ccc';
        }
    }

    function updateBox(sym, tf, p, atr, rsi, ema, adx) {
        const box = document.getElementById(`sb-${sym}-${tf}`);
        let dir = 'wait';
        if(rsi>55 && p>ema && adx>25) dir = 'long';
        else if(rsi<45 && p<ema && adx>25) dir = 'short';

        const fmt = v => v.toFixed(p<10?4:2);
        const title = box.querySelector('.strat-status');
        
        const bias = Math.abs(p - ema) / ema * 100;
        const biasWarn = bias > 2.0; 

        let info = { 
            entry: fmt(p), 
            safeEntry: fmt(ema), 
            sl: '-', tp1: '-', tp2: '-', price: fmt(p), biasWarn: biasWarn 
        };

        if(dir==='long') {
            box.className = 'strat-box strat-long';
            title.innerText = "åšå¤š (LONG)";
            info.sl = fmt(p - atr*1.5);
            info.tp1 = fmt(p + atr*1.5);
            info.tp2 = fmt(p + atr*3.0);
        } else if(dir==='short') {
            box.className = 'strat-box strat-short';
            title.innerText = "åšç©º (SHORT)";
            info.sl = fmt(p + atr*1.5);
            info.tp1 = fmt(p - atr*1.5);
            info.tp2 = fmt(p - atr*3.0);
        } else {
            box.className = 'strat-box';
            title.innerText = "è§€æœ›";
        }

        if (biasWarn && dir !== 'wait') {
            document.getElementById(`en-${sym}-${tf}`).innerText = `âš ï¸ ${info.entry}`;
            document.getElementById(`en-${sym}-${tf}`).style.color = 'var(--yellow)';
        } else {
            document.getElementById(`en-${sym}-${tf}`).innerText = info.entry;
            document.getElementById(`en-${sym}-${tf}`).style.color = 'var(--text-main)';
        }

        document.getElementById(`sl-${sym}-${tf}`).innerText = info.sl;
        document.getElementById(`tp1-${sym}-${tf}`).innerText = info.tp1;
        document.getElementById(`tp2-${sym}-${tf}`).innerText = info.tp2;

        return info;
    }

    function checkTier(sym) {
        const card = document.getElementById(`card-${sym}`);
        const s = JSON.parse(card.dataset.stats || "{}");
        if(!s['15m'] || !s['1h'] || !s['4h']) return {tier:null};

        const d15 = s['15m'].dir;
        const d1h = s['1h'].dir;
        const d4h = s['4h'].dir;
        const adx1h = s['1h'].adx || 0;
        const vol1h = s['1h'].vol || 0;

        let tier = null;
        
        // V70/V71 ç‹™æ“Šé‚è¼¯ (15m/1Hå…±æŒ¯ + ADX>20 + æœ‰é‡)
        const resonance = (d15!=='wait' && d15===d1h);
        const noConflict = (d4h === 'wait' || d4h === d15); 
        const strongTrend = adx1h > 20; 
        const hasVol = vol1h > 1.0;

        if(resonance && noConflict) {
            if(strongTrend && hasVol) tier = 'S'; 
            else tier = 'A';
        } else if (d15!=='wait') {
            tier = 'B';
        }

        const b = document.getElementById(`tier-${sym}`);
        if(tier) {
            b.innerText = `${tier}ç´š`;
            b.className = `tier-badge tier-${tier.toLowerCase()}`;
            b.style.display = 'inline-block';
        } else {
            b.style.display = 'none';
        }

        if (tier === 'S' || tier === 'A') {
            if (d15 === 'long') {
                card.style.border = "2px solid var(--green)";
                card.style.boxShadow = "0 0 15px rgba(14, 203, 129, 0.2)";
            } else if (d15 === 'short') {
                card.style.border = "2px solid var(--red)";
                card.style.boxShadow = "0 0 15px rgba(246, 70, 93, 0.2)";
            }
        } else {
            card.style.border = "1px solid var(--border)";
            card.style.boxShadow = "none";
        }

        return { tier, dir: d15 };
    }

    function createCard(sym) {
        const div = document.createElement('div');
        div.className = 'coin-card';
        div.id = `card-${sym}`;
        div.innerHTML = `
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="sym-title">${sym.replace('USDT','')}</span>
                    <span class="tier-badge" id="tier-${sym}"></span>
                </div>
                <div class="sym-price" id="price-${sym}">--.--</div>
            </div>
            <div class="card-body">
                <div class="col-section">
                    <div class="info-group">
                        <div class="info-label"><span>é‡èƒ½ (1H)</span><span>>1.0</span></div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="vol-val-${sym}" style="color:#fff; font-family:'Roboto Mono'; font-weight:bold;">x--</span>
                            <span id="vol-tag-${sym}" class="vol-tag v-norm">...</span>
                        </div>
                    </div>
                    <div class="info-group">
                        <div class="info-label">è³‡é‡‘è²»ç‡</div>
                        <div id="fr-${sym}" style="font-family:'Roboto Mono'; font-weight:bold;">--%</div>
                    </div>
                    <div class="ai-action-area" id="ai-action-${sym}"></div>
                </div>
                ${['15m','1h','4h'].map(tf => `
                    <div class="col-section">
                        <div class="sect-title">${tf}</div>
                        <div class="wr-bar-bg"><div class="wr-l" id="wr-l-${sym}-${tf}" style="width:50%"></div><div class="wr-s" id="wr-s-${sym}-${tf}" style="width:50%"></div></div>
                        <div style="display:flex; flex-direction:column; gap:2px; margin-top:8px;">
                            ${genInd(sym, tf, 'RSI')}
                            ${genInd(sym, tf, 'EMA(50)')}
                            ${genInd(sym, tf, 'BBå¯¬')}
                            ${genInd(sym, tf, 'MACD')}
                            ${genInd(sym, tf, 'VWAP')}
                            <div class="ind-row" style="border-top:1px dashed #444; margin-top:4px; padding-top:4px;">
                                <span class="ind-name">ADX</span><span class="ind-val" id="adx-${sym}-${tf}">--</span>
                            </div>
                        </div>
                        <div class="strat-box" id="sb-${sym}-${tf}">
                            <div class="strat-status">è§€æœ›</div>
                            <div class="six-grid">
                                <div class="sg-cell"><span class="sg-label">En</span><span class="sg-val" id="en-${sym}-${tf}">-</span></div>
                                <div class="sg-cell"><span class="sg-label">SL</span><span class="sg-val" id="sl-${sym}-${tf}" style="color:var(--blue);">-</span></div>
                                <div class="sg-cell"><span class="sg-label">TP1</span><span class="sg-val" id="tp1-${sym}-${tf}">-</span></div>
                                <div class="sg-cell"><span class="sg-label">TP2</span><span class="sg-val" id="tp2-${sym}-${tf}">-</span></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('grid-container').appendChild(div);
    }

    function genInd(s, t, n) {
        return `<div class="ind-row"><span class="ind-name">${n}</span><span class="ind-val" id="ind-${s}-${t}-${n.replace(/[^a-zA-Z0-9]/g,'')}">--</span></div>`;
    }

    let wss = null;
    function connectWSS(s) {
        if(wss) wss.close();
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${s.map(x=>`${x.toLowerCase()}@ticker`).join('/')}`);
        wss.onmessage = e => {
            const d = JSON.parse(e.data).data;
            const el = document.getElementById(`price-${d.s}`);
            if(el) { el.innerText = parseFloat(d.c); el.className = `sym-price ${parseFloat(d.P)>=0?'up':'down'}`; }
        };
    }

    function testDiscord() {
        if(CONFIG.DISCORD_WEBHOOK.includes("YOUR")) { alert("è«‹å…ˆå¡«å¯« Webhook!"); return; }
        // æ¸¬è©¦å–®ï¼šç™¼é€ä¸€å€‹å‡ S ç´šè¨Šè™Ÿ
        DISCORD_BOT.sendWebhook('TEST-USDT', 'S', 'long', {entry:100, sl:95, tp1:105, tp2:110, adx:30, vol:1.5, price: 100}, null);
        alert("å·²ç™¼é€æ¸¬è©¦è¨Šè™Ÿè‡³ Discord");
    }
    function forceRefresh(){ scanMarket(); }

    initSystem();
</script>
</body>
</html>
