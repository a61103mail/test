<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V85 Ultimate)</title>
    <style>
        /* =========================================
           V85 UI Styleï¼š100% é‚„åŸï¼Œæœªåšä»»ä½•åˆªæ¸›
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --red: #f6465d; --yellow: #fcd535; --gold: #ffd700; --blue: #2979ff; --purple: #bf5af2;
            --border: #2b3139;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', 'Roboto Mono', monospace; margin: 0; padding: 20px; font-size: 13px; }
        
        /* WSS é–ƒçˆå‹•ç•« */
        @keyframes flash-green { 0% { background-color: rgba(14, 203, 129, 0.3); } 100% { background-color: transparent; } }
        @keyframes flash-red { 0% { background-color: rgba(246, 70, 93, 0.3); } 100% { background-color: transparent; } }
        .flash-up { animation: flash-green 0.5s ease-out; }
        .flash-down { animation: flash-red 0.5s ease-out; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
        .version-tag { font-size: 12px; color: var(--gold); border: 1px solid var(--gold); padding: 3px 6px; border-radius: 4px; margin-left: 10px; font-weight: bold; }
        .btc-bar { background: #1e2329; padding: 10px 20px; border-radius: 4px; border-left: 5px solid var(--gold); font-size: 14px; display: flex; gap: 25px; align-items: center; }
        .live-dot { height: 8px; width: 8px; background-color: var(--red); border-radius: 50%; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px var(--red); }
        .live-active { background-color: var(--green); box-shadow: 0 0 10px var(--green); }
        
        #grid-container { display: flex; flex-direction: column; gap: 20px; max-width: 1900px; margin: 0 auto; }
        
        /* å¡ç‰‡çµæ§‹ */
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: border-color 0.3s; }
        .card-header { background: #1e2329; padding: 12px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sym-title { font-size: 22px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .sym-price { font-size: 20px; font-weight: bold; font-family: 'Roboto Mono'; transition: color 0.2s; }
        
        .tier-badge { padding: 4px 12px; border-radius: 4px; font-weight: 900; font-size: 14px; display: inline-block; text-transform: uppercase; letter-spacing: 1px; }
        .tier-s { background: rgba(14, 203, 129, 0.2); color: var(--green); border: 1px solid var(--green); box-shadow: 0 0 15px rgba(14, 203, 129, 0.2); animation: pulse 1s infinite; }
        .tier-a { background: rgba(252, 213, 53, 0.15); color: var(--yellow); border: 1px solid var(--yellow); }
        .tier-b { background: #333; color: #aaa; border: 1px solid #555; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        /* ä¸‰æ¬„ä½ˆå±€ */
        .card-body { display: grid; grid-template-columns: 320px 1fr 1fr 1fr; gap: 2px; background: var(--border); }
        .col-section { background: var(--card); padding: 15px; display: flex; flex-direction: column; gap: 8px; }

        /* è©•åˆ†èˆ‡æ•¸æ“š */
        .score-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #333; }
        .score-title { font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content:space-between; }
        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #aaa; }
        .score-item span:last-child { float: right; font-weight: bold; }
        
        /* é¡å¤–è³‡è¨Šå€ */
        .info-group { background: rgba(41, 121, 255, 0.05); border: 1px solid #333; border-radius: 4px; padding: 8px; margin-bottom: 10px; }
        .info-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 4px; }

        .ai-action-area { margin-top: auto; min-height: 80px; display: flex; flex-direction: column; justify-content: flex-end; }
        .ai-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; margin-top: 10px; transition: all 0.2s; display: none; text-align: center; }
        .btn-s { background: linear-gradient(45deg, #0ecb81, #004d40); color: #fff; border: 1px solid #0ecb81; }
        .btn-a { background: linear-gradient(45deg, #fcd535, #5f4c00); color: #000; border: 1px solid #fcd535; }
        .ai-result { background: rgba(40, 30, 60, 0.6); border: 1px solid var(--purple); border-radius: 6px; padding: 10px; margin-top: 10px; display: none; }
        
        /* æ¨™é¡Œèˆ‡é€²åº¦æ¢ */
        .sect-title { font-size: 14px; font-weight: bold; color: #fff; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 8px; text-align: center; background: #1a1e23; border-radius: 4px; }
        .wr-bar-bg { height:4px; background:#333; display:flex; border-radius:2px; margin-bottom:8px; overflow:hidden; }
        .wr-l { background:var(--green); height:100%; }
        .wr-s { background:var(--red); height:100%; }

        /* äº”å¤§æŒ‡æ¨™è¡Œ */
        .ind-row { display: flex; justify-content: space-between; font-size: 12px; padding: 4px 6px; background: rgba(255,255,255,0.02); border-radius: 3px; margin-bottom: 2px; }
        .ind-name { color: #888; } .ind-val { font-family: 'Roboto Mono'; font-weight: bold; }

        /* ç­–ç•¥æ¡† */
        .strat-box { margin-top: auto; background: #111; border: 1px solid #444; border-radius: 6px; padding: 8px; }
        .strat-long { background: rgba(14, 203, 129, 0.1); border-color: var(--green); }
        .strat-short { background: rgba(246, 70, 93, 0.1); border-color: var(--red); }
        .strat-status { text-align: center; font-weight: bold; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #444; font-size: 13px; }
        
        /* å››å®®æ ¼ */
        .four-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-size: 11px; }
        .sg-cell { display: flex; justify-content: space-between; }
        .sg-label { color: #666; } .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; }

        .z-tag { font-size:10px; padding:2px 4px; border-radius:3px; background:#333; margin-left:5px; }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center;">
        <h1>å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span class="version-tag">V85 Ultimate</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC: <strong id="btc-price" style="color:#fff;">...</strong></span>
        <span>é«”åˆ¶: <strong id="btc-regime">åµæ¸¬ä¸­</strong></span>
        <div style="display:flex; align-items:center;">
            <div id="wss-dot" class="live-dot"></div>
            <span style="font-size:11px; color:#aaa; margin-left:5px;">LIVE FEED</span>
        </div>
        <button onclick="System.init()" style="background:#2979ff; color:#fff; border:none; padding:5px 15px; cursor:pointer; border-radius:4px; margin-left:20px;">ğŸ”„ å¼·åˆ¶é‡ç½®</button>
    </div>
</div>

<div id="grid-container"></div>

<script>
    const CONFIG = {
        GEMINI_API_KEY: "", // åœ¨æ­¤å¡«å…¥æ‚¨çš„ API KEY
        DISCORD_WEBHOOK: "YOUR_DISCORD_WEBHOOK_URL",
        KLINES_LIMIT: 100,
        BLACKLIST: ['USDCUSDT', 'FDUSDUSDT', 'TUSDUSDT', 'USDPUSDT', 'BUSDUSDT', 'USDTUSDT']
    };

    // ==========================================
    // ğŸ§® æ•¸å­¸æ ¸å¿ƒ (Math Core - V85 Corrected)
    // ==========================================
    const MathCore = {
        mean: d => d.reduce((a,b)=>a+b,0)/d.length,
        stdDev: (d,m) => Math.sqrt(d.reduce((a,b)=>a+Math.pow(b-m,2),0)/d.length),
        zScore: (p,h) => { const m=MathCore.mean(h); const s=MathCore.stdDev(h,m); return s===0?0:(p-m)/s; },
        
        // [ä¿®æ­£] å°æ•¸æ”¶ç›Šç‡è¨ˆç®— (Log Returns for Beta)
        getLogReturns: (data) => {
            let returns = [];
            for(let i=1; i<data.length; i++) {
                returns.push(Math.log(data[i] / data[i-1]));
            }
            return returns;
        },

        // [ä¿®æ­£] ç›¸é—œæ€§è¨ˆç®— (Pearson Correlation)
        correlation: (A,B) => {
            if(A.length !== B.length || A.length === 0) return 0;
            let num=0, dA=0, dB=0; const mA=MathCore.mean(A), mB=MathCore.mean(B);
            for(let i=0;i<A.length;i++){ num+=(A[i]-mA)*(B[i]-mB); dA+=Math.pow(A[i]-mA,2); dB+=Math.pow(B[i]-mB,2); }
            const res = num/Math.sqrt(dA*dB);
            return isNaN(res) ? 0 : res;
        },

        ema: (d,p) => { let k=2/(p+1), e=[d[0]]; for(let i=1;i<d.length;i++) e.push(d[i]*k+e[i-1]*(1-k)); return e; },
        
        rsi: (c,p=14) => {
            if(c.length < p+1) return 50;
            let gains=0, losses=0;
            for(let i=c.length-p; i<c.length; i++){ let d=c[i]-c[i-1]; d>0?gains+=d:losses-=d; }
            if(losses===0) return 100;
            return 100-(100/(1+(gains/losses)));
        },
        
        atr: (h,l,c,p=14) => {
            if(h.length < p) return 0;
            let trs=[h[0]-l[0]];
            for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
        },
        
        adx: (h,l,c,p=14) => {
            const tr = MathCore.atr(h,l,c,p);
            if(tr===0) return 0;
            const move = Math.abs(c[c.length-1]-c[c.length-p]);
            return Math.min(100, (move/(tr*p))*100*2.0); 
        },
        
        // [ä¿®æ­£] å‹•æ…‹ Kelly (win=å‹ç‡ 0~1, odds=è³ ç‡)
        kelly: (win, odds) => {
            if(odds <= 0) return 0;
            const k = (win * (1 + odds) - 1) / odds;
            return Math.max(0, k * 100); // Return %
        }
    };

    // ==========================================
    // ğŸ“¡ å³æ™‚å¼•æ“ (WebSocket - Realtime Price)
    // ==========================================
    const WS_Engine = {
        socket: null,
        activeSymbols: new Set(),
        connect: function(symbols) {
            // é¿å…é‡è¤‡é€£ç·š
            const newSyms = symbols.filter(s => !this.activeSymbols.has(s));
            if(newSyms.length === 0 && this.socket && this.socket.readyState === WebSocket.OPEN) return;

            // å¦‚æœæœ‰æ–°å¹£ç¨®ï¼Œé‡æ–°å»ºç«‹é€£ç·š (ç°¡å–®è™•ç†)
            if(this.socket) this.socket.close();
            
            this.activeSymbols = new Set(symbols);
            const streams = symbols.map(s => `${s.toLowerCase()}@ticker`).join('/');
            
            this.socket = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
            this.socket.onopen = () => document.getElementById('wss-dot').classList.add('live-active');
            this.socket.onclose = () => {
                document.getElementById('wss-dot').classList.remove('live-active');
                // ç°¡å–®çš„æ–·ç·šé‡é€£æ©Ÿåˆ¶
                setTimeout(() => this.connect(symbols), 5000);
            };
            this.socket.onmessage = (e) => {
                const d = JSON.parse(e.data).data;
                this.updateUI(d.s, parseFloat(d.c));
            };
        },
        updateUI: function(sym, price) {
            if(sym === 'BTCUSDT') {
                document.getElementById('btc-price').innerText = price.toFixed(2);
                return;
            }
            // é€™äº›æ˜¯å…·æœ‰å³æ™‚æ€§çš„ DOM å…ƒç´ 
            const el = document.getElementById(`price-${sym}`);
            const card = document.getElementById(`card-${sym}`);
            if(el && card) {
                const prev = parseFloat(el.getAttribute('data-prev') || price);
                el.innerText = price;
                el.setAttribute('data-prev', price);
                if(price > prev) { el.style.color='var(--green)'; card.classList.add('flash-up'); setTimeout(()=>card.classList.remove('flash-up'), 500); }
                else if(price < prev) { el.style.color='var(--red)'; card.classList.add('flash-down'); setTimeout(()=>card.classList.remove('flash-down'), 500); }
            }
        }
    };

    // ==========================================
    // ğŸ§  ç³»çµ±æ ¸å¿ƒ (System - Auto Refresh & Analysis)
    // ==========================================
    const System = {
        btcHistory: [],
        btcTrend: 'NEUTRAL',
        refreshTimer: null,

        // ç³»çµ±å…¥å£ï¼šåŒ…å«è‡ªå‹•åˆ·æ–°é‚è¼¯
        init: async function() {
            // 1. åˆæ¬¡è¼‰å…¥é¡¯ç¤º Loading
            if(document.getElementById('grid-container').children.length === 0) {
                document.getElementById('grid-container').innerHTML = '<div style="text-align:center; padding:50px; color:#666;">â³ ç³»çµ±åˆå§‹åŒ–ä¸­...</div>';
            }

            // 2. ç«‹å³åŸ·è¡Œä¸€æ¬¡å®Œæ•´åˆ†æ
            await this.runAnalysisTask();

            // 3. å•Ÿå‹•èƒŒæ™¯è¼ªè©¢ (æ¯60ç§’)
            if(this.refreshTimer) clearInterval(this.refreshTimer);
            this.refreshTimer = setInterval(async () => {
                const timestamp = new Date().toLocaleTimeString();
                console.log(`[${timestamp}] èƒŒæ™¯æ•¸æ“šåˆ·æ–°ä¸­...`);
                
                // æ›´æ–°ç‹€æ…‹æ¬„æ™‚é–“
                const statusEl = document.getElementById('btc-regime');
                if(!statusEl.querySelector('.update-time')) {
                    statusEl.innerHTML += ` <span class="update-time" style="font-size:10px; color:#666; margin-left:5px;"></span>`;
                }
                statusEl.querySelector('.update-time').innerText = `(${timestamp})`;

                await this.runAnalysisTask();
            }, 60000); // 60ç§’
        },

        runAnalysisTask: async function() {
            try {
                // 1. æ›´æ–° BTC
                await this.updateBTC();
                
                // 2. æƒææˆäº¤é‡æ’è¡Œ (ç†±é»å¯èƒ½æœƒè®Š)
                const targets = await this.scanTopVolume();
                
                // 3. æ¸…é™¤ Loading æ–‡å­— (å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡)
                const container = document.getElementById('grid-container');
                if(container.innerText.includes('åˆå§‹åŒ–ä¸­')) {
                    container.innerHTML = ''; 
                }

                const wsList = ['BTCUSDT'];
                for(let sym of targets) {
                    // åŸ·è¡Œåˆ†æ (é€™æœƒè§¸ç™¼ renderCard åŸåœ°æ›´æ–°)
                    await this.analyze(sym); 
                    wsList.push(sym);
                    // é¿å… API Rate Limit
                    await new Promise(r => setTimeout(r, 150)); 
                }
                
                // 4. é€£æ¥ WebSocket
                WS_Engine.connect(wsList);
            } catch (error) {
                console.error("Analysis Task Error:", error);
            }
        },

        updateBTC: async function() {
            try {
                const r = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=100');
                const d = await r.json();
                this.btcHistory = d.map(x=>parseFloat(x[4])); // æ”¶ç›¤åƒ¹
                const price = this.btcHistory[this.btcHistory.length-1];
                const ma = MathCore.mean(this.btcHistory.slice(-50));
                this.btcTrend = price > ma ? 'BULL' : 'BEAR';
                
                const el = document.getElementById('btc-regime');
                // ä¿ç•™æ™‚é–“æˆ³ span
                const timeSpan = el.querySelector('.update-time');
                el.innerText = this.btcTrend==='BULL'?'ğŸŸ¢ å¤šé ­':'ğŸ”´ ç©ºé ­';
                el.style.color = this.btcTrend==='BULL'?'var(--green)':'var(--red)';
                if(timeSpan) el.appendChild(timeSpan);

            } catch(e){ console.error("BTC Update Fail", e); }
        },

        scanTopVolume: async function() {
            try {
                const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
                let d = await r.json();
                return d.filter(t=>t.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(t.symbol))
                        .sort((a,b)=>parseFloat(b.quoteVolume)-parseFloat(a.quoteVolume))
                        .slice(0, 10) // å–å‰ 10 å
                        .map(t=>t.symbol);
            } catch(e) { return []; }
        },

        analyze: async function(sym) {
            try {
                const [k15, k1h, k4h, prem] = await Promise.all([
                    this.getK(sym,'15m'), this.getK(sym,'1h'), this.getK(sym,'4h'),
                    fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`).then(r=>r.json())
                ]);

                if(!k1h.c || k1h.c.length === 0) return;

                const c1h = k1h.c;
                const price = c1h[c1h.length-1];
                
                // === æ•¸å­¸ä¿®æ­£é‚è¼¯ ===
                const zScore = MathCore.zScore(price, c1h.slice(-50));
                
                // Beta ç›¸é—œæ€§ (Log Returns)
                const btcRets = MathCore.getLogReturns(this.btcHistory.slice(-52));
                const coinRets = MathCore.getLogReturns(c1h.slice(-52));
                const minLen = Math.min(btcRets.length, coinRets.length);
                const corr = MathCore.correlation(btcRets.slice(-minLen), coinRets.slice(-minLen));

                const fr = parseFloat(prem.lastFundingRate)*100;
                const atr1h = MathCore.atr(k1h.h, k1h.l, k1h.c);
                
                // æŒ‡æ¨™è¨ˆç®—
                const ind15 = this.calcInd(k15);
                const ind1h = this.calcInd(k1h);
                const ind4h = this.calcInd(k4h);

                // ç¶œåˆè©•åˆ† (é­šèº«ç­–ç•¥)
                const scoreData = this.evaluate(zScore, corr, fr, price, atr1h, this.btcTrend, ind1h.volRatio, ind1h.emaState);

                // æ¸²æŸ“ UI (åŸåœ°æ›´æ–°)
                this.renderCard(sym, price, scoreData, { '15m':ind15, '1h':ind1h, '4h':ind4h }, zScore, fr, corr);
            } catch(e) { console.error(`Analyze ${sym} error`, e); }
        },

        getK: async function(s, i) {
            const r = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s}&interval=${i}&limit=${CONFIG.KLINES_LIMIT}`);
            const d = await r.json();
            return { c: d.map(x=>parseFloat(x[4])), h: d.map(x=>parseFloat(x[2])), l: d.map(x=>parseFloat(x[3])), v: d.map(x=>parseFloat(x[5])) };
        },

        calcInd: function(k) {
            const c = k.c;
            const rsi = MathCore.rsi(c);
            const ema = MathCore.ema(c, 50)[c.length-1];
            const adx = MathCore.adx(k.h, k.l, c);
            const atr = MathCore.atr(k.h, k.l, c);
            const meanVol = MathCore.mean(k.v.slice(-20));
            const volRatio = meanVol > 0 ? k.v[k.v.length-1] / meanVol : 0;
            return { rsi, adx, ema, volRatio, atr, price: c[c.length-1], emaState: c[c.length-1]>ema?'Bull':'Bear' };
        },

        // === ç­–ç•¥è©•ä¼° (The Fish Body Logic) ===
        evaluate: function(z, corr, fr, price, atr, btcState, volRatio, emaState) {
            let checks = { trend:false, rsi:false, adx:false, vol:false, loc:false, str:false };
            let score = 0;

            // 1. çµæ§‹åˆ† (å¿…é ˆé †å‹¢)
            // BTC Bull + è‡ªèº«åœ¨ EMA ä¹‹ä¸Š + æœ‰æ­£ç›¸é—œ
            if(btcState === 'BULL' && emaState === 'Bull' && corr > 0.3) { 
                checks.trend = true; score += 20; 
            }
            
            // 2. é­šèº«åˆ¤æ–· (æ‹’çµ•é­šå°¾è¿½é«˜)
            if(z > 0 && z < 2.2) { checks.rsi = true; score += 15; } // Zå¤ªé«˜ä¸çµ¦åˆ†
            
            // 3. è²»ç‡å¥åº· (æœªéç†±)
            if(Math.abs(fr) < 0.03) { checks.adx = true; score += 15; } 
            
            // 4. é‡èƒ½æ¨å‡
            if(volRatio > 1.2) { checks.vol = true; score += 15; }
            
            // 5. ç›¸å°ä½ç½® (ä½ä½å•Ÿå‹•)
            if(z < 1.5) { checks.loc = true; score += 20; }
            
            // 6. å¼·å‹¢é€£å‹•
            if(corr > 0.5) { checks.str = true; score += 15; }

            // è©•ç´š
            let tier = 'B';
            if(score >= 80) tier = 'S';
            else if(score >= 60) tier = 'A';

            // è¨Šè™Ÿ
            let type = 'WAIT';
            if(score >= 60) type = 'LONG';
            if(z > 2.5) type = 'SHORT (è¶…è²·)'; // é­šå°¾è­¦å‘Š

            // å‹•æ…‹ Kelly è¨ˆç®—
            const slDist = atr * 1.5;
            const tp1Dist = atr * 2.0; 
            const tp2Dist = atr * 3.5;
            const odds = slDist > 0 ? tp1Dist / slDist : 1.5;

            // ä¼°ç®—å‹ç‡ (Score Mapping)
            let estimatedWinRate = 0.45; 
            if (score >= 60) estimatedWinRate = 0.50 + ((score - 60) * 0.005);
            estimatedWinRate = Math.min(estimatedWinRate, 0.70);

            // è¨ˆç®— Kelly
            let kelly = MathCore.kelly(estimatedWinRate, odds);
            if(score < 60) kelly = 0; // ä¸åŠæ ¼ä¸é–‹å€‰
            kelly = kelly * 0.5; // Half-Kelly é¢¨éšªæ§åˆ¶

            return {
                score, tier, checks, type, kelly,
                sl: (price - slDist).toFixed(4),
                tp1: (price + tp1Dist).toFixed(4),
                tp2: (price + tp2Dist).toFixed(4),
                entry: price
            };
        },

        // === åŸåœ°æ›´æ–° UI (No-Blink Render) ===
        renderCard: function(sym, price, strat, inds, z, fr, corr) {
            const container = document.getElementById('grid-container');
            let div = document.getElementById(`card-${sym}`);
            
            // æ§‹å»º HTML
            const htmlContent = `
                <div class="card-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span class="sym-title">${sym.replace('USDT','')}</span>
                        <span class="tier-badge tier-${strat.tier.toLowerCase()}" style="display:inline-block;">${strat.tier}ç´š</span>
                    </div>
                    <div class="sym-price" id="price-${sym}" data-prev="${price}">${price}</div>
                </div>
                <div class="card-body">
                    <div class="col-section">
                        <div class="score-box">
                            <div class="score-title"><span>è©•åˆ†ç´°ç¯€ (Math)</span><span class="${strat.score>=60?'pass':'fail'}">${strat.score}åˆ†</span></div>
                            <div class="score-grid">
                                <div class="score-item">çµæ§‹ ${strat.checks.trend?'âœ…':'âŒ'}</div>
                                <div class="score-item">Zåˆ† ${strat.checks.rsi?'âœ…':'âš ï¸'}</div>
                                <div class="score-item">è²»ç‡ ${strat.checks.adx?'âœ…':'âš ï¸'}</div>
                                <div class="score-item">é‡èƒ½ ${strat.checks.vol?'âœ…':'âŒ'}</div>
                                <div class="score-item">ä½ç½® ${strat.checks.loc?'âœ…':'âš ï¸'}</div>
                                <div class="score-item">Beta ${strat.checks.str?'âœ…':'âš ï¸'}</div>
                            </div>
                        </div>
                        
                        <div class="info-group">
                            <div class="info-row"><span>Kellyå€‰ä½</span><span style="color:var(--blue); font-weight:bold;">${strat.kelly.toFixed(1)}%</span></div>
                            <div class="info-row"><span>Z-Score</span><span class="z-tag" style="color:${z>0?'var(--green)':'var(--red)'}">${z.toFixed(2)}</span></div>
                            <div class="info-row"><span>Betaé€£å‹•</span><span style="color:${corr>0.7?'var(--red)':'#888'}">${corr.toFixed(2)}</span></div>
                            <div class="info-row"><span>Funding</span><span style="color:${Math.abs(fr)>0.01?'var(--red)':'var(--green)'}">${fr.toFixed(4)}%</span></div>
                        </div>

                        <div class="ai-action-area" id="ai-action-${sym}"></div>
                    </div>

                    ${['15m','1h','4h'].map(tf => {
                        const d = inds[tf];
                        const zPct = Math.min(Math.max((d.rsi-30)/70 * 100, 0), 100); 
                        
                        return `
                        <div class="col-section">
                            <div class="sect-title">${tf}</div>
                            <div class="wr-bar-bg">
                                <div class="wr-l" style="width:${zPct}%"></div>
                                <div class="wr-s" style="width:${100-zPct}%"></div>
                            </div>
                            
                            <div style="display:flex; flex-direction:column; gap:2px; margin-top:8px; margin-bottom:8px;">
                                <div class="ind-row"><span class="ind-name">RSI</span><span class="ind-val" style="color:${d.rsi>70?'var(--red)':d.rsi<30?'var(--green)':'#eee'}">${d.rsi.toFixed(1)}</span></div>
                                <div class="ind-row"><span class="ind-name">EMA</span><span class="ind-val" style="color:${d.emaState==='Bull'?'var(--green)':'var(--red)'}">${d.emaState}</span></div>
                                <div class="ind-row"><span class="ind-name">ADX</span><span class="ind-val" style="color:${d.adx>25?'var(--yellow)':'#666'}">${d.adx.toFixed(1)}</span></div>
                                <div class="ind-row"><span class="ind-name">Vol Ratio</span><span class="ind-val" style="color:${d.volRatio>1.2?'var(--yellow)':'#888'}">${d.volRatio.toFixed(1)}x</span></div>
                                <div class="ind-row"><span class="ind-name">ATR</span><span class="ind-val">${d.atr.toFixed(2)}</span></div>
                            </div>
                            
                            <div class="strat-box ${strat.type.includes('LONG')?'strat-long':strat.type.includes('SHORT')?'strat-short':''}">
                                <div class="strat-status">${strat.type}</div>
                                <div class="four-grid">
                                    <div class="sg-cell"><span class="sg-label">En</span><span class="sg-val">${strat.entry}</span></div>
                                    <div class="sg-cell"><span class="sg-label">SL</span><span class="sg-val" style="color:var(--blue)">${strat.sl}</span></div>
                                    <div class="sg-cell"><span class="sg-label">TP1</span><span class="sg-val" style="color:var(--green)">${strat.tp1}</span></div>
                                    <div class="sg-cell"><span class="sg-label">TP2</span><span class="sg-val" style="color:var(--gold)">${strat.tp2}</span></div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;

            // æ›´æ–°æˆ–å‰µå»º
            if (div) {
                div.innerHTML = htmlContent;
            } else {
                div = document.createElement('div');
                div.className = 'coin-card';
                div.id = `card-${sym}`;
                div.innerHTML = htmlContent;
                container.appendChild(div);
            }
            
            // é‡æ–°ç¶å®š AI æŒ‰éˆ• (æ¯æ¬¡ render å¾Œéœ€é‡ç¶)
           if(strat.tier === 'S' || strat.tier === 'A') {
                const btnArea = div.querySelector(`#ai-action-${sym}`);
                const btn = document.createElement('button');
                btn.className = `ai-btn ${strat.tier==='S'?'btn-s':'btn-a'}`;
                btn.style.display = 'block';
                btn.innerText = `ğŸ¤– ç”Ÿæˆæˆ°è¡“æŒ‡ä»¤ (${strat.tier}ç´š)`;
                
                // ã€ä¿®æ”¹é»ã€‘ï¼šé€™è£¡å¤šå‚³äº†ä¸€å€‹ strat åƒæ•¸é€²å»
                btn.onclick = () => askAI(btn, sym, z, fr, strat.type, strat);
                
                btnArea.appendChild(btn);
                const res = document.createElement('div');
                res.id = `ai-res-${sym}`;
                res.className = 'ai-result';
                // å¢åŠ ä¸€é»æ¨£å¼è®“ AI æ–‡å­—æ›´å¥½è®€
                res.style.cssText = "background: rgba(40, 30, 60, 0.6); border: 1px solid var(--purple); border-radius: 6px; padding: 12px; margin-top: 10px; display: none; font-size: 13px; line-height: 1.6; color: #ddd;";
                btnArea.appendChild(res);
            }
        }
    };

    // ==========================================
    // ğŸ¤– AI æ¨¡çµ„ (Gemini)
    // ==========================================
 async function askAI(btn, sym, z, fr, type, strat) {
        if(!CONFIG.GEMINI_API_KEY.includes('AI')) { alert('è«‹å¡«å¯« API Key'); return; }
        
        btn.innerText = "âš¡ è¨ˆç®—æˆ°è¡“ä¸­...";
        
        // æˆ‘å€‘å°‡ strat (ç­–ç•¥ç‰©ä»¶) ä¹Ÿå‚³é€²ä¾†ï¼Œé€™æ¨£ AI æ‰çŸ¥é“æ­¢ç›ˆæ­¢æåœ¨å“ª
        // æ³¨æ„ï¼šå‘¼å«æ­¤å‡½æ•¸çš„åœ°æ–¹ (renderCard) ä¹Ÿéœ€è¦æ”¹ä¸€ä¸‹å‚³åƒ
        
        const prompt = `
        ä½ æ˜¯ä¸€å€‹å†·é…·ã€è¬›æ±‚æ•¸æ“šçš„é‡åŒ–äº¤æ˜“å“¡ã€‚ä¸è¦èªªå»¢è©±ï¼Œä¸è¦èªªã€ŒæŠ•è³‡æœ‰é¢¨éšªã€ï¼Œç›´æ¥çµ¦æˆ‘äº¤æ˜“æŒ‡ä»¤ã€‚
        
        ã€ç•¶å‰æ•¸æ“šã€‘
        æ¨™çš„: ${sym}
        è¨Šè™Ÿ: ${type} (ç³»çµ±è©•åˆ†: ${strat.score}åˆ†)
        ç•¶å‰åƒ¹æ ¼: ${strat.entry}
        
        ã€ç³»çµ±å»ºè­°åƒæ•¸ã€‘
        é€²å ´ä½: å¸‚åƒ¹ (${strat.entry})
        æ­¢æä½ (SL): ${strat.sl} (åŸºæ–¼ 1.5x ATR)
        ç¬¬ä¸€æ­¢ç›ˆ (TP1): ${strat.tp1} (åŸºæ–¼ 2.0x ATR)
        ç¬¬äºŒæ­¢ç›ˆ (TP2): ${strat.tp2} (åŸºæ–¼ 3.5x ATR)
        å»ºè­°å€‰ä½: ${strat.kelly.toFixed(1)}% (åŠå‡±åˆ©)
        
        ã€å¸‚å ´ç‹€æ…‹ã€‘
        Z-Score: ${z.toFixed(2)} (ä½ç½®è©•ä¼°)
        è²»ç‡: ${fr.toFixed(4)}% (æ“æ“ åº¦è©•ä¼°)
        
        è«‹ç”¨ä»¥ä¸‹æ ¼å¼ç°¡çŸ­è¼¸å‡º (åš´ç¦å»¢è©±)ï¼š
        
        1. ğŸ¯ **æ ¸å¿ƒé‚è¼¯**ï¼šä¸€å¥è©±è§£é‡‹ç‚ºä»€éº¼ç¾åœ¨é€²å ´ï¼Ÿ(ä¾‹å¦‚ï¼šZåˆ†ä½ä½å•Ÿå‹•ã€ä¸»åŠ›è³‡é‡‘æµå…¥ç­‰)
        2. ğŸ›‘ **é˜²å®ˆè§€é»**ï¼šç‚ºä»€éº¼æ­¢æè¨­åœ¨ ${strat.sl}ï¼Ÿ(è§£é‡‹è·Œç ´é€™è£¡ä»£è¡¨ä»€éº¼çµæ§‹ç ´å£)
        3. ğŸ’° **ç²åˆ©åŠ‡æœ¬**ï¼šTP1 ${strat.tp1} æ˜¯ä»€éº¼ä½ç½®ï¼ŸTP2 é æœŸæœƒç¢°åˆ°ä»€éº¼é˜»åŠ›ï¼Ÿ
        4. âš ï¸ **å¦æ±ºæ¢ä»¶**ï¼šå¦‚æœç™¼ç”Ÿä»€éº¼äº‹(ä¾‹å¦‚è²»ç‡çªç„¶é£†é«˜)ï¼Œç«‹åˆ»å¸‚åƒ¹é€ƒè·‘ï¼Ÿ
        `;

        try {
            const r = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`, 
            { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({contents:[{parts:[{text:prompt}]}]})});
            const d = await r.json();
            const res = document.getElementById(`ai-res-${sym}`);
            res.style.display='block';
            
            // ç°¡å–®çš„ markdown è½‰ HTML è™•ç†
            let text = d.candidates[0].content.parts[0].text;
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            text = text.replace(/\n/g, '<br>'); // Newline
            
            res.innerHTML = text; 
            btn.innerText = "âœ… æˆ°è¡“ç”Ÿæˆå®Œç•¢";
        } catch(e) { 
            console.error(e);
            btn.innerText = "âŒ é€£ç·šå¤±æ•—"; 
        }
    }

    // å•Ÿå‹•ç³»çµ±
    System.init();
</script>
</body>
</html>
