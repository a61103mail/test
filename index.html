<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ°æƒ…å®¤ V30 (å…¨åŠŸèƒ½åšå¼ˆæ——è‰¦ç‰ˆ)</title>
    <style>
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d; --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535; --yellow-bg: rgba(252, 213, 53, 0.1);
            --border: #2b3139; --modal-bg: #1e2329;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .btc-bar { background: #1e2329; padding: 6px 12px; border-radius: 4px; border-left: 4px solid var(--yellow); font-size: 11px; display: flex; gap: 15px; }
        .btn-filter { background: #2b3139; color: #fff; border: 1px solid #444; padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        /* å¡ç‰‡ç³»çµ± */
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; transition: all 0.2s ease; }
        .coin-card.expanded { border-color: #555; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1e2329; border-bottom: 1px solid transparent; }
        .coin-card.expanded .card-header { border-bottom: 1px solid var(--border); background: #252a30; }
        
        .ch-left { display: flex; align-items: center; gap: 12px; }
        .sym-name { font-size: 16px; font-weight: 900; color: #fff; width: 75px; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 15px; width: 90px; }
        .up { color: var(--green); } .down { color: var(--red); }

        .ch-right { display: flex; align-items: center; gap: 10px; }
        .math-tag { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: #333; color: #888; border: 1px solid #444; }
        .signal-badge { font-size: 12px; padding: 3px 8px; border-radius: 4px; font-weight: bold; min-width: 90px; text-align: center; }
        .sb-long { background: var(--green-bg); color: var(--green); border: 1px solid var(--green); }
        .sb-short { background: var(--red-bg); color: var(--red); border: 1px solid var(--red); }
        .sb-wait { background: #333; color: #888; border: 1px solid #555; }

        /* å¡ç‰‡å…§å®¹ (ä¿ç•™ä½ åŸæœ¬çš„ä¸‰æ¬„ä½ˆå±€) */
        .card-body { display: none; padding: 10px; background: #111; grid-template-columns: 200px 1fr 1fr 1fr; gap: 10px; }
        .coin-card.expanded .card-body { display: grid; }

        .col-info { padding: 10px; border-right: 1px dashed #333; display: flex; flex-direction: column; gap: 10px; }
        .col-tf { padding: 5px; border-right: 1px dashed #333; display: flex; flex-direction: column; }
        .col-tf:last-child { border-right: none; }
        
        .tf-header { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; display: flex; justify-content: space-between; }
        .tf-title { font-weight: bold; font-size: 13px; color: #fff; }
        
        .wr-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; margin-bottom: 2px; }
        .wr-bar-long { height: 100%; background: var(--green); transition: width 0.5s; }
        .wr-bar-short { height: 100%; background: var(--red); transition: width 0.5s; }
        
        /* æŒ‡æ¨™åˆ—è¡¨ (5é …å…¨ç•™) */
        .ind-list { display: grid; grid-template-columns: 1fr; gap: 3px; margin-bottom: 8px; }
        .ind-item { display: flex; justify-content: space-between; font-size: 11px; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 3px; }
        .win-dual { font-family: 'Roboto Mono'; font-size: 10px; }
        .active-side { font-weight: bold; text-decoration: underline; opacity: 1 !important; }

        /* ç­–ç•¥ç›’èˆ‡ EV é¡¯ç¤º */
        .strat-box { margin-top: auto; padding: 8px; border-radius: 4px; border: 1px solid #444; text-align: center; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .ev-disp { font-size: 10px; margin-bottom: 4px; font-weight: bold; font-family: 'Roboto Mono'; }
        .ev-pos { color: var(--green); } .ev-neg { color: var(--red); }

        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; text-align: left; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--modal-bg); width: 90%; max-width: 500px; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; }
        .modal-body { padding: 15px; max-height: 60vh; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .coin-option { background: #0b0e11; padding: 8px; border-radius: 4px; cursor: pointer; text-align: center; font-size: 12px; border: 1px solid #333; }
        .coin-option.selected { border: 1px solid var(--green); color: var(--green); font-weight: bold; }
        .search-box { width: 100%; padding: 12px; box-sizing: border-box; background: #0b0e11; border: none; border-bottom: 1px solid #333; color: #fff; }

        @media (max-width: 900px) { .card-body { grid-template-columns: 1fr; } .col-info, .col-tf { border-right: none; border-bottom: 1px solid #333; } }
    </style>
</head>
<body>

<div class="modal-overlay" id="filterModal">
    <div class="modal-content">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">å¹£ç¨®ç¯©é¸</span>
            <span style="cursor:pointer;" onclick="closeModal()">âœ•</span>
        </div>
        <div style="padding:10px;">
            <input type="text" class="search-box" id="coinSearch" placeholder="æœå°‹å¹£ç¨® (å¦‚: DOGE)..." onkeyup="filterCoins()">
        </div>
        <div class="modal-body" id="coinList">è¼‰å…¥ä¸­...</div>
        <div style="padding:15px; text-align:right;"><button onclick="applyFilter()" style="background:var(--green); border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">ç¢ºèªå¥—ç”¨</button></div>
    </div>
</div>

<div class="header">
    <div class="btc-bar">
        <span>BTC éŒ¨å®š: <strong id="btc-trend">ç›£æ§ä¸­</strong></span>
        <span>Corr(ç›¸é—œæ€§): <strong id="btc-corr">è¨ˆç®—ä¸­</strong></span>
    </div>
    <button class="btn-filter" onclick="openModal()">â• ç¯©é¸/æ–°å¢</button>
</div>

<div id="grid-container">
    <div style="text-align:center; padding:50px; color:#666;">åˆå§‹åŒ– V30 æ•¸å­¸å¼•æ“...</div>
</div>

<script>
    const TFS = ['15m', '1h', '4h'];
    const LIMIT = 500;
    // é è¨­æ¸…å–®å®Œå…¨ä¿ç•™
    const DEFAULT_COINS = ['btcusdt', 'ethusdt', 'solusdt', 'adausdt', 'xrpusdt', 'riverusdt', 'nxpcusdt'];
    const TRANS = { '15m': '15m (çŸ­)', '1h': '1H (æ³¢)', '4h': '4H (è¶¨)' };

    let activeCoins = new Set(DEFAULT_COINS);
    let allCoins = [];
    let btcHistory = []; // å­˜å„² BTC æ­·å² K ç·šç”¨æ–¼è¨ˆç®—ç›¸é—œä¿‚æ•¸ Beta
    let wss = null;

    // --- 1. ç³»çµ±åˆå§‹åŒ– (å…ˆæŠ“ BTC å»ºç«‹åŸºæº–) ---
    async function initSystem() {
        await fetchBTCData();
        await fetchExchangeInfo();
        await applyFilter(false); 
    }

    async function fetchBTCData() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=100');
            const data = await res.json();
            btcHistory = data.map(d => parseFloat(d[4]));
            
            // åˆ¤æ–· BTC çŸ­æœŸè¶¨å‹¢
            const change = (btcHistory[99] - btcHistory[98]) / btcHistory[98];
            const el = document.getElementById('btc-trend');
            if(change < -0.005) { el.textContent = "ğŸ”» ä¸‹è·Œ"; el.style.color = "#f6465d"; }
            else if(change > 0.005) { el.textContent = "ğŸš€ ä¸Šæ¼²"; el.style.color = "#0ecb81"; }
            else { el.textContent = "âš–ï¸ éœ‡ç›ª"; el.style.color = "#fcd535"; }
        } catch(e) {}
    }

    async function fetchExchangeInfo() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await res.json();
            allCoins = data.symbols.filter(s => s.quoteAsset === 'USDT' && s.status === 'TRADING').map(s => s.symbol.replace('USDT', '')).sort();
        } catch(e) {}
    }

    // --- 2. æ•¸å­¸å¼•æ“ (V29 å‡ç´šç‰ˆ: åŠ å…¥ Beta, ER, EV) ---
    const MathEngine = {
        emaArray: (d, p) => { let k=2/(p+1), ema=[d[0]]; for(let i=1;i<d.length;i++) ema.push(d[i]*k+ema[i-1]*(1-k)); return ema; },
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        rsiArray: (c) => { 
            let rsi=[], g=0, l=0; for(let i=1;i<=14;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/14, al=l/14; rsi[14]=100-(100/(1+ag/al));
            for(let i=15;i<c.length;i++){ let d=c[i]-c[i-1]; d>0?ag=(ag*13+d)/14:al=(al*13-d)/14; rsi[i]=al===0?100:100-(100/(1+ag/al)); }
            return rsi;
        },
        atr: (h,l,c,p=14) => { 
            let trs=[]; for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]))); 
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p; 
        },
        // è¨ˆç®—ç›¸é—œä¿‚æ•¸ (Beta)
        correlation: (dataA, dataB, len=24) => {
            if(!dataB || dataB.length < len || dataA.length < len) return 1;
            const a = dataA.slice(-len), b = dataB.slice(-len);
            const avgA = a.reduce((x,y)=>x+y,0)/len, avgB = b.reduce((x,y)=>x+y,0)/len;
            let num=0, denA=0, denB=0;
            for(let i=0;i<len;i++) {
                let da = a[i]-avgA, db = b[i]-avgB;
                num += da*db; denA += da*da; denB += db*db;
            }
            return denA===0||denB===0 ? 0 : num / Math.sqrt(denA*denB);
        },
        // è¨ˆç®—æ•ˆç‡ä¿‚æ•¸ (ER) - åˆ¤æ–·æ˜¯è¶¨å‹¢é‚„æ˜¯ç›¤æ•´
        calcER: (c, len=10) => {
            if(c.length < len+1) return 0.5;
            const change = Math.abs(c[c.length-1] - c[c.length-len-1]);
            let vol = 0; for(let i=c.length-len; i<c.length; i++) vol += Math.abs(c[i]-c[i-1]);
            return vol===0 ? 0 : change/vol;
        },
        // å‹•æ…‹æ¬Šé‡å›æ¸¬
        getWeightedWinRate: (sigs, c, t) => {
            let wins=0, total=0;
            for(let i=50; i<sigs.length-5; i++) {
                if(sigs[i]) {
                    const w = Math.pow(1.006, i); 
                    total += w;
                    if((t=='long'&&c[i+5]>c[i]*1.0015) || (t=='short'&&c[i+5]<c[i]*0.9985)) wins += w;
                }
            }
            return total===0 ? 0 : Math.round((wins/total)*100);
        }
    };

    // --- 3. æ¸²æŸ“èˆ‡é‚è¼¯ ---
    async function applyFilter(fromModal = true) {
        if (fromModal) {
            activeCoins = new Set(Array.from(document.querySelectorAll('.coin-option.selected')).map(el => el.dataset.sym));
            closeModal();
        }
        const container = document.getElementById('grid-container');
        container.innerHTML = ''; 
        if(wss) wss.close(); store = {}; 
        for (const sym of activeCoins) { await initCard(sym); await new Promise(r => setTimeout(r, 50)); }
        connectWSS();
    }

    async function initCard(sym) {
        store[sym] = {};
        const container = document.getElementById('grid-container');
        const html = `
            <div class="coin-card" id="card-${sym}">
                <div class="card-header" onclick="toggleCard('${sym}')">
                    <div class="ch-left">
                        <span class="sym-name">${sym.toUpperCase().replace('USDT','')}</span>
                        <span class="sym-price" id="price-${sym}">--.--</span>
                    </div>
                    <div class="ch-right">
                        <span class="math-tag" id="beta-${sym}">Beta: --</span>
                        <span class="signal-badge sb-wait" id="badge-15m-${sym}">åˆ†æä¸­</span>
                        <span class="arrow-icon">â–¼</span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="col-info">
                        <div style="font-size:10px; color:#666; cursor:pointer; text-align:right;" onclick="event.stopPropagation(); removeCard('${sym}')">ç§»é™¤ âœ•</div>
                        <div class="wall-box">æ ¸å¿ƒç±Œç¢¼ç‰†:<br><span id="wall-${sym}" style="color:var(--yellow);font-weight:bold;">...</span></div>
                        <div class="flow-box">
                            <div style="color:#aaa;margin-bottom:2px;">Taker(1H)</div>
                            <div class="wr-bar-bg"><div class="wr-bar-long" id="f-b-${sym}"></div><div class="wr-bar-short" id="f-s-${sym}"></div></div>
                            <div style="display:flex; justify-content:space-between; font-size:10px;"><span id="f-bv-${sym}">--%</span><span id="f-sv-${sym}">--%</span></div>
                        </div>
                    </div>
                    ${TFS.map(tf => `
                        <div class="col-tf">
                            <div class="tf-header"><span class="tf-title">${TRANS[tf]}</span><span id="ev-${sym}-${tf}" class="ev-disp">EV: --</span></div>
                            <div class="wr-bar-bg"><div class="wr-bar-long" id="bar-l-${sym}-${tf}"></div><div class="wr-bar-short" id="bar-s-${sym}-${tf}"></div></div>
                            <div class="ind-list" id="list-${sym}-${tf}"></div>
                            <div class="strat-box strat-wait" id="strat-${sym}-${tf}">
                                <div id="act-${sym}-${tf}" style="font-weight:bold; font-size:12px;">è§€æœ›</div>
                                <div class="strat-grid">
                                    <div>En <span class="sg-val" id="en-${sym}-${tf}">--</span></div>
                                    <div>SL <span class="sg-val" id="sl-${sym}-${tf}">--</span></div>
                                    <div>TP1 <span class="sg-val" id="tp1-${sym}-${tf}">--</span></div>
                                    <div>TP2 <span class="sg-val" id="tp2-${sym}-${tf}">--</span></div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        container.insertAdjacentHTML('beforeend', html);

        try {
            const promises = TFS.map(tf => fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym.toUpperCase()}&interval=${tf}&limit=${LIMIT}`).then(r=>r.json()));
            const results = await Promise.all(promises);
            
            // è¨ˆç®— Beta ç›¸é—œæ€§ (ä½¿ç”¨ 1h æ•¸æ“š)
            const closes1h = results[1].map(d=>parseFloat(d[4]));
            const beta = MathEngine.correlation(closes1h, btcHistory);
            document.getElementById(`beta-${sym}`).textContent = `Beta: ${beta.toFixed(2)}`;
            const isHighCorr = beta > 0.7; // å®šç¾©é«˜åº¦ç›¸é—œ

            results.forEach((data, i) => processData(sym, TFS[i], data, isHighCorr));
        } catch(e) {}
    }

    function processData(sym, tf, data, isHighCorr) {
        data.pop(); 
        const c = data.map(d=>parseFloat(d[4])), h=data.map(d=>parseFloat(d[2])), l=data.map(d=>parseFloat(d[3])), v=data.map(d=>parseFloat(d[5]));
        const last=c.length-1, cur=c[last];

        // 1. è¨ˆç®— ER (æ•ˆç‡ä¿‚æ•¸) ä¾†æ±ºå®šæŒ‡æ¨™æ¬Šé‡
        const er = MathEngine.calcER(c);
        const wTrend = er > 0.5 ? 1.5 : 0.8; // è¶¨å‹¢æ˜é¡¯æ™‚ï¼ŒEMA/MACD æ¬Šé‡å¢åŠ 
        const wOsc = er < 0.4 ? 1.5 : 0.8;   // éœ‡ç›ªæ™‚ï¼ŒRSI/BOLL æ¬Šé‡å¢åŠ 

        // 2. æŒ‡æ¨™è¨ˆç®—
        const rsi = MathEngine.rsiArray(c), ema = MathEngine.emaArray(c, 50);
        const macdS = MathEngine.emaArray(c, 12), macdL = MathEngine.emaArray(c, 26), macd = macdS.map((v, i) => v - macdL[i]);
        const vwap = MathEngine.sma(c, 90), atr = MathEngine.atr(h,l,c);
        const bollM = MathEngine.sma(c, 20), std = Math.sqrt(c.slice(-20).map(x=>Math.pow(x-bollM,2)).reduce((a,b)=>a+b)/20);
        const upper = bollM + 2*std, lower = bollM - 2*std;

        // 3. ä¿¡è™Ÿç”Ÿæˆèˆ‡æ¬Šé‡å›æ¸¬
        const sigL = { r:rsi.map(v=>v<40), e:c.map((v,i)=>v>ema[i]), m:macd.map(v=>v>0), v:c.map((v,i)=>v>vwap), b:c.map((v,i)=>v>upper) };
        const sigS = { r:rsi.map(v=>v>60), e:c.map((v,i)=>v<ema[i]), m:macd.map(v=>v<0), v:c.map((v,i)=>v<vwap), b:c.map((v,i)=>v<lower) };
        
        const wrR = { l:MathEngine.getWeightedWinRate(sigL.r,c,'long'), s:MathEngine.getWeightedWinRate(sigS.r,c,'short') };
        const wrE = { l:MathEngine.getWeightedWinRate(sigL.e,c,'long'), s:MathEngine.getWeightedWinRate(sigS.e,c,'short') };
        const wrM = { l:MathEngine.getWeightedWinRate(sigL.m,c,'long'), s:MathEngine.getWeightedWinRate(sigS.m,c,'short') };
        const wrV = { l:MathEngine.getWeightedWinRate(sigL.v,c,'long'), s:MathEngine.getWeightedWinRate(sigS.v,c,'short') };
        const wrB = { l:MathEngine.getWeightedWinRate(sigL.b,c,'long'), s:MathEngine.getWeightedWinRate(sigS.b,c,'short') };

        // 4. æ¸²æŸ“ 5 æŒ‡æ¨™ (å®Œæ•´ä¿ç•™)
        const listEl = document.getElementById(`list-${sym}-${tf}`);
        const add = (n,v,d,w) => `<div class="ind-item"><span>${n} <strong>${v}</strong></span><div class="win-dual"><span class="w-l ${d=='l'?'active-side':''}" style="color:var(--green);opacity:0.6;">å¤š${w.l}%</span>|<span class="w-s ${d=='s'?'active-side':''}" style="color:var(--red);opacity:0.6;">ç©º${w.s}%</span></div></div>`;
        listEl.innerHTML = 
            add('RSI', rsi[last].toFixed(1), rsi[last]>55?'l':rsi[last]<45?'s':'n', wrR) +
            add('EMA', cur>ema[last]?'ä¸Š':'ä¸‹', cur>ema[last]?'l':'s', wrE) +
            add('MACD', macd[last]>0?'å¤š':'ç©º', macd[last]>0?'l':'s', wrM) +
            add('VWAP', cur>vwap?'ä¸Š':'ä¸‹', cur>vwap?'l':'s', wrV) +
            add('BOLL', cur>upper?'ç ´':cur<lower?'ç ´':'å€', cur>upper?'l':cur<lower?'s':'n', wrB);

        // 5. ç¶œåˆåšå¼ˆè©•åˆ† (Beta + ER + Weight)
        // ä½¿ç”¨ ER èª¿æ•´æ¬Šé‡
        let scoreL = (wrR.l*wOsc + wrB.l*wOsc + wrE.l*wTrend + wrM.l*wTrend + wrV.l) / (wOsc*2 + wTrend*2 + 1);
        let scoreS = (wrR.s*wOsc + wrB.s*wOsc + wrE.s*wTrend + wrM.s*wTrend + wrV.s) / (wOsc*2 + wTrend*2 + 1);
        
        // Beta æ‡²ç½°: å¦‚æœé«˜åº¦ç›¸é—œ (Beta>0.7) ä¸” BTC è¶¨å‹¢å‘ä¸‹ï¼Œå¤šå–®åˆ†æ•¸æ‰“æŠ˜
        const btcDump = btcHistory[99] < btcHistory[95];
        if(isHighCorr && btcDump) scoreL *= 0.7;

        document.getElementById(`bar-l-${sym}-${tf}`).style.width = `${scoreL}%`;
        document.getElementById(`bar-s-${sym}-${tf}`).style.width = `${scoreS}%`;

        // 6. çµæ§‹åŒ–æ­¢æ & æœŸæœ›å€¼ (EV) è¨ˆç®—
        const low15 = Math.min(...l.slice(-15)), high15 = Math.max(...h.slice(-15));
        const slL = Math.min(cur - atr*1.5, low15 * 0.999);
        const tpL = cur + atr*2.5;
        // EV = (å‹ç‡% * ç²åˆ©%) - (æ•—ç‡% * è™§æ%)
        const reward = (tpL - cur)/cur, risk = (cur - slL)/cur;
        const ev = (scoreL/100 * reward) - ((1-scoreL/100) * risk);
        
        const evEl = document.getElementById(`ev-${sym}-${tf}`);
        evEl.textContent = `EV:${ev>0?'+':''}${(ev*100).toFixed(1)}%`;
        evEl.className = `ev-disp ${ev>0.005 ? 'ev-pos' : (ev<-0.005?'ev-neg':'')}`;

        // 7. ç­–ç•¥åˆ¤å®š
        const box = document.getElementById(`strat-${sym}-${tf}`), title = document.getElementById(`act-${sym}-${tf}`), f = v => v<1?v.toFixed(4):v.toFixed(2);
        
        // åˆ¤å®šæ¢ä»¶: åˆ†æ•¸é«˜ + EV ç‚ºæ­£
        if(scoreL > 53 && ev > 0.002) {
            box.className='strat-box strat-long'; title.innerHTML=`<span class="up">å»ºè­°åšå¤š</span>`;
            document.getElementById(`en-${sym}-${tf}`).textContent=f(cur);
            document.getElementById(`sl-${sym}-${tf}`).textContent=f(slL);
            document.getElementById(`tp1-${sym}-${tf}`).textContent=f(cur+atr*1.2); document.getElementById(`tp2-${sym}-${tf}`).textContent=f(tpL);
            if(tf=='15m') { const b=document.getElementById(`badge-15m-${sym}`); b.className='signal-badge sb-long'; b.textContent=`åšå¤š(${Math.round(scoreL)}%)`; }
        } else if(scoreS > 53) { // ç©ºå–®é‚è¼¯ç°¡åŒ–å±•ç¤º
            box.className='strat-box strat-short'; title.innerHTML=`<span class="down">å»ºè­°åšç©º</span>`;
            document.getElementById(`en-${sym}-${tf}`).textContent=f(cur);
            document.getElementById(`sl-${sym}-${tf}`).textContent=f(Math.max(cur+atr*1.5, high15*1.001));
            document.getElementById(`tp1-${sym}-${tf}`).textContent=f(cur-atr*1.2); document.getElementById(`tp2-${sym}-${tf}`).textContent=f(cur-atr*2.5);
            if(tf=='15m') { const b=document.getElementById(`badge-15m-${sym}`); b.className='signal-badge sb-short'; b.textContent=`åšç©º(${Math.round(scoreS)}%)`; }
        } else {
            box.className='strat-box strat-wait'; title.textContent='è§€æœ› (EVä½)';
            if(tf=='15m') { const b=document.getElementById(`badge-15m-${sym}`); b.className='signal-badge sb-wait'; b.textContent=`è§€æœ›`; }
        }

        // 8. 1H ç±Œç¢¼ç‰†èˆ‡ Flow è£œå……
        if(tf==='1h') {
            let maxV=0, wallP=0; for(let i=last-50;i<=last;i++){ if(v[i]>maxV){ maxV=v[i]; wallP=c[i]; } }
            document.getElementById(`wall-${sym}`).textContent = wallP.toFixed(cur<1?4:2);
            let tb=0, tt=0; data.slice(-24).forEach(k=>{ tt+=parseFloat(k[5]); tb+=parseFloat(k[9]); });
            const bp=(tb/tt)*100; document.getElementById(`f-b-${sym}`).style.width=`${bp}%`; document.getElementById(`f-s-${sym}`).style.width=`${100-bp}%`;
            document.getElementById(`f-bv-${sym}`).textContent=`è²·${bp.toFixed(0)}%`; document.getElementById(`f-sv-${sym}`).textContent=`è³£${(100-bp).toFixed(0)}%`;
        }
    }

    // Modal & Websocket (ä¿ç•™)
    function openModal() { renderCoinList(); document.getElementById('filterModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('filterModal').style.display = 'none'; }
    function renderCoinList() { const c=document.getElementById('coinList'); c.innerHTML=''; allCoins.forEach(s=>{ const d=document.createElement('div'); d.className=`coin-option ${activeCoins.has(s)?'selected':''}`; d.textContent=s.toUpperCase(); d.dataset.sym=s; d.onclick=()=>d.classList.toggle('selected'); c.appendChild(d); }); }
    function filterCoins() { const t=document.getElementById('coinSearch').value.toUpperCase(); document.querySelectorAll('.coin-option').forEach(el=>el.style.display=el.textContent.includes(t)?'block':'none'); }
    async function applyFilter(fm=true) { if(fm){ activeCoins=new Set(Array.from(document.querySelectorAll('.coin-option.selected')).map(e=>e.dataset.sym)); closeModal(); } document.getElementById('grid-container').innerHTML=''; if(wss)wss.close(); for(const s of activeCoins){ await initCard(s); await new Promise(r=>setTimeout(r,50)); } connectWSS(); }
    window.toggleCard = s => document.getElementById(`card-${s}`).classList.toggle('expanded');
    function removeCard(s) { activeCoins.delete(s); document.getElementById(`card-${s}`).remove(); }
    function connectWSS() { wss=new WebSocket(`wss://fstream.binance.com/stream?streams=${Array.from(activeCoins).map(s=>`${s}@ticker`).join('/')}`); wss.onmessage=e=>{ const m=JSON.parse(e.data).data; const el=document.getElementById(`price-${m.s.toLowerCase()}`); if(el){ el.textContent=parseFloat(m.c); el.className=`sym-price ${parseFloat(m.P)>=0?'up':'down'}`; } }; }

    initSystem();
</script>
</body>
</html>
