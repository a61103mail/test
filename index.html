<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V78 æ‰¿è«¾å…Œç¾ç‰ˆ)</title>
    <style>
        /* =========================================
           V78ï¼šè³‡è¨Šé€æ˜åŒ–å„€è¡¨æ¿
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --red: #f6465d; --yellow: #fcd535; --gold: #ffd700; --blue: #2979ff; --purple: #bf5af2;
            --border: #2b3139;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', 'Roboto Mono', monospace; margin: 0; padding: 20px; font-size: 13px; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid var(--border); }
        .version-tag { font-size: 12px; color: var(--gold); border: 1px solid var(--gold); padding: 3px 6px; border-radius: 4px; margin-left: 10px; font-weight: bold; }
        .btc-bar { background: #1e2329; padding: 10px 20px; border-radius: 4px; border-left: 5px solid var(--gold); font-size: 14px; display: flex; gap: 25px; align-items: center; }
        
        #grid-container { display: flex; flex-direction: column; gap: 20px; max-width: 1900px; margin: 0 auto; }
        
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 4px 6px rgba(0,0,0,0.3); transition: border-color 0.3s; }
        .card-header { background: #1e2329; padding: 12px 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sym-title { font-size: 22px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .sym-price { font-size: 20px; font-weight: bold; font-family: 'Roboto Mono'; }
        
        .tier-badge { padding: 4px 12px; border-radius: 4px; font-weight: 900; font-size: 14px; display: none; text-transform: uppercase; letter-spacing: 1px; }
        .tier-s { background: rgba(14, 203, 129, 0.2); color: var(--green); border: 1px solid var(--green); box-shadow: 0 0 15px rgba(14, 203, 129, 0.2); animation: pulse 1s infinite; }
        .tier-a { background: rgba(252, 213, 53, 0.15); color: var(--yellow); border: 1px solid var(--yellow); }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .card-body { display: grid; grid-template-columns: 320px 1fr 1fr 1fr; gap: 2px; background: var(--border); }
        .col-section { background: var(--card); padding: 15px; display: flex; flex-direction: column; gap: 10px; }

        /* è©•åˆ†ç´°ç¯€ */
        .score-box { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 4px; margin-bottom: 10px; border: 1px solid #333; }
        .score-title { font-weight: bold; border-bottom: 1px solid #444; padding-bottom: 5px; margin-bottom: 5px; display:flex; justify-content:space-between; }
        .score-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 11px; color: #aaa; }
        .score-item span:last-child { float: right; font-weight: bold; }
        .pass { color: var(--green); } .fail { color: var(--red); }

        .ai-action-area { margin-top: auto; min-height: 80px; display: flex; flex-direction: column; justify-content: flex-end; }
        .ai-btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 13px; margin-top: 10px; transition: all 0.2s; display: none; text-align: center; }
        .ai-btn:hover { filter: brightness(1.2); transform: translateY(-1px); }
        .btn-s { background: linear-gradient(45deg, #0ecb81, #004d40); color: #fff; border: 1px solid #0ecb81; box-shadow: 0 0 10px rgba(14, 203, 129, 0.4); }
        .btn-a { background: linear-gradient(45deg, #fcd535, #5f4c00); color: #000; border: 1px solid #fcd535; }

        .ai-result { background: rgba(40, 30, 60, 0.6); border: 1px solid var(--purple); border-radius: 6px; padding: 10px; margin-top: 10px; display: none; }
        .ai-title { color: var(--purple); font-weight: bold; font-size: 11px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .ai-content { color: #eee; font-size: 12px; line-height: 1.4; white-space: pre-wrap; }

        .sect-title { font-size: 14px; font-weight: bold; color: #fff; border-bottom: 2px solid #333; padding-bottom: 8px; margin-bottom: 8px; text-align: center; background: #1a1e23; border-radius: 4px; }
        .ind-row { display: flex; justify-content: space-between; font-size: 12px; padding: 3px 5px; background: rgba(255,255,255,0.02); border-radius: 3px; }
        .ind-name { color: #888; } .ind-val { font-family: 'Roboto Mono'; font-weight: bold; }
        
        .strat-box { margin-top: auto; background: #111; border: 1px solid #444; border-radius: 6px; padding: 8px; }
        .strat-long { background: rgba(14, 203, 129, 0.1); border-color: var(--green); }
        .strat-short { background: rgba(246, 70, 93, 0.1); border-color: var(--red); }
        .strat-status { text-align: center; font-weight: bold; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #444; font-size: 13px; }
        .six-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px 12px; font-size: 11px; }
        .sg-cell { display: flex; justify-content: space-between; }
        .sg-label { color: #666; } .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; } .sg-profit { color: var(--gold); }

        @media (max-width: 1200px) { .card-body { grid-template-columns: 1fr; } .col-section { border-bottom: 1px solid var(--border); } }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center;">
        <h1>å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span class="version-tag">V78 æ‰¿è«¾å…Œç¾ç‰ˆ</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC: <strong id="btc-price" style="color:#fff;">...</strong></span>
        <span>ç‹€æ…‹: <strong id="sys-status" style="color:var(--green);">å¾…å‘½</strong></span>
        <button onclick="testDiscord()" style="background:#5865F2; color:#fff; border:none; padding:5px 15px; cursor:pointer; border-radius:4px;">æ¸¬è©¦ Discord</button>
    </div>
</div>

<div id="grid-container"></div>

<script>
    const CONFIG = {
        DISCORD_WEBHOOK: "YOUR_DISCORD_WEBHOOK_URL", 
        GEMINI_API_KEY: "YOUR_GEMINI_API_KEY",       
        KLINES_LIMIT: 500,
        BLACKLIST: ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'DAIUSDT', 'BUSDUSDT', 'EURUSDT']
    };

    // ==========================================
    // ğŸ“¡ Discord Bot
    // ==========================================
    const DISCORD_BOT = {
        history: new Map(), 

        checkAndSend: function(symbol, tier, direction, scoreData) {
            // Sç´šè‡ªå‹•ç™¼é€ (80åˆ†ä»¥ä¸Š)
            if (tier !== 'S') return;

            const now = new Date();
            const minutes = now.getMinutes();
            const isWindow = (minutes % 15) < 5 || (minutes % 15) > 10;
            if (!isWindow) return;

            const blockID = Math.floor(now.getTime() / (15 * 60 * 1000));
            const key = `${symbol}-${blockID}`;

            if (this.history.has(key)) return;
            this.history.set(key, true);
            
            // è‡ªå‹•ç™¼é€åŒ…å«è©•åˆ†ç´°ç¯€
            this.sendWebhook(symbol, tier, direction, scoreData, null);
        },

        sendWebhook: async function(symbol, tier, dir, data, aiContent) {
            if (!CONFIG.DISCORD_WEBHOOK || CONFIG.DISCORD_WEBHOOK.includes("YOUR")) return;

            const isLong = dir === 'long';
            const color = isLong ? 969601 : 16139869; 
            const emoji = tier === 'S' ? 'ğŸ”¥' : 'âš ï¸';
            const title = aiContent ? `ğŸ¤– AI å‹ç‡åˆ†æ: ${symbol}` : `${emoji} ${symbol} [ç³»çµ±è©•åˆ†: ${data.totalScore}]`;

            let desc = "";
            if (aiContent) desc = `${aiContent}\n\n`;

            const payload = {
                content: aiContent ? "ğŸ¤– AI æ·±åº¦å ±å‘Šå·²ç”Ÿæˆ" : `<@323770903370530817> Sç´šè¨Šè™Ÿ: ${symbol} (${data.totalScore}åˆ†)`, 
                username: "V78 åŸ·è¡Œå®˜",
                avatar_url: "https://cdn-icons-png.flaticon.com/512/4712/4712109.png",
                embeds: [{
                    title: title,
                    description: desc,
                    color: color,
                    fields: [
                        { name: "æ–¹å‘", value: isLong ? "ğŸ“ˆ åšå¤š" : "ğŸ“‰ åšç©º", inline: true },
                        { name: "è©•åˆ†çµæ§‹", value: `ç¸½åˆ†: **${data.totalScore}**\nTrend:${data.scores.trend?'âœ…':'âŒ'} | Vol:${data.scores.vol?'âœ…':'âŒ'}\nLoc:${data.scores.loc?'âœ…':'âš ï¸'} | Str:${data.scores.str?'âœ…':'âŒ'}`, inline: true },
                        { name: "æˆ°è¡“åŸ·è¡Œ", value: `Entry: ${data.entry}\nSL: ${data.sl}\nTP2: ${data.tp2}`, inline: true },
                    ],
                    footer: { text: "V78 Promise Kept Edition" },
                    timestamp: new Date().toISOString()
                }]
            };

            try {
                await fetch(CONFIG.DISCORD_WEBHOOK, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            } catch (e) { console.error("DC Error", e); }
        }
    };

    // ==========================================
    // ğŸ§  AI Agent (åŒ…å«å‹ç‡èˆ‡è¾¯è­‰)
    // ==========================================
    const AI_AGENT = {
        renderButton: function(symbol, tier, direction, fullData) {
            const container = document.getElementById(`ai-action-${symbol}`);
            if (!container) return;
            container.innerHTML = ''; 
            if (tier !== 'S' && tier !== 'A') return;

            const btn = document.createElement('button');
            const isS = tier === 'S';
            btn.className = `ai-btn ${isS ? 'btn-s' : 'btn-a'}`;
            btn.innerHTML = isS ? `ğŸ’ ç²å–å‹ç‡ & å„ªç¼ºé» (Sç´š)` : `âš ï¸ é¢¨éšªè¾¯è­‰ (Aç´š)`;
            btn.style.display = 'block';

            btn.onclick = () => { this.askGemini(btn, symbol, tier, direction, fullData); };
            container.appendChild(btn);
            
            const resBox = document.createElement('div');
            resBox.id = `ai-res-${symbol}`;
            resBox.className = 'ai-result';
            resBox.innerHTML = `<div class="ai-title"><span>ğŸ¤– Gemini å ±å‘Š</span></div><div class="ai-content"></div>`;
            container.appendChild(resBox);
        },

        askGemini: async function(btn, symbol, tier, dir, fullData) {
            if (!CONFIG.GEMINI_API_KEY || CONFIG.GEMINI_API_KEY.includes("YOUR")) { alert("API Key Missing"); return; }

            btn.disabled = true;
            btn.innerHTML = "â³ AI æ­£åœ¨è¨ˆç®—å‹ç‡...";
            const resBox = document.getElementById(`ai-res-${symbol}`);
            resBox.style.display = 'block';
            const content = resBox.querySelector('.ai-content');
            content.innerText = "æ•¸æ“šè¾¯è­‰ä¸­...";

            const strat = fullData.strategy;
            const d15 = fullData['15m'];
            const d1h = fullData['1h'];
            const d4h = fullData['4h'];

            // ğŸ”¥ V77/V78 æ‰¿è«¾å…Œç¾ Promptï¼šåŒ…å«å‹ç‡ã€å„ªç¼ºé»ã€æ•¸æ“šæ”¯æ’
            const prompt = `
            ä½ æ˜¯ä¸€ä½åš´æ ¼çš„é‡åŒ–åˆ†æå¸«ã€‚è«‹å° ${symbol} (${dir}) é€²è¡Œæ·±åº¦è©•ä¼°ã€‚
            ç³»çµ±è©•åˆ†ï¼š${strat.totalScore}/100ã€‚
            
            ã€å…­ç¶­æ•¸æ“šã€‘
            1. è¶¨å‹¢: 15m=${d15.emaState}, 1H=${d1h.emaState}, 4H=${d4h.emaState}
            2. å‹•èƒ½: RSI (15m=${d15.rsi}, 1H=${d1h.rsi})
            3. åŠ›åº¦: ADX (15m=${d15.adx}, 1H=${d1h.adx})
            4. è³‡é‡‘: 1H Vol=${d1h.vol}å€
            5. ä½ç½®: ä¹–é›¢éå¤§=${strat.biasWarn?"YES":"NO"}, ç›ˆè™§æ¯”=1:${strat.rr}
            
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œåš´æ ¼ä¾ç…§ä»¥ä¸‹æ ¼å¼è¼¸å‡ºï¼š
            
            1. **ğŸ“Š å‹ç‡é ä¼° (Win Rate)**ï¼š
               - åŸºæ–¼è¶¨å‹¢å…±æŒ¯èˆ‡é‡èƒ½ï¼Œçµ¦å‡ºå‹ç‡ (ä¾‹å¦‚ 65%)ã€‚
               - ç°¡è¿°ç†ç”± (ä¾‹å¦‚ï¼šé †å‹¢ä½†ç¸®é‡ï¼Œå‹ç‡æ‰£åˆ†)ã€‚
            
            2. **âš–ï¸ å¤šç©ºè¾¯è­‰**ï¼š
               - âœ… **å„ªå‹¢ (Pros)**ï¼š(åˆ—å‡º 2 é»æ”¯æŒé€²å ´çš„æ•¸æ“šï¼Œå¦‚ï¼šRSIå¥åº·ã€ä½ç½®ä½)ã€‚
               - âŒ **éš±æ†‚ (Cons)**ï¼š(åˆ—å‡º 2 é»æ½›åœ¨é¢¨éšªï¼Œå¦‚ï¼šä¸Šæ–¹å£“åŠ›è¿‘ã€4Hé€†å‹¢)ã€‚
            
            3. **ğŸ¯ æˆ°è¡“æŒ‡ä»¤** (50å­—å…§)ï¼š
               - çµ¦å‡ºæ˜ç¢ºæ“ä½œï¼šç¾åƒ¹åš / æ›å–®æ¥ / æ”¾æ£„ã€‚
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) });
                const json = await response.json();
                const text = json.candidates[0].content.parts[0].text.trim();
                
                content.innerText = text;
                btn.innerHTML = "âœ… å®Œæˆ";
                DISCORD_BOT.sendWebhook(symbol, tier, dir, strat, text);

            } catch (e) {
                content.innerText = "AI Error: " + e.message;
                btn.innerHTML = "âŒ å¤±æ•—";
                btn.disabled = false;
            }
        }
    };

    // ==========================================
    // ğŸ§® æ•¸å­¸å¼•æ“ & è©•åˆ†ç³»çµ±
    // ==========================================
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        ema: (d, p) => { let k=2/(p+1), e=[d[0]]; for(let i=1;i<d.length;i++) e.push(d[i]*k+e[i-1]*(1-k)); return e; },
        rsi: (c, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1;i<=p;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/p, al=l/p; rsi[p]=100-(100/(1+ag/al));
            for(let i=p+1;i<c.length;i++){ let d=c[i]-c[i-1]; let u=d>0?d:0; let dw=d<0?Math.abs(d):0; ag=(ag*(p-1)+u)/p; al=(al*(p-1)+dw)/p; rsi[i]=al===0?100:100-(100/(1+ag/al)); }
            return rsi;
        },
        bollinger: (c, p=20, m=2) => {
            const sma = c.slice(-p).reduce((a,b)=>a+b,0)/p;
            const sq = c.slice(-p).map(x=>Math.pow(x-sma,2)).reduce((a,b)=>a+b,0)/p;
            const std = Math.sqrt(sq);
            return { width: ((sma+m*std)-(sma-m*std))/sma };
        },
        atr: (h, l, c, p=14) => {
            let trs = [h[0]-l[0]];
            for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
        },
        adx: (h, l, c, p=14) => {
            const tr = MathEngine.atr(h,l,c,p);
            const move = Math.abs(c[c.length-1] - c[c.length-p]);
            let strength = (move / (tr * p)) * 100 * 2.5; 
            return Math.min(100, strength);
        }
    };

    // ==========================================
    // ğŸš€ ä¸»æµç¨‹
    // ==========================================
    let activeSymbols = new Set();

    async function initSystem() {
        console.log("V78 å•Ÿå‹•...");
        await updateBTC();
        await scanMarket();
        setInterval(scanMarket, 60 * 1000);
    }

    async function updateBTC() {
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCUSDT');
            const d = await r.json();
            document.getElementById('btc-price').innerText = parseFloat(d.price).toFixed(2);
        } catch(e){}
    }

    async function scanMarket() {
        document.getElementById('sys-status').innerText = "æƒæä¸­...";
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const d = await r.json();
            let pairs = d.filter(t => t.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(t.symbol));
            pairs.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
            const top10 = pairs.slice(0, 10).map(t => t.symbol);

            const newSet = new Set(top10);
            for(let s of activeSymbols) if(!newSet.has(s)) document.getElementById(`card-${s}`)?.remove();
            for(let s of newSet) if(!activeSymbols.has(s)) createCard(s);
            activeSymbols = newSet;

            document.getElementById('sys-status').innerText = "åˆ†æä¸­...";
            const tasks = Array.from(activeSymbols).map(s => analyze(s));
            await Promise.all(tasks);
            
            connectWSS(Array.from(activeSymbols));
            document.getElementById('sys-status').innerText = "ç›£æ§ä¸­";
        } catch(e) { console.error(e); document.getElementById('sys-status').innerText = "API ç•°å¸¸"; }
    }

    async function analyze(symbol) {
        const tfs = ['15m', '1h', '4h'];
        const reqs = tfs.map(tf => fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${CONFIG.KLINES_LIMIT}`).then(r=>r.json()).then(k=>({tf, k})));
        
        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`).then(r=>r.json()).then(d=>{
            const fr = parseFloat(d.lastFundingRate)*100;
            const el = document.getElementById(`fr-${symbol}`);
            if(el) { el.innerText = `${fr.toFixed(4)}%`; el.style.color = fr>0.01?'var(--red)':'var(--green)'; }
        });

        const res = await Promise.all(reqs);
        let fullData = { strategy: null, '15m': {}, '1h': {}, '4h': {} };

        res.forEach(({tf, k}) => {
            const d = processData(symbol, tf, k);
            
            fullData[tf] = {
                rsi: d.rsi.toFixed(1),
                emaState: d.price > d.ema ? "Bullish" : "Bearish",
                vol: d.volRatio.toFixed(1), 
                adx: d.adx.toFixed(1)
            };

            if(tf === '15m') { 
                fullData.strategy = { ...d.stratInfo, adx: d.adx.toFixed(1), vol: d.volRatio.toFixed(1) };
            }
        });

        // æ³¨å…¥ 1H/4H æ•¸æ“šåˆ° Strategy ä»¥ä¾¿æ‰“åˆ†
        fullData.strategy.h1Dir = fullData['1h'].emaState === 'Bullish' ? 'long' : 'short';
        fullData.strategy.h1Vol = parseFloat(fullData['1h'].vol);
        fullData.strategy.h1Adx = parseFloat(fullData['1h'].adx);
        fullData.strategy.h4Dir = fullData['4h'].emaState === 'Bullish' ? 'long' : 'short';

        // åŸ·è¡Œå…­ç¶­è©•åˆ†
        const tierInfo = calculateScoreAndTier(symbol, fullData.strategy);
        fullData.strategy.totalScore = tierInfo.score;
        fullData.strategy.scores = tierInfo.breakdown;

        DISCORD_BOT.checkAndSend(symbol, tierInfo.tier, tierInfo.dir, fullData.strategy);
        AI_AGENT.renderButton(symbol, tierInfo.tier, tierInfo.dir, fullData);
    }

    function processData(sym, tf, k) {
        const c = k.map(d=>parseFloat(d[4])), h=k.map(d=>parseFloat(d[2])), l=k.map(d=>parseFloat(d[3])), v=k.map(d=>parseFloat(d[5]));
        const last = c.length-1, price = c[last];

        const rsiArr = MathEngine.rsi(c); const rsi = rsiArr[last];
        const emaArr = MathEngine.ema(c, 50); const ema = emaArr[last];
        const atr = MathEngine.atr(h,l,c);
        const adx = MathEngine.adx(h,l,c);

        updateInd(sym, tf, 'RSI', rsi.toFixed(1), rsi>55?'long':rsi<45?'short':'n');
        
        const adxEl = document.getElementById(`adx-${sym}-${tf}`);
        if(adxEl) { adxEl.innerText = adx.toFixed(1); adxEl.style.color = adx>20?'var(--yellow)':'#666'; }

        const smaV = MathEngine.sma(v, 20);
        const volRatio = v[last]/smaV;
        if(tf==='1h') {
            document.getElementById(`vol-val-${sym}`).innerText = `x${volRatio.toFixed(1)}`;
            const vTag = document.getElementById(`vol-tag-${sym}`);
            if(volRatio > 1.0) { vTag.innerText="æ”¾é‡"; vTag.className="vol-tag v-high"; }
            else { vTag.innerText="ç¸®é‡"; vTag.className="vol-tag v-low"; }
        }
        
        let dir = 'wait';
        if(rsi > 55 && price > ema) dir = 'long';
        else if(rsi < 45 && price < ema) dir = 'short';

        const bias = Math.abs(price - ema) / ema * 100;
        const biasWarn = bias > 1.0; 
        
        const stratInfo = updateBox(sym, tf, price, atr, rsi, ema, dir, biasWarn);
        stratInfo.biasWarn = biasWarn;

        return { rsi, adx, volRatio, price, ema, stratInfo };
    }

    function updateBox(sym, tf, p, atr, rsi, ema, dir, biasWarn) {
        const box = document.getElementById(`sb-${sym}-${tf}`);
        const fmt = v => v.toFixed(p<10?4:2);
        
        const slDist = atr * 1.0; 
        const tp2Dist = atr * 2.5;
        const rr = (tp2Dist / slDist).toFixed(1);

        let info = { entry: fmt(p), sl: '-', tp2: '-', price: fmt(p), rr: rr };

        if(dir==='long') {
            box.className = 'strat-box strat-long';
            box.querySelector('.strat-status').innerText = "åšå¤š (LONG)";
            info.sl = fmt(p - slDist);
            info.tp2 = fmt(p + tp2Dist);
        } else if(dir==='short') {
            box.className = 'strat-box strat-short';
            box.querySelector('.strat-status').innerText = "åšç©º (SHORT)";
            info.sl = fmt(p + slDist);
            info.tp2 = fmt(p - tp2Dist);
        } else {
            box.className = 'strat-box';
            box.querySelector('.strat-status').innerText = "è§€æœ›";
        }

        const enEl = document.getElementById(`en-${sym}-${tf}`);
        if(biasWarn && dir!=='wait') { enEl.innerText=`âš ï¸ ${info.entry}`; enEl.style.color='var(--yellow)'; }
        else { enEl.innerText=info.entry; enEl.style.color='var(--text-main)'; }
        
        document.getElementById(`sl-${sym}-${tf}`).innerText = info.sl;
        document.getElementById(`tp2-${sym}-${tf}`).innerText = info.tp2;
        return info;
    }

    function updateInd(sym, tf, name, val, st) {
        const id = `ind-${sym}-${tf}-${name.replace(/[^a-zA-Z0-9]/g,'')}`;
        const el = document.getElementById(id);
        if(el) {
            el.innerText = val;
            if(st==='long') el.style.color = 'var(--green)';
            else if(st==='short') el.style.color = 'var(--red)';
            else el.style.color = '#ccc';
        }
    }

    // ==========================================
    // ğŸ”¥ V78 æ ¸å¿ƒï¼šå…­ç¶­åº¦è©•åˆ†ç³»çµ± (åš´æ ¼åŸ·è¡Œ)
    // ==========================================
    function calculateScoreAndTier(sym, data) {
        const card = document.getElementById(`card-${sym}`);
        const d15 = data.entry ? (data.tp2 > data.entry ? 'long' : 'short') : 'wait';
        
        if (d15 === 'wait') {
            updateCardStyle(card, 'B', 'wait');
            return { tier: 'B', dir: 'wait', score: 0 };
        }

        let score = 0;
        let breakdown = { trend: false, rsi: false, adx: false, vol: false, loc: false, str: false };

        // 1. è¶¨å‹¢é¢ (Trend) - 20åˆ†
        if (data.h1Dir === d15) { score += 20; breakdown.trend = true; }

        // 2. å‹•èƒ½é¢ (Momentum/RSI) - 15åˆ†
        score += 15; breakdown.rsi = true; // ç°¡åŒ–ï¼šæ–¹å‘å°å³å¾—åˆ†

        // 3. åŠ›åº¦é¢ (ADX) - 15åˆ†
        if (data.adx > 20) { score += 15; breakdown.adx = true; }

        // 4. è³‡é‡‘é¢ (Vol) - 15åˆ†
        if (data.vol > 1.0 || data.h1Vol > 1.0) { score += 15; breakdown.vol = true; }

        // 5. ä½ç½®é¢ (Location/Bias) - 20åˆ†
        if (!data.biasWarn && parseFloat(data.rr) >= 1.5) { 
            score += 20; breakdown.loc = true; 
        } else {
            score -= 10; // æ‡²ç½°æ©Ÿåˆ¶
        }

        // 6. çµæ§‹é¢ (Structure/4H) - 15åˆ†
        if (data.h4Dir === d15) { score += 15; breakdown.str = true; }

        let tier = 'B';
        if (score >= 80) tier = 'S';
        else if (score >= 60) tier = 'A';

        // é¡¯ç¤ºåˆ†æ•¸ç´°ç¯€
        const sBox = document.getElementById(`score-${sym}`);
        sBox.innerHTML = `
            <div class="score-title"><span>è©•åˆ†ç´°ç¯€</span><span class="${tier==='S'?'pass':'fail'}">${score}åˆ†</span></div>
            <div class="score-grid">
                <div class="score-item">è¶¨å‹¢ ${breakdown.trend?'âœ…':'âŒ'}</div>
                <div class="score-item">åŠ›åº¦ ${breakdown.adx?'âœ…':'âŒ'}</div>
                <div class="score-item">è³‡é‡‘ ${breakdown.vol?'âœ…':'âŒ'}</div>
                <div class="score-item">ä½ç½® ${breakdown.loc?'âœ…':'âš ï¸'}</div>
            </div>
        `;

        updateCardStyle(card, tier, d15);
        const badge = document.getElementById(`tier-${sym}`);
        badge.innerText = `${tier}ç´š`;
        badge.className = `tier-badge tier-${tier.toLowerCase()}`;
        badge.style.display = 'inline-block';

        return { tier, dir: d15, score, breakdown };
    }

    function updateCardStyle(card, tier, dir) {
        if (tier === 'S' || tier === 'A') {
            if (dir === 'long') {
                card.style.border = "2px solid var(--green)";
                card.style.boxShadow = "0 0 15px rgba(14, 203, 129, 0.2)";
            } else if (dir === 'short') {
                card.style.border = "2px solid var(--red)";
                card.style.boxShadow = "0 0 15px rgba(246, 70, 93, 0.2)";
            }
        } else {
            card.style.border = "1px solid var(--border)";
            card.style.boxShadow = "none";
        }
    }

    function createCard(sym) {
        const div = document.createElement('div');
        div.className = 'coin-card';
        div.id = `card-${sym}`;
        div.innerHTML = `
            <div class="card-header">
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="sym-title">${sym.replace('USDT','')}</span>
                    <span class="tier-badge" id="tier-${sym}"></span>
                </div>
                <div class="sym-price" id="price-${sym}">--.--</div>
            </div>
            <div class="card-body">
                <div class="col-section">
                    <div class="score-box" id="score-${sym}"></div>
                    <div class="info-group">
                        <div class="info-label"><span>é‡èƒ½ (1H)</span><span>>1.0</span></div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="vol-val-${sym}" style="color:#fff; font-family:'Roboto Mono'; font-weight:bold;">x--</span>
                            <span id="vol-tag-${sym}" class="vol-tag v-norm">...</span>
                        </div>
                    </div>
                    <div class="ai-action-area" id="ai-action-${sym}"></div>
                </div>
                ${['15m','1h','4h'].map(tf => `
                    <div class="col-section">
                        <div class="sect-title">${tf}</div>
                        <div class="wr-bar-bg"><div class="wr-l" id="wr-l-${sym}-${tf}" style="width:50%"></div><div class="wr-s" id="wr-s-${sym}-${tf}" style="width:50%"></div></div>
                        <div style="display:flex; flex-direction:column; gap:2px; margin-top:8px;">
                            ${genInd(sym, tf, 'RSI')}
                            ${genInd(sym, tf, 'EMA(50)')}
                            <div class="ind-row" style="border-top:1px dashed #444; margin-top:4px; padding-top:4px;">
                                <span class="ind-name">ADX</span><span class="ind-val" id="adx-${sym}-${tf}">--</span>
                            </div>
                        </div>
                        <div class="strat-box" id="sb-${sym}-${tf}">
                            <div class="strat-status">è§€æœ›</div>
                            <div class="six-grid">
                                <div class="sg-cell"><span class="sg-label">En</span><span class="sg-val" id="en-${sym}-${tf}">-</span></div>
                                <div class="sg-cell"><span class="sg-label">SL</span><span class="sg-val" id="sl-${sym}-${tf}" style="color:var(--blue);">-</span></div>
                                <div class="sg-cell"><span class="sg-label">TP2</span><span class="sg-val" id="tp2-${sym}-${tf}">-</span></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('grid-container').appendChild(div);
    }

    function genInd(s, t, n) { return `<div class="ind-row"><span class="ind-name">${n}</span><span class="ind-val" id="ind-${s}-${t}-${n.replace(/[^a-zA-Z0-9]/g,'')}">--</span></div>`; }
    let wss = null;
    function connectWSS(s) { if(wss) wss.close(); wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${s.map(x=>`${x.toLowerCase()}@ticker`).join('/')}`); wss.onmessage = e => { const d = JSON.parse(e.data).data; const el = document.getElementById(`price-${d.s}`); if(el) { el.innerText = parseFloat(d.c); el.className = `sym-price ${parseFloat(d.P)>=0?'up':'down'}`; } }; }
    function testDiscord() { if(CONFIG.DISCORD_WEBHOOK.includes("YOUR")) { alert("è«‹å…ˆå¡«å¯« Webhook!"); return; } DISCORD_BOT.sendWebhook('TEST-USDT', 'S', 'long', {entry:100, sl:95, tp2:110, adx:30, vol:1.5, totalScore: 95, rr: 2.5, scores:{trend:1, rsi:1, adx:1, vol:1, loc:1, str:1}}, null); alert("å·²ç™¼é€"); }
    function forceRefresh(){ scanMarket(); }
    initSystem();
</script>
</body>
</html>
