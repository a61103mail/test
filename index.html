<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V57 æ¥µé€ŸAIç‰ˆ)</title>
    <style>
        /* =========================================
           V57 æ¨£å¼ï¼šå¯¬ç‰ˆä½ˆå±€ + AI è¦–çª—
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d; --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535; --yellow-bg: rgba(252, 213, 53, 0.1);
            --gold: #ffd700; --gold-bg: rgba(255, 215, 0, 0.25);
            --silver: #e0e0e0; --silver-bg: rgba(224, 224, 224, 0.15);
            --bronze: #ffad5e; --bronze-bg: rgba(255, 173, 94, 0.15);
            --purple: #bf5af2; --purple-bg: rgba(191, 90, 242, 0.2);
            --border: #2b3139;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', sans-serif; margin: 0; padding: 15px; font-size: 13px; }

        /* Header */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }
        .btc-bar { background: #1e2329; padding: 6px 12px; border-radius: 4px; border-left: 4px solid var(--yellow); font-size: 11px; display: flex; gap: 15px; align-items: center; }
        .status-txt { color: #888; font-family: monospace; }

        /* Grid Layout - å¼·åˆ¶å¯¬ç‰ˆ */
        #grid-container { 
            display: grid; 
            /* é—œéµä¿®æ”¹ï¼šæœ€å°å¯¬åº¦è¨­ç‚º 450pxï¼Œç¢ºä¿æ©«å‘ä¸è¢«åˆ‡æ–· */
            grid-template-columns: repeat(auto-fill, minmax(460px, 1fr)); 
            gap: 15px; 
        }

        /* Card */
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; position: relative; }
        .card-header { padding: 10px 15px; background: #1e2329; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        
        .ch-left { display: flex; align-items: center; gap: 10px; }
        .sym-name { font-size: 18px; font-weight: 900; color: #fff; width: 80px; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 16px; width: 100px; }
        .up { color: var(--green); } .down { color: var(--red); }
        
        /* Badges */
        .tier-badge { font-size: 12px; padding: 2px 8px; border-radius: 4px; font-weight: bold; display: none; }
        .tier-s { background: var(--gold-bg); color: var(--gold); border: 1px solid var(--gold); box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
        .tier-a { background: var(--silver-bg); color: var(--silver); border: 1px solid var(--silver); }
        .tier-b { background: var(--bronze-bg); color: var(--bronze); border: 1px solid var(--bronze); }
        .tier-z { background: #333; color: #666; border: 1px dashed #555; }

        /* Card Body */
        .card-body { padding: 10px; display: grid; grid-template-columns: 120px 1fr 1fr 1fr; gap: 8px; }
        
        /* Info Column */
        .col-info { display: flex; flex-direction: column; gap: 5px; font-size: 11px; border-right: 1px dashed #333; padding-right: 5px; }
        .col-tf { display: flex; flex-direction: column; border-right: 1px dashed #333; padding: 0 5px; }
        .col-tf:last-child { border-right: none; }
        .tf-header { font-weight: bold; color: #fff; border-bottom: 1px solid #333; margin-bottom: 5px; text-align: center; }

        /* Indicators */
        .ind-row { display: flex; justify-content: space-between; margin-bottom: 2px; }
        .ind-val { font-weight: bold; font-family: 'Roboto Mono'; }

        /* Volume & Flow */
        .vol-tag { padding: 1px 4px; border-radius: 2px; font-weight: bold; font-size: 10px; display: inline-block; }
        .v-high { background: var(--yellow); color: #000; }
        .flow-bar { width: 100%; height: 4px; background: #333; display: flex; margin-top: 2px; }
        .fb { background: var(--green); height: 100%; } .fs { background: var(--red); height: 100%; }

        /* Strategy Box (å…­å®®æ ¼) */
        .strat-box { margin-top: auto; padding: 4px; border-radius: 4px; border: 1px solid #333; background: #131313; text-align: center; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 10px; text-align: left; margin-top: 4px; }
        .sg-row { display: flex; justify-content: space-between; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; }

        /* AI Window */
        .ai-window { 
            grid-column: 1 / -1; /* ä½”æ»¿æ•´è¡Œ */
            background: rgba(30, 30, 40, 0.6); 
            border: 1px solid var(--purple); 
            border-radius: 6px; 
            padding: 8px; 
            margin-top: 5px; 
            font-size: 11px; 
            display: none; /* é è¨­éš±è— */
        }
        .ai-header { color: var(--purple); font-weight: bold; display: flex; justify-content: space-between; margin-bottom: 4px; }
        .ai-content { color: #ccc; line-height: 1.4; white-space: pre-wrap; }
        .ai-loading { color: #888; font-style: italic; animation: blink 1.5s infinite; }
        @keyframes blink { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0; font-size:20px;">å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span style="font-size:12px; color:var(--yellow); border:1px solid var(--yellow); padding:2px 5px; border-radius:3px;">V57 AI COMMANDER</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC: <strong id="btc-trend">...</strong></span>
        <span>ç‹€æ…‹: <span id="sys-status" class="status-txt">å¾…å‘½</span></span>
        <button onclick="forceRefresh()" style="background:#333; color:#fff; border:1px solid #555; padding:2px 8px; cursor:pointer;">åˆ·æ–°</button>
    </div>
</div>

<div id="grid-container"></div>

<script>
    // ==========================================
    // âš™ï¸ ç”¨æˆ¶è¨­å®š (è«‹å¡«å¯«)
    // ==========================================
    const CONFIG = {
        DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1466716088883609771/9sk3XpiVkY-adf3BoZsaTKKkOXxoS3CbtKqepWEuZDjAJcLqFMoTlSRlaWo6IvqUgCHN", // å¿…å¡«
        GEMINI_API_KEY: "AIzaSyA25pohyXDcRWPFr7N7ohvPu-lMzP0iK3Q",       // å¿…å¡« (Google AI Studio)
        LIMIT: 500,
        BLACKLIST: ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'DAIUSDT']
    };

    // ==========================================
    // ğŸ§  Gemini AI æ¨¡çµ„
    // ==========================================
    const AI_AGENT = {
        queue: [],
        processing: false,
        
        // åŠ å…¥åˆ†æéšŠåˆ— (é¿å…åŒæ™‚ç™¼é€å¤ªå¤šè«‹æ±‚)
        analyze: async function(sym, tier, direction, data) {
            // åªåˆ†æ B ç´šä»¥ä¸Š
            if(tier !== 'S' && tier !== 'A' && tier !== 'B') return;
            
            // UI é¡¯ç¤º Loading
            const aiBox = document.getElementById(`ai-box-${sym}`);
            if(aiBox) {
                aiBox.style.display = 'block';
                aiBox.querySelector('.ai-content').innerHTML = '<span class="ai-loading">AI æ­£åœ¨è®€å–æˆ°è¡“æ•¸æ“š...</span>';
            }

            this.queue.push({ sym, tier, direction, data });
            this.process();
        },

        process: async function() {
            if(this.processing || this.queue.length === 0) return;
            this.processing = true;

            const job = this.queue.shift();
            try {
                const result = await this.callGemini(job.sym, job.direction, job.data);
                this.updateUI(job.sym, result);
                this.sendToDiscord(job, result);
            } catch(e) {
                console.error("AI Error:", e);
                const aiBox = document.getElementById(`ai-box-${job.sym}`);
                if(aiBox) aiBox.querySelector('.ai-content').innerText = "AI é€£ç·šå¤±æ•—";
            }

            this.processing = false;
            // ä¼‘æ¯ 2 ç§’å†è™•ç†ä¸‹ä¸€å€‹ï¼Œé¿å… Rate Limit
            setTimeout(() => this.process(), 2000); 
        },

        callGemini: async function(sym, dir, d) {
            if(!CONFIG.GEMINI_API_KEY) return { text: "æœªè¨­å®š API Key", conf: 0 };

            const prompt = `
            ä½ æ˜¯åŠ å¯†è²¨å¹£æˆ°è¡“æŒ‡æ®å®˜ã€‚åˆ†æ ${sym} (${dir === 'long' ? 'åšå¤š' : 'åšç©º'})ã€‚
            æ•¸æ“š: 
            - 15m RSI: ${d.rsi.toFixed(1)}
            - ADX: ${d.adx.toFixed(1)}
            - æˆäº¤é‡å€æ•¸: x${d.volRatio.toFixed(1)}
            - BBå¯¬åº¦: ${(d.bbW*100).toFixed(1)}%
            
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œç°¡çŸ­çµ¦å‡º 1 å¥æˆ°è¡“è©•èª (ä¾‹å¦‚ï¼šé‡èƒ½é…åˆçªç ´ï¼Œå‹ç‡æ¥µé«˜)ï¼Œä¸¦çµ¦å‡ºä¿¡å¿ƒæŒ‡æ•¸ (1-100)ã€‚
            æ ¼å¼: [ä¿¡å¿ƒæŒ‡æ•¸] è©•èª
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            
            const json = await response.json();
            const text = json.candidates[0].content.parts[0].text.trim();
            return { raw: text };
        },

        updateUI: function(sym, result) {
            const aiBox = document.getElementById(`ai-box-${sym}`);
            if(!aiBox) return;
            // å˜—è©¦è§£ææ ¼å¼ï¼Œè‹¥å¤±æ•—å‰‡ç›´æ¥é¡¯ç¤º
            aiBox.querySelector('.ai-content').innerText = result.raw;
        },

        sendToDiscord: function(job, result) {
            if(!CONFIG.DISCORD_WEBHOOK) return;
            
            // ç°¡å–®é˜²é‡ç™¼æ©Ÿåˆ¶ (å¯é¸)
            // ...

            const color = job.direction === 'long' ? 5763719 : 15548997;
            const payload = {
                username: "V57 AI æŒ‡æ®å®˜",
                embeds: [{
                    title: `ğŸ¤– AI åˆ†æ: ${job.sym} [${job.tier}ç´š]`,
                    description: `**${job.direction.toUpperCase()}**\n\n${result.raw}`,
                    color: color,
                    fields: [
                        { name: "ç¾åƒ¹", value: String(job.data.price), inline: true },
                        { name: "ADX", value: job.data.adx.toFixed(1), inline: true },
                        { name: "Vol", value: `x${job.data.volRatio.toFixed(1)}`, inline: true }
                    ],
                    footer: { text: "V57 Gemini Integration" },
                    timestamp: new Date().toISOString()
                }]
            };

            fetch(CONFIG.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).catch(e => console.error(e));
        }
    };

    // ==========================================
    // ğŸš€ æ ¸å¿ƒï¼šéåŒæ­¥ä¸¦è¡Œè™•ç† (Async Parallel)
    // ==========================================
    let activeSymbols = new Set();
    let btcTrendMultiplier = 1.0;

    async function initSystem() {
        log("å•Ÿå‹•ä¸¦è¡Œå¼•æ“...");
        await checkBTC();
        await updateMarket(); // ç¬¬ä¸€æ¬¡åŸ·è¡Œ
        
        // 1åˆ†é˜åˆ·æ–°ä¸€æ¬¡
        setInterval(updateMarket, 60 * 1000); 
    }

    async function updateMarket() {
        log("æƒæå¸‚å ´å‰10å...");
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const data = await res.json();
            
            let pairs = data.filter(t => t.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(t.symbol));
            pairs.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
            const top10 = pairs.slice(0, 10).map(t => t.symbol);

            // Diffing
            const newSet = new Set(top10);
            for(let s of activeSymbols) if(!newSet.has(s)) removeCard(s);
            for(let s of newSet) if(!activeSymbols.has(s)) createCard(s);
            activeSymbols = newSet;

            // ğŸ”¥ é—œéµï¼šä¸¦è¡Œè«‹æ±‚ (Parallel Fetching)
            // ä½¿ç”¨ Promise.all ä¸€æ¬¡ç™¼å°„æ‰€æœ‰ K ç·šè«‹æ±‚
            log("æ­£åœ¨ä¸¦è¡Œä¸‹è¼‰æ•¸æ“š...");
            const tasks = Array.from(activeSymbols).map(sym => loadSymbolData(sym));
            await Promise.all(tasks);
            
            log("æ•¸æ“šåŒæ­¥å®Œæˆï¼Œé€£æ¥ WebSocket");
            connectWSS(Array.from(activeSymbols));

        } catch(e) {
            log("API éŒ¯èª¤ (è«‹æª¢æŸ¥ CORS): " + e.message);
        }
    }

    // å–®å€‹å¹£ç¨®ï¼šä¸¦è¡ŒæŠ“å– 15m, 1h, 4h
    async function loadSymbolData(sym) {
        // åŒæ™‚ç™¼å‡º 3 å€‹è«‹æ±‚ï¼Œä¸ç­‰ç¬¬ä¸€å€‹å›ä¾†æ‰ç™¼ç¬¬äºŒå€‹
        const intervals = ['15m', '1h', '4h'];
        const requests = intervals.map(tf => 
            fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=${CONFIG.LIMIT}`)
                .then(r => r.json())
                .then(klines => ({ tf, klines }))
        );

        // æŠ“è³‡é‡‘è²»ç‡ (é€™æ¯”è¼ƒå¿«ï¼Œå¯ä»¥ç¨ç«‹)
        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`)
            .then(r => r.json())
            .then(d => {
                const fr = parseFloat(d.lastFundingRate)*100;
                const el = document.getElementById(`fr-${sym}`);
                if(el) { 
                    el.innerText = `è³‡${fr.toFixed(3)}%`; 
                    el.style.color = fr > 0.01 ? 'var(--red)' : (fr < -0.01 ? 'var(--green)' : '#666');
                }
            });

        // ç­‰å¾… 3 å€‹ K ç·šéƒ½å›ä¾†
        try {
            const results = await Promise.all(requests);
            let analysisData = {}; // å„²å­˜ä¾› AI ä½¿ç”¨çš„æ•¸æ“š
            
            results.forEach(({ tf, klines }) => {
                const data = processTimeframe(sym, tf, klines);
                if(tf === '1h') analysisData = { ...analysisData, ...data }; // æ”¶é›† 1H æ•¸æ“š
                if(tf === '15m') analysisData = { ...analysisData, rsi: data.rsi }; // æ”¶é›† 15m RSI
            });

            // ç¶œåˆåˆ¤æ–· Tier
            const tier = evaluateTier(sym);
            const direction = getDirection(sym);
            
            // è§¸ç™¼ AI
            if(tier && direction && analysisData) {
                AI_AGENT.analyze(sym, tier, direction, analysisData);
            }

        } catch(e) {
            console.error(`Error loading ${sym}`, e);
        }
    }

    // ==========================================
    // ğŸ§® æ•¸å­¸èˆ‡æŒ‡æ¨™è¨ˆç®—
    // ==========================================
    function processTimeframe(sym, tf, klines) {
        const c = klines.map(d=>parseFloat(d[4]));
        const h = klines.map(d=>parseFloat(d[2]));
        const l = klines.map(d=>parseFloat(d[3]));
        const v = klines.map(d=>parseFloat(d[5]));
        const last = c.length - 1;
        const price = c[last];

        // è¨ˆç®—æŒ‡æ¨™ (ç°¡æ˜“ç‰ˆ)
        const rsi = calcRSI(c);
        const bb = calcBB(c);
        const ema50 = calcEMA(c, 50);
        const adx = calcADX(h, l, c);

        // æ›´æ–° UI
        updateIndUI(sym, tf, { rsi, bb, ema: ema50[last], price });

        // 1H ç‰¹æ®Šè™•ç†ï¼šé‡èƒ½èˆ‡è³‡é‡‘æµ
        let volRatio = 1;
        if(tf === '1h') {
            const smaV = v.slice(-21, -1).reduce((a,b)=>a+b,0)/20;
            volRatio = v[last] / smaV;
            updateVolUI(sym, volRatio, klines[last]);
        }

        // æˆ°è¡“æ ¼è¨ˆç®—
        const atr = (Math.max(h[last]-l[last], Math.abs(h[last]-c[last-1]), Math.abs(l[last]-c[last-1])));
        updateStratBox(sym, tf, price, atr, rsi, ema50[last], adx);

        // å­˜å…¥ DOM å±¬æ€§ä»¥ä¾¿å¾ŒçºŒè®€å–
        const card = document.getElementById(`card-${sym}`);
        if(!card.dataset.stats) card.dataset.stats = "{}";
        const stats = JSON.parse(card.dataset.stats);
        stats[tf] = { dir: (rsi>55 && price>ema50[last]) ? 'long' : (rsi<45 && price<ema50[last]) ? 'short' : 'wait' };
        card.dataset.stats = JSON.stringify(stats);

        return { rsi, adx, volRatio, bbW: bb.width, price };
    }

    function updateStratBox(sym, tf, price, atr, rsi, ema, adx) {
        const box = document.getElementById(`sb-${sym}-${tf}`);
        if(!box) return;

        let dir = 'wait';
        if(rsi > 55 && price > ema && adx > 20) dir = 'long';
        else if(rsi < 45 && price < ema && adx > 20) dir = 'short';

        const p = v => v.toFixed(price<1?4:2);

        if(dir === 'long') {
            box.className = 'strat-box strat-long';
            box.querySelector('.st-t').innerText = "å»ºè­°åšå¤š";
            document.getElementById(`sl-${sym}-${tf}`).innerText = p(price - atr*1.5);
            document.getElementById(`tp-${sym}-${tf}`).innerText = p(price + atr*2);
            document.getElementById(`kl-${sym}-${tf}`).innerText = "15%";
        } else if(dir === 'short') {
            box.className = 'strat-box strat-short';
            box.querySelector('.st-t').innerText = "å»ºè­°åšç©º";
            document.getElementById(`sl-${sym}-${tf}`).innerText = p(price + atr*1.5);
            document.getElementById(`tp-${sym}-${tf}`).innerText = p(price - atr*2);
            document.getElementById(`kl-${sym}-${tf}`).innerText = "15%";
        } else {
            box.className = 'strat-box';
            box.querySelector('.st-t').innerText = "è§€æœ›";
        }
    }

    function evaluateTier(sym) {
        const card = document.getElementById(`card-${sym}`);
        const stats = JSON.parse(card.dataset.stats || "{}");
        if(!stats['15m'] || !stats['1h'] || !stats['4h']) return null;

        const d15 = stats['15m'].dir;
        const d1h = stats['1h'].dir;
        const d4h = stats['4h'].dir;

        let tier = '';
        if(d15 !== 'wait' && d15 === d1h && d1h === d4h) tier = 'S';
        else if(d15 !== 'wait' && d15 === d1h) tier = 'A';
        else if(d15 !== 'wait') tier = 'B';
        
        const badge = document.getElementById(`tier-${sym}`);
        if(tier) {
            badge.className = `tier-badge tier-${tier.toLowerCase()}`;
            badge.innerText = `${tier}ç´š`;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }
        return tier;
    }

    function getDirection(sym) {
         const card = document.getElementById(`card-${sym}`);
         const stats = JSON.parse(card.dataset.stats || "{}");
         return stats['15m'] ? stats['15m'].dir : null;
    }

    // ==========================================
    // ğŸ› ï¸ è¼”åŠ©èˆ‡ UI å‡½æ•¸
    // ==========================================
    function createCard(sym) {
        const div = document.createElement('div');
        div.className = 'coin-card';
        div.id = `card-${sym}`;
        div.innerHTML = `
            <div class="card-header">
                <div class="ch-left">
                    <span class="sym-name">${sym.replace('USDT','')}</span>
                    <span class="tier-badge" id="tier-${sym}"></span>
                </div>
                <div class="ch-right">
                    <span class="sym-price" id="price-${sym}">--.--</span>
                </div>
            </div>
            <div class="ai-window" id="ai-box-${sym}">
                <div class="ai-header"><span>ğŸ¤– AI æˆ°è¡“åˆ†æ</span><span style="font-size:9px;">Gemini Flash</span></div>
                <div class="ai-content">...</div>
            </div>
            <div class="card-body">
                <div class="col-info">
                    <div style="font-weight:bold;">1H é‡èƒ½</div>
                    <div><span id="vr-${sym}" style="color:#aaa;">--</span> <span id="vt-${sym}" class="vol-tag"></span></div>
                    <div class="flow-bar"><div class="fb" id="fb-${sym}" style="width:50%"></div><div class="fs" id="fs-${sym}" style="width:50%"></div></div>
                    <div style="margin-top:auto;" id="fr-${sym}">--</div>
                </div>
                ${['15m','1h','4h'].map(tf => `
                    <div class="col-tf">
                        <div class="tf-header">${tf}</div>
                        <div class="ind-row"><span>RSI</span><span class="ind-val" id="rsi-${sym}-${tf}">--</span></div>
                        <div class="ind-row"><span>EMA</span><span class="ind-val" id="ema-${sym}-${tf}">--</span></div>
                        <div class="ind-row"><span>BB</span><span class="ind-val" id="bb-${sym}-${tf}">--</span></div>
                        
                        <div class="strat-box" id="sb-${sym}-${tf}">
                            <div class="st-t" style="font-weight:bold; margin-bottom:2px; font-size:11px;">è§€æœ›</div>
                            <div class="strat-grid">
                                <div class="sg-row"><span>SL</span><span class="sg-val" id="sl-${sym}-${tf}">-</span></div>
                                <div class="sg-row"><span>TP</span><span class="sg-val" id="tp-${sym}-${tf}">-</span></div>
                                <div class="sg-row"><span>K%</span><span class="sg-val" id="kl-${sym}-${tf}">-</span></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        document.getElementById('grid-container').appendChild(div);
    }

    function removeCard(sym) {
        const el = document.getElementById(`card-${sym}`);
        if(el) el.remove();
    }

    function updateIndUI(sym, tf, data) {
        const rsiEl = document.getElementById(`rsi-${sym}-${tf}`);
        rsiEl.innerText = data.rsi.toFixed(1);
        rsiEl.style.color = data.rsi > 60 ? 'var(--red)' : (data.rsi < 40 ? 'var(--green)' : '#aaa');

        const emaEl = document.getElementById(`ema-${sym}-${tf}`);
        emaEl.innerText = data.price > data.ema ? 'ä¹‹ä¸Š' : 'ä¹‹ä¸‹';
        emaEl.style.color = data.price > data.ema ? 'var(--green)' : 'var(--red)';
        
        const bbEl = document.getElementById(`bb-${sym}-${tf}`);
        bbEl.innerText = (data.bb.width*100).toFixed(1)+'%';
    }

    function updateVolUI(sym, r, kline) {
        document.getElementById(`vr-${sym}`).innerText = `x${r.toFixed(1)}`;
        const tag = document.getElementById(`vt-${sym}`);
        if(r > 2) { tag.innerText = "çˆ†é‡"; tag.className = "vol-tag v-high"; }
        else if(r < 0.6) { tag.innerText = "ç¸®é‡"; tag.className = "vol-tag"; tag.style.background = "#333"; }
        else { tag.innerText = "æ­£å¸¸"; tag.className = "vol-tag"; tag.style.background = "#444"; }

        const buy = parseFloat(kline[9]);
        const total = parseFloat(kline[5]);
        const bPct = (buy/total)*100;
        document.getElementById(`fb-${sym}`).style.width = `${bPct}%`;
        document.getElementById(`fs-${sym}`).style.width = `${100-bPct}%`;
    }

    function log(msg) {
        document.getElementById('sys-status').innerText = msg;
    }

    // æ•¸å­¸å…¬å¼
    function calcRSI(c) {
        let gains=0, losses=0;
        for(let i=c.length-14; i<c.length; i++){ let d=c[i]-c[i-1]; d>0?gains+=d:losses-=d; }
        return 100 - (100/(1+(gains/losses)));
    }
    function calcEMA(c, p) {
        let k=2/(p+1), e=[c[0]];
        for(let i=1;i<c.length;i++) e.push(c[i]*k+e[i-1]*(1-k));
        return e;
    }
    function calcBB(c) {
        const s=c.slice(-20).reduce((a,b)=>a+b,0)/20;
        const dev=Math.sqrt(c.slice(-20).map(x=>Math.pow(x-s,2)).reduce((a,b)=>a+b,0)/20);
        return { width: (4*dev)/s };
    }
    function calcADX(h,l,c) { return 30; /* ç°¡åŒ–ç¤ºæ„ï¼Œéœ€å®Œæ•´å…¬å¼ */ }

    // WebSocket
    let wss = null;
    function connectWSS(symbols) {
        if(wss) wss.close();
        const streams = symbols.map(s => `${s.toLowerCase()}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = e => {
            const d = JSON.parse(e.data).data;
            const el = document.getElementById(`price-${d.s}`);
            if(el) {
                const old = parseFloat(el.innerText);
                const now = parseFloat(d.c);
                el.innerText = now;
                el.className = `sym-price ${now>=old?'up':'down'}`;
            }
        };
    }
    
    async function checkBTC() {
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=2');
            const d = await r.json();
            const change = (parseFloat(d[1][4]) - parseFloat(d[0][4])) / parseFloat(d[0][4]);
            const el = document.getElementById('btc-trend');
            el.innerText = change > 0 ? "ğŸ“ˆ ä¸Šæ¼²" : "ğŸ“‰ ä¸‹è·Œ";
            el.style.color = change > 0 ? "var(--green)" : "var(--red)";
        } catch(e) {}
    }

    function forceRefresh() { updateMarket(); }

    initSystem();
</script>
</body>
</html>
