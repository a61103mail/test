<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V22 æ‘ºç–Šç‰ˆ)</title>
    <style>
        :root {
            --bg: #0b0e11;
            --card: #161a1e;
            --text-main: #eaecef;
            --text-sub: #848e9c;
            --green: #0ecb81;
            --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d;
            --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535;
            --yellow-bg: rgba(252, 213, 53, 0.1);
            --border: #2b3139;
            --modal-bg: #1e2329;
            --header-hover: #20252b;
        }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 13px;
        }
        
        /* é ‚éƒ¨æ§åˆ¶åˆ— */
        .header {
            border-bottom: 2px solid var(--border);
            padding-bottom: 15px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn-filter {
            background: #2b3139; color: #fff; border: 1px solid #444;
            padding: 8px 16px; border-radius: 4px; cursor: pointer;
            font-weight: bold; display: flex; align-items: center; gap: 5px;
        }

        /* --- å¡ç‰‡æ ¸å¿ƒæ¨£å¼ (é‡é»ä¿®æ”¹) --- */
        .coin-card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 10px;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        /* 1. å¡ç‰‡é ­éƒ¨ (æ”¶åˆæ™‚é¡¯ç¤º) */
        .card-header {
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            background: #1e2329;
            border-bottom: 1px solid transparent; /* é ç•™é‚Šæ¡† */
        }
        .card-header:hover { background: var(--header-hover); }
        
        /* å·¦å´ï¼šå¹£åèˆ‡åƒ¹æ ¼ */
        .ch-left { display: flex; align-items: center; gap: 10px; }
        .sym-name { font-size: 16px; font-weight: 900; color: #fff; width: 80px; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 15px; width: 80px; }
        .up { color: var(--green); } .down { color: var(--red); }

        /* å³å´ï¼š15m è¨Šè™Ÿæ‘˜è¦ */
        .ch-right { display: flex; align-items: center; gap: 10px; }
        .signal-badge {
            font-size: 12px; padding: 3px 8px; border-radius: 4px; font-weight: bold;
            min-width: 80px; text-align: center;
        }
        .sb-long { background: var(--green-bg); color: var(--green); border: 1px solid var(--green); }
        .sb-short { background: var(--red-bg); color: var(--red); border: 1px solid var(--red); }
        .sb-chop { background: var(--yellow-bg); color: var(--yellow); border: 1px dashed var(--yellow); }
        .sb-wait { background: #333; color: #888; border: 1px solid #555; }
        
        .arrow-icon { font-size: 10px; color: #666; transition: transform 0.3s; }
        
        /* å±•é–‹ç‹€æ…‹æ¨£å¼ */
        .coin-card.expanded { border-color: #555; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .coin-card.expanded .card-header { border-bottom: 1px solid var(--border); background: #252a30; }
        .coin-card.expanded .arrow-icon { transform: rotate(180deg); }
        .coin-card.expanded .card-body { display: grid; } /* å±•é–‹æ™‚é¡¯ç¤º */

        /* 2. å¡ç‰‡å…§å®¹ (å±•é–‹å¾Œé¡¯ç¤º - æ²¿ç”¨ V20 çš„ Grid) */
        .card-body {
            display: none; /* é è¨­éš±è— */
            grid-template-columns: 200px 1fr 1fr 1fr;
            gap: 10px;
            padding: 10px;
            background: #111;
        }

        /* --- å…§éƒ¨çµ„ä»¶æ¨£å¼ (V20) --- */
        .col-info { padding: 10px; border-right: 1px dashed #333; }
        .vol-box, .flow-box { margin-top: 5px; padding-top: 5px; border-top: 1px dashed #333; font-size: 11px; }
        .flow-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; margin-bottom: 2px; }
        .flow-buy { height: 100%; background: var(--green); } .flow-sell { height: 100%; background: var(--red); }
        
        .col-tf { padding: 5px; border-right: 1px dashed #333; }
        .col-tf:last-child { border-right: none; }
        .tf-header { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; }
        .tf-title { font-weight: bold; font-size: 13px; color: #fff; }
        
        .ind-item { display: flex; justify-content: space-between; font-size: 11px; padding: 3px 5px; background: rgba(255,255,255,0.03); margin-bottom: 2px; border-radius: 3px; }
        .win-dual { font-family: 'Roboto Mono'; font-size: 10px; }
        .w-l { color: var(--green); opacity: 0.5; } .w-s { color: var(--red); opacity: 0.5; }
        .active-side { opacity: 1; font-weight: bold; text-decoration: underline; }

        .strat-box { margin-top: 8px; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid transparent; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .strat-chop { background: var(--yellow-bg); border-color: var(--yellow); border-style: dashed; color: var(--yellow); }
        .strat-wait { background: #2b3139; border-color: #444; color: #888; }
        .strat-title { font-weight: bold; display: block; margin-bottom: 4px; font-size: 12px;}
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px; text-align: left; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }
        .blur-text { filter: blur(4px); opacity: 0.5; }

        /* Modal & Loading (V20) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--modal-bg); width: 90%; max-width: 600px; max-height: 80vh; border-radius: 8px; border: 1px solid #444; display: flex; flex-direction: column; }
        .modal-body { padding: 15px; overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .coin-option { background: #0b0e11; padding: 8px; border-radius: 4px; border: 1px solid #333; cursor: pointer; text-align: center; font-family: 'Roboto Mono'; font-size: 12px; }
        .coin-option.selected { background: var(--green-bg); border-color: var(--green); color: var(--green); font-weight: bold; }
        .search-input { background: #0b0e11; border: 1px solid #444; color: #fff; padding: 8px; width: 90%; margin: 10px 5%; }
        .loading-text { text-align: center; color: #666; margin-top: 50px; font-size: 16px; }

        /* RWD */
        @media (max-width: 900px) {
            .card-body { grid-template-columns: 1fr; gap: 0; }
            .col-info { border-right: none; border-bottom: 1px solid var(--border); padding-bottom: 15px; margin-bottom: 10px; }
            .col-tf { border-right: none; border-bottom: 1px dashed #333; padding: 15px 5px; }
            .col-tf:last-child { border-bottom: none; }
        }
    </style>
</head>
<body>

<div class="modal-overlay" id="filterModal">
    <div class="modal-content">
        <div style="padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between;">
            <span style="font-weight:bold;">é¸æ“‡å¹£ç¨®</span>
            <span style="cursor:pointer;" onclick="closeModal()">âœ•</span>
        </div>
        <input type="text" class="search-input" id="coinSearch" placeholder="æœå°‹..." onkeyup="filterCoins()">
        <div class="modal-body" id="coinList">è¼‰å…¥ä¸­...</div>
        <div style="padding:15px; text-align:right; border-top:1px solid #333;">
            <button onclick="applyFilter()" style="background:var(--green); border:none; padding:8px 20px; border-radius:4px; font-weight:bold; cursor:pointer;">ç¢ºèª</button>
        </div>
    </div>
</div>

<div class="header">
    <div>
        <h1 style="margin:0; font-size:20px;">æˆ°æƒ…å®¤ V22 (æ‘ºç–Šç‰ˆ)</h1>
        <span style="color:#888; font-size:11px;">é è¨­Top10 | 15må¿«ç¯© | é»æ“Šå±•é–‹</span>
    </div>
    <button class="btn-filter" onclick="openModal()"><span>â•</span> ç¯©é¸</button>
</div>

<div id="grid-container">
    <div class="loading-text">æ­£åœ¨è¼‰å…¥ Top 10 å¹£ç¨®æ•¸æ“š...</div>
</div>

<script>
    const TFS = ['15m', '1h', '4h'];
    const LIMIT = 500; 
    const DEFAULT_COINS = ['btcusdt', 'ethusdt', 'solusdt', 'bnbusdt', 'xrpusdt', 'dogeusdt', 'adausdt', 'trxusdt', 'linkusdt', 'shibusdt'];
    const TRANS = { '15m': '15m (çŸ­)', '1h': '1H (æ³¢)', '4h': '4H (è¶¨)', 'RSI': 'RSI', 'EMA': 'EMA', 'MACD': 'MACD', 'VWAP': 'VWAP', 'BOLL': 'BOLL' };

    let allSymbols = []; 
    let activeSymbols = new Set(DEFAULT_COINS); 
    let wss = null; 
    let store = {}; 

    // --- System Start ---
    async function initSystem() {
        await applyFilter(false); 
        fetchExchangeInfo();
    }

    async function fetchExchangeInfo() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const data = await res.json();
            allSymbols = data.symbols.filter(s => s.quoteAsset === 'USDT' && s.contractType === 'PERPETUAL' && s.status === 'TRADING').map(s => s.symbol.replace('USDT', '')).sort();
        } catch (e) {}
    }

    // --- UI Logic ---
    function openModal() { renderCoinList(); document.getElementById('filterModal').style.display = 'flex'; }
    function closeModal() { document.getElementById('filterModal').style.display = 'none'; }
    function renderCoinList() {
        const container = document.getElementById('coinList'); container.innerHTML = '';
        allSymbols.forEach(sym => {
            const code = sym.toLowerCase() + 'usdt';
            const div = document.createElement('div');
            div.className = `coin-option ${activeSymbols.has(code) ? 'selected' : ''}`;
            div.textContent = sym; div.dataset.sym = code;
            div.onclick = () => div.classList.toggle('selected');
            container.appendChild(div);
        });
    }
    function filterCoins() {
        const txt = document.getElementById('coinSearch').value.toUpperCase();
        document.querySelectorAll('.coin-option').forEach(opt => opt.style.display = opt.textContent.includes(txt) ? 'block' : 'none');
    }

    async function applyFilter(fromModal = true) {
        let selected = [];
        if (fromModal) {
            selected = Array.from(document.querySelectorAll('.coin-option.selected')).map(el => el.dataset.sym);
            closeModal();
        } else { selected = Array.from(activeSymbols); }
        
        activeSymbols = new Set(selected);
        const container = document.getElementById('grid-container');
        container.innerHTML = ''; 

        if(selected.length === 0) { container.innerHTML = '<div class="loading-text">æœªé¸æ“‡å¹£ç¨®</div>'; if(wss) wss.close(); return; }
        if(wss) wss.close(); store = {}; 

        for (const sym of selected) {
            await initSymbol(sym);
            await new Promise(r => setTimeout(r, 100));
        }
        connectWSS(selected);
    }

    // --- Card Generation (New Structure) ---
    async function initSymbol(sym) {
        store[sym] = {}; 
        const container = document.getElementById('grid-container');
        if(container.querySelector('.loading-text')) container.innerHTML = '';

        // å¡ç‰‡çµæ§‹ï¼šHeader (å¯è¦‹) + Body (éš±è—)
        let html = `
        <div class="coin-card" id="card-${sym}">
            <div class="card-header" onclick="toggleCard('${sym}')">
                <div class="ch-left">
                    <span class="sym-name">${sym.toUpperCase().replace('USDT','')}</span>
                    <span class="sym-price" id="price-${sym}">--.--</span>
                </div>
                <div class="ch-right">
                    <span class="signal-badge sb-wait" id="badge-15m-${sym}">åˆ†æä¸­...</span>
                    <span class="arrow-icon">â–¼</span>
                </div>
            </div>

            <div class="card-body">
                <div class="col-info">
                    <div class="close-card" style="text-align:right; margin-bottom:5px; cursor:pointer; color:#666;" onclick="event.stopPropagation(); removeCard('${sym}')">ç§»é™¤ âœ•</div>
                    <div class="vol-box">
                        <div style="color:#aaa; display:flex; justify-content:space-between;"><span>é‡èƒ½(1H)</span><span id="vol-ratio-${sym}">x1.0</span></div>
                        <span id="vol-status-${sym}" class="vol-tag v-norm">...</span>
                    </div>
                    <div class="flow-box">
                        <div style="color:#aaa; margin-bottom:2px;">Taker(1H)</div>
                        <div class="flow-bar-bg"><div class="flow-buy" id="flow-b-${sym}" style="width:50%"></div><div class="flow-sell" id="flow-s-${sym}" style="width:50%"></div></div>
                        <div style="display:flex; justify-content:space-between; font-size:10px;"><span id="flow-bv-${sym}" style="color:var(--green)">--%</span><span id="flow-sv-${sym}" style="color:var(--red)">--%</span></div>
                    </div>
                </div>
        `;

        TFS.forEach(tf => {
            store[sym][tf] = {}; 
            html += `
            <div class="col-tf">
                <div class="tf-header"><span class="tf-title">${TRANS[tf]}</span></div>
                <div style="margin-bottom:5px;">
                    <div class="wr-bar-bg"><div class="wr-bar-long" id="bar-l-${sym}-${tf}" style="width:50%"></div><div class="wr-bar-short" id="bar-s-${sym}-${tf}" style="width:50%"></div></div>
                    <div class="wr-text"><span id="wr-l-${sym}-${tf}">å¤š--%</span><span id="wr-s-${sym}-${tf}">ç©º--%</span></div>
                </div>
                <div class="ind-list" id="list-${sym}-${tf}"><div style="color:#444;">ä¸‹è¼‰ä¸­...</div></div>
                <div class="strat-box strat-wait" id="strat-${sym}-${tf}">
                    <span class="strat-title" id="act-${sym}-${tf}">è§€æœ›</span>
                    <div class="strat-grid">
                        <div>Entry <span class="sg-val" id="en-${sym}-${tf}">---</span></div>
                        <div>SL <span class="sg-val" id="sl-${sym}-${tf}">---</span></div>
                        <div>TP1 <span class="sg-val" id="tp1-${sym}-${tf}">---</span></div>
                        <div>TP2 <span class="sg-val" id="tp2-${sym}-${tf}">---</span></div>
                    </div>
                </div>
            </div>`;
        });
        html += `</div></div>`; // End Body & Card
        container.insertAdjacentHTML('beforeend', html);

        // Fetch Data
        try {
            const promises = TFS.map(tf => fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym.toUpperCase()}&interval=${tf}&limit=${LIMIT}`).then(r=>r.json()));
            const results = await Promise.all(promises);
            results.forEach((data, i) => {
                const tf = TFS[i]; data.pop();
                processTimeframe(sym, tf, data);
                if(tf === '1h') { calculateFlow(sym, data); calculateVolume(sym, data); }
            });
        } catch(e) {}
    }

    // Toggle Card Function
    window.toggleCard = function(sym) {
        document.getElementById(`card-${sym}`).classList.toggle('expanded');
    };

    function removeCard(sym) {
        activeSymbols.delete(sym);
        document.getElementById(`card-${sym}`).remove();
    }

    // --- Math & Process ---
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        emaArray: (d, p) => { let k=2/(p+1), ema=[d[0]]; for(let i=1;i<d.length;i++) ema.push(d[i]*k+ema[i-1]*(1-k)); return ema; },
        rsiArray: (c) => { 
            let rsi=[], g=0, l=0; for(let i=1;i<=14;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/14, al=l/14; rsi[14]=100-(100/(1+ag/al));
            for(let i=15;i<c.length;i++){ let d=c[i]-c[i-1]; d>0?ag=(ag*13+d)/14:al=(al*13-d)/14; rsi[i]=al===0?100:100-(100/(1+ag/al)); }
            return rsi;
        },
        atr: (h,l,c,p=14) => { if(h.length<p)return 0; let trs=[]; for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]))); return trs.slice(-p).reduce((a,b)=>a+b,0)/p; },
        getWinRate: (s,c,t) => { let w=0, tot=0; for(let i=50;i<s.length-5;i++){ if(s[i]){ tot++; let e=c[i], x=c[i+5]; if((t=='long'&&x>e*1.001)||(t=='short'&&x<e*0.999)) w++; } } return tot===0?0:Math.round((w/tot)*100); }
    };

    function processTimeframe(sym, tf, klines) {
        const c = klines.map(d=>parseFloat(d[4])), h=klines.map(d=>parseFloat(d[2])), l=klines.map(d=>parseFloat(d[3]));
        const last=c.length-1, cur=c[last];
        const atr = MathEngine.atr(h,l,c);
        const rsi = MathEngine.rsiArray(c);
        const ema = MathEngine.emaArray(c, 50);
        const sma20=MathEngine.sma(c,20), std=Math.sqrt(c.slice(-20).map(x=>Math.pow(x-sma20,2)).reduce((a,b)=>a+b)/20);
        const upper=sma20+2*std, lower=sma20-2*std;
        
        // Signals
        const sigs={ r_b:[], r_s:[], e_b:[], e_s:[], b_b:[], b_s:[] };
        for(let i=50; i<=last; i++) {
            sigs.r_b[i]=rsi[i]<40; sigs.r_s[i]=rsi[i]>60;
            sigs.e_b[i]=c[i]>ema[i]; sigs.e_s[i]=c[i]<ema[i];
            sigs.b_b[i]=c[i]>upper[i]; sigs.b_s[i]=c[i]<lower[i];
        }
        
        const wrR = { l: MathEngine.getWinRate(sigs.r_b,c,'long'), s: MathEngine.getWinRate(sigs.r_s,c,'short') };
        const wrE = { l: MathEngine.getWinRate(sigs.e_b,c,'long'), s: MathEngine.getWinRate(sigs.e_s,c,'short') };
        const wrB = { l: MathEngine.getWinRate(sigs.b_b,c,'long'), s: MathEngine.getWinRate(sigs.b_s,c,'short') };

        // Render List
        const listEl = document.getElementById(`list-${sym}-${tf}`);
        let lW=0, sW=0, cnt=0;
        const addInd = (n,v,d,w) => {
            const lc=d=='l'?'active-side':'w-l', sc=d=='s'?'active-side':'w-s', col=d=='l'?'var(--green)':d=='s'?'var(--red)':'#666';
            if(w.l>0) lW+=w.l; if(w.s>0) sW+=w.s; cnt++;
            return `<div class="ind-item"><div style="color:#aaa;">${n} <span style="color:${col};font-weight:bold;">${v}</span></div><div class="win-dual"><span class="${lc}">å¤š${w.l}%</span>|<span class="${sc}">ç©º${w.s}%</span></div></div>`;
        };
        listEl.innerHTML = 
            addInd('RSI', rsi[last].toFixed(1), rsi[last]>55?'l':rsi[last]<45?'s':'n', wrR) +
            addInd('EMA', cur>ema[last]?'ä¸Š':'ä¸‹', cur>ema[last]?'l':'s', wrE) +
            addInd('BOLL', cur>upper?'ç ´':cur<lower?'ç ´':'å€', cur>upper?'l':cur<lower?'s':'n', wrB);

        const avgL=Math.round(lW/cnt), avgS=Math.round(sW/cnt);
        document.getElementById(`bar-l-${sym}-${tf}`).style.width = `${(avgL/(avgL+avgS))*100}%`;
        document.getElementById(`bar-s-${sym}-${tf}`).style.width = `${(avgS/(avgL+avgS))*100}%`;
        document.getElementById(`wr-l-${sym}-${tf}`).textContent = `å¤š${avgL}%`;
        document.getElementById(`wr-s-${sym}-${tf}`).textContent = `ç©º${avgS}%`;

        // Strategy
        const box = document.getElementById(`strat-${sym}-${tf}`);
        const title = document.getElementById(`act-${sym}-${tf}`);
        const f = v => v<10?v.toFixed(4):v.toFixed(2);
        
        let dec = 'wait';
        if(avgL>=53 && avgL>avgS) dec='long';
        else if(avgS>=53 && avgS>avgL) dec='short';
        else if(avgL<50 && avgS<50) dec='chop';

        // Update Card Header Badge (Only for 15m)
        if(tf === '15m') {
            const badge = document.getElementById(`badge-15m-${sym}`);
            if(dec==='long') { badge.className='signal-badge sb-long'; badge.textContent=`å»ºè­°åšå¤š (${avgL}%)`; }
            else if(dec==='short') { badge.className='signal-badge sb-short'; badge.textContent=`å»ºè­°åšç©º (${avgS}%)`; }
            else if(dec==='chop') { badge.className='signal-badge sb-chop'; badge.textContent='âš ï¸ ç›¤æ•´'; }
            else { badge.className='signal-badge sb-wait'; badge.textContent='è§€æœ›'; }
        }

        const vals = box.querySelectorAll('.sg-val');
        if(dec==='long') {
            box.className='strat-box strat-long'; title.innerHTML=`<span class="s-long">å»ºè­°åšå¤š (${avgL}%)</span>`;
            document.getElementById(`en-${sym}-${tf}`).textContent=f(cur);
            document.getElementById(`sl-${sym}-${tf}`).textContent=f(cur-atr*1.5);
            document.getElementById(`tp1-${sym}-${tf}`).textContent=f(cur+atr*1.2);
            document.getElementById(`tp2-${sym}-${tf}`).textContent=f(cur+atr*2.5);
            vals.forEach(e=>e.classList.remove('blur-text'));
        } else if(dec==='short') {
            box.className='strat-box strat-short'; title.innerHTML=`<span class="s-short">å»ºè­°åšç©º (${avgS}%)</span>`;
            document.getElementById(`en-${sym}-${tf}`).textContent=f(cur);
            document.getElementById(`sl-${sym}-${tf}`).textContent=f(cur+atr*1.5);
            document.getElementById(`tp1-${sym}-${tf}`).textContent=f(cur-atr*1.2);
            document.getElementById(`tp2-${sym}-${tf}`).textContent=f(cur-atr*2.5);
            vals.forEach(e=>e.classList.remove('blur-text'));
        } else if(dec==='chop') {
            box.className='strat-box strat-chop'; title.innerHTML=`<span class="s-chop">âš ï¸ ç›¤æ•´ (é›™æ®º)</span>`;
            vals.forEach(e=>e.classList.add('blur-text'));
        } else {
            box.className='strat-box strat-wait'; title.innerHTML=`<span>è§€æœ›</span>`;
            vals.forEach(e=>e.classList.remove('blur-text'));
        }
    }

    function calculateVolume(sym, klines) { /* Same as V20 */ 
        const len=klines.length, cur=parseFloat(klines[len-1][5]);
        let sum=0; for(let i=len-21;i<len-1;i++) sum+=parseFloat(klines[i][5]);
        const r=cur/(sum/20), el=document.getElementById(`vol-status-${sym}`);
        document.getElementById(`vol-ratio-${sym}`).textContent = `x${r.toFixed(1)}`;
        if(r>=2){el.textContent="ğŸ”¥ çˆ†é‡";el.className="vol-tag v-high";}
        else if(r>=1.2){el.textContent="ğŸ“ˆ æ”¾é‡";el.className="vol-tag v-norm";}
        else if(r<=0.6){el.textContent="ğŸ’¤ ç¸®é‡";el.className="vol-tag v-low";}
        else{el.textContent="âš–ï¸ æ­£å¸¸";el.className="vol-tag v-norm";}
    }
    function calculateFlow(sym, klines) { /* Same as V20 */
        const rec=klines.slice(-24); let t=0,b=0; rec.forEach(k=>{t+=parseFloat(k[5]);b+=parseFloat(k[9]);});
        const bp=(b/t)*100; 
        document.getElementById(`flow-b-${sym}`).style.width=`${bp}%`;
        document.getElementById(`flow-s-${sym}`).style.width=`${100-bp}%`;
        document.getElementById(`flow-bv-${sym}`).textContent=`è²·${bp.toFixed(0)}%`;
        document.getElementById(`flow-sv-${sym}`).textContent=`è³£${(100-bp).toFixed(0)}%`;
    }

    function connectWSS(symbols) {
        const streams = symbols.map(s => `${s}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const sym = msg.data.s.toLowerCase();
            const el = document.getElementById(`price-${sym}`);
            if(el) {
                el.textContent = parseFloat(msg.data.c);
                el.className = `sym-price ${parseFloat(msg.data.P)>=0?'up':'down'}`;
            }
        };
    }

    initSystem();
</script>
</body>
</html>
