<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V59 çµ‚æ¥µè³ ç½ªç‰ˆ)</title>
    <style>
        /* =========================================
           V59 æ¨£å¼è¡¨ï¼šå¯¬ç‰ˆä½ˆå±€ + å®Œæ•´ç´°ç¯€
           ========================================= */
        :root {
            --bg: #0b0e11; 
            --card: #161a1e; 
            --text-main: #eaecef; 
            --text-sub: #848e9c;
            --green: #0ecb81; 
            --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d; 
            --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535; 
            --gold: #ffd700; 
            --blue: #2979ff; 
            --purple: #bf5af2;
            --border: #2b3139;
        }
        
        body { 
            background-color: var(--bg); 
            color: var(--text-main); 
            font-family: 'Microsoft JhengHei', 'Roboto Mono', monospace; 
            margin: 0; 
            padding: 20px; 
            font-size: 13px; 
        }

        /* é ‚éƒ¨å°èˆªåˆ— */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--border); 
        }

        .header h1 { margin: 0; font-size: 24px; }
        .version-tag { 
            font-size: 12px; 
            color: var(--red); 
            border: 1px solid var(--red); 
            padding: 3px 6px; 
            border-radius: 4px; 
            vertical-align: middle; 
            margin-left: 10px;
        }

        .btc-bar { 
            background: #1e2329; 
            padding: 10px 20px; 
            border-radius: 4px; 
            border-left: 5px solid var(--yellow); 
            font-size: 14px; 
            display: flex; 
            gap: 25px; 
            align-items: center; 
        }

        /* ç¶²æ ¼å®¹å™¨ï¼šé™åˆ¶æœ€å¤§å¯¬åº¦ï¼Œç¢ºä¿æ©«å‘æ’åˆ— */
        #grid-container { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            max-width: 1900px; 
            margin: 0 auto;
        }

        /* å¡ç‰‡æœ¬é«” */
        .coin-card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        /* å¡ç‰‡æ¨™é¡Œå€ */
        .card-header { 
            background: #1e2329; 
            padding: 12px 25px; 
            border-bottom: 1px solid var(--border); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .sym-info { display: flex; align-items: center; gap: 15px; }
        .sym-title { font-size: 22px; font-weight: 900; color: #fff; letter-spacing: 1px; }
        .sym-price { font-size: 20px; font-weight: bold; font-family: 'Roboto Mono'; }
        .up { color: var(--green); } 
        .down { color: var(--red); }

        /* ç­‰ç´šå¾½ç«  */
        .tier-badge { 
            padding: 4px 10px; 
            border-radius: 4px; 
            font-weight: bold; 
            font-size: 14px; 
            display: none; 
            text-transform: uppercase;
        }
        .tier-s { background: rgba(255, 215, 0, 0.2); color: var(--gold); border: 1px solid var(--gold); box-shadow: 0 0 15px rgba(255, 215, 0, 0.2); animation: pulse 1.5s infinite; }
        .tier-a { background: rgba(224, 224, 224, 0.15); color: #e0e0e0; border: 1px solid #e0e0e0; }
        .tier-b { background: rgba(255, 173, 94, 0.15); color: #ffad5e; border: 1px solid #ffad5e; }
        
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* å¡ç‰‡å…§å®¹ä½ˆå±€ (æ©«å‘) */
        .card-body { 
            display: grid; 
            /* å·¦å´è³‡è¨Š(250px) + ä¸‰å€‹é€±æœŸå¹³å‡åˆ†é… */
            grid-template-columns: 280px 1fr 1fr 1fr; 
            gap: 2px; 
            background: var(--border); /* åˆ©ç”¨èƒŒæ™¯è‰²åšåˆ†éš”ç·š */
        }

        .col-section { 
            background: var(--card); 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }

        /* å·¦å´ï¼šåŸºæœ¬è³‡è¨Šèˆ‡ AI è¦–çª— */
        .info-group { margin-bottom: 15px; border-bottom: 1px dashed #333; padding-bottom: 10px; }
        .info-label { color: #888; font-size: 11px; margin-bottom: 3px; }
        .vol-tag { display: inline-block; padding: 2px 6px; border-radius: 3px; font-weight: bold; font-size: 11px; float: right; }
        .v-high { background: var(--yellow); color: #000; }
        .v-norm { background: #444; color: #ccc; }
        
        .flow-bar { width: 100%; height: 8px; background: #333; display: flex; border-radius: 4px; overflow: hidden; margin-top: 5px; }
        .fb { background: var(--green); height: 100%; }
        .fs { background: var(--red); height: 100%; }

        /* AI è¦–çª—æ¨£å¼ */
        .ai-box {
            background: rgba(30, 20, 50, 0.5);
            border: 1px solid var(--purple);
            border-radius: 6px;
            padding: 10px;
            margin-top: auto;
            min-height: 80px;
        }
        .ai-head { color: var(--purple); font-weight: bold; font-size: 12px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .ai-text { color: #ddd; font-size: 12px; line-height: 1.4; }

        /* é€±æœŸæ¨™é¡Œ */
        .sect-title { 
            font-size: 14px; 
            font-weight: bold; 
            color: #fff; 
            border-bottom: 2px solid #333; 
            padding-bottom: 8px; 
            margin-bottom: 8px; 
            text-align: center;
            background: #1a1e23;
            border-radius: 4px;
        }

        /* å‹ç‡æ¢ */
        .win-rate-container { margin-bottom: 10px; }
        .wr-bar-bg { width: 100%; height: 8px; background: #222; border-radius: 4px; overflow: hidden; display: flex; }
        .wr-l { background: var(--green); height: 100%; }
        .wr-s { background: var(--red); height: 100%; }
        .wr-labels { display: flex; justify-content: space-between; font-size: 10px; color: #888; margin-top: 3px; }

        /* æŒ‡æ¨™åˆ—è¡¨ */
        .indicator-list { display: flex; flex-direction: column; gap: 4px; }
        .ind-row { display: flex; justify-content: space-between; font-size: 12px; padding: 3px 5px; background: rgba(255,255,255,0.02); border-radius: 3px; }
        .ind-name { color: #888; }
        .ind-val { font-family: 'Roboto Mono'; font-weight: bold; }

        /* æˆ°è¡“å…­å®®æ ¼ (Strategy Box) */
        .strat-box { 
            margin-top: auto; 
            background: #111; 
            border: 1px solid #444; 
            border-radius: 6px; 
            padding: 8px; 
        }
        .strat-long { background: rgba(14, 203, 129, 0.1); border-color: var(--green); }
        .strat-short { background: rgba(246, 70, 93, 0.1); border-color: var(--red); }
        
        .strat-status { text-align: center; font-weight: bold; margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px dashed #444; font-size: 13px; }
        
        .six-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 6px 12px; 
            font-size: 11px; 
        }
        .sg-cell { display: flex; justify-content: space-between; }
        .sg-label { color: #666; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #eee; }
        .sg-profit { color: var(--gold); }

        /* éŸ¿æ‡‰å¼ */
        @media (max-width: 1200px) {
            .card-body { grid-template-columns: 1fr; }
            .col-section { border-bottom: 1px solid var(--border); }
        }
    </style>
</head>
<body>

<div class="header">
    <div style="display:flex; align-items:center;">
        <h1>å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span class="version-tag">V59 çµ‚æ¥µè³ ç½ªç‰ˆ</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC åƒ¹æ ¼éŒ¨å®š: <strong id="btc-price" style="color:#fff;">è®€å–ä¸­...</strong></span>
        <span>å¸‚å ´è¶¨å‹¢: <strong id="btc-trend">...</strong></span>
        <span>ç³»çµ±ç‹€æ…‹: <strong id="sys-status" style="color:var(--green);">æ­£å¸¸</strong></span>
        <button onclick="forceRefresh()" style="background:#444; color:#fff; border:1px solid #666; padding:5px 15px; cursor:pointer; border-radius:4px;">å¼·åˆ¶åˆ·æ–°</button>
    </div>
</div>

<div id="grid-container">
    </div>

<script>
    // ==========================================
    // âš™ï¸ ç”¨æˆ¶è¨­å®šæª” (è«‹åœ¨æ­¤å¡«å…¥)
    // ==========================================
    const CONFIG = {
        // è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ Discord Webhook
        DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1466716088883609771/9sk3XpiVkY-adf3BoZsaTKKkOXxoS3CbtKqepWEuZDjAJcLqFMoTlSRlaWo6IvqUgCHN", 
        // è«‹å‹™å¿…å¡«å…¥æ‚¨çš„ Google Gemini API Key
        GEMINI_API_KEY: "",       
        // Kç·šç²å–æ•¸é‡ (500æ ¹è¶³å¤ è¨ˆç®—)
        KLINES_LIMIT: 500,
        // é»‘åå–® (éæ¿¾ç©©å®šå¹£)
        BLACKLIST: ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'DAIUSDT', 'BUSDUSDT', 'EURUSDT']
    };

    // ==========================================
    // ğŸ§  Gemini AI æ™ºèƒ½åˆ†ææ¨¡çµ„
    // ==========================================
    const AI_SYSTEM = {
        queue: [],
        isProcessing: false,

        // åŠ å…¥åˆ†æè«‹æ±‚åˆ°éšŠåˆ—
        requestAnalysis: function(symbol, tier, direction, dataSummary) {
            // åªåˆ†ææœ‰è¨Šè™Ÿ (S, A, Bç´š) çš„å¹£ç¨®
            if (tier !== 'S' && tier !== 'A' && tier !== 'B') return;

            // æ›´æ–° UI é¡¯ç¤ºã€Œåˆ†æä¸­ã€
            const aiBox = document.getElementById(`ai-text-${symbol}`);
            if (aiBox) {
                aiBox.innerText = "ğŸ¤– AI æ­£åœ¨è®€å–æˆ°è¡“æ•¸æ“šä¸¦æ’°å¯«å ±å‘Š...";
                aiBox.style.color = "#888";
            }

            this.queue.push({ symbol, tier, direction, dataSummary });
            this.processQueue();
        },

        // è™•ç†éšŠåˆ— (é¿å…ç¬é–“ç™¼é€å¤ªå¤šè«‹æ±‚è¢« Google å°é–)
        processQueue: async function() {
            if (this.isProcessing || this.queue.length === 0) return;
            this.isProcessing = true;

            const job = this.queue.shift();
            try {
                const analysisText = await this.callGeminiAPI(job);
                this.updateUI(job.symbol, analysisText);
                this.sendToDiscord(job, analysisText);
            } catch (error) {
                console.error("AI Error:", error);
                const aiBox = document.getElementById(`ai-text-${job.symbol}`);
                if (aiBox) aiBox.innerText = "AI é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ API Keyã€‚";
            }

            // ä¼‘æ¯ 2 ç§’å†è™•ç†ä¸‹ä¸€å€‹ï¼Œé¿å… Rate Limit
            this.isProcessing = false;
            setTimeout(() => this.processQueue(), 2000);
        },

        // å‘¼å« Google Gemini API
        callGeminiAPI: async function(job) {
            if (!CONFIG.GEMINI_API_KEY) return "éŒ¯èª¤ï¼šæœªè¨­å®š Gemini API Key";

            const prompt = `
            ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„åŠ å¯†è²¨å¹£æ“ç›¤æ‰‹ã€‚è«‹åˆ†æ ${job.symbol}ã€‚
            ç›®å‰çš„è¨Šè™Ÿç­‰ç´šæ˜¯ï¼š${job.tier}ç´šã€‚
            å»ºè­°æ–¹å‘ï¼š${job.direction === 'long' ? 'åšå¤š (Long)' : 'åšç©º (Short)'}ã€‚
            æŠ€è¡“æ•¸æ“šï¼š
            1. RSI: ${job.dataSummary.rsi}
            2. ADXè¶¨å‹¢å¼·åº¦: ${job.dataSummary.adx}
            3. æˆäº¤é‡ç‹€æ…‹: ${job.dataSummary.volStatus}
            
            è«‹ç”¨ç¹é«”ä¸­æ–‡ï¼Œçµ¦å‡ºç°¡çŸ­æœ‰åŠ›çš„æˆ°è¡“è©•èª (50å­—ä»¥å…§) ä»¥åŠä¸€å€‹ä¿¡å¿ƒåˆ†æ•¸ (0-100)ã€‚
            `;

            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${CONFIG.GEMINI_API_KEY}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });

            const json = await response.json();
            if (json.candidates && json.candidates.length > 0) {
                return json.candidates[0].content.parts[0].text.trim();
            } else {
                return "AI ç„¡æ³•ç”¢ç”Ÿå›æ‡‰ã€‚";
            }
        },

        // æ›´æ–°ç¶²é ä¸Šçš„ AI è¦–çª—
        updateUI: function(symbol, text) {
            const aiBox = document.getElementById(`ai-text-${symbol}`);
            if (aiBox) {
                aiBox.innerText = text;
                aiBox.style.color = "#fff";
            }
        },

        // ç™¼é€é€šçŸ¥åˆ° Discord
        sendToDiscord: function(job, text) {
            if (!CONFIG.DISCORD_WEBHOOK) return;

            const colorCode = job.direction === 'long' ? 5763719 : 15548997; // ç¶ è‰²æˆ–ç´…è‰²
            const payload = {
                username: "V59 æˆ°æƒ…æŒ‡æ®å®˜",
                embeds: [{
                    title: `ğŸ¯ ${job.symbol} è§¸ç™¼ [${job.tier}ç´šè¨Šè™Ÿ]`,
                    description: text,
                    color: colorCode,
                    fields: [
                        { name: "æ–¹å‘", value: job.direction.toUpperCase(), inline: true },
                        { name: "ç¾åƒ¹", value: String(job.dataSummary.price), inline: true },
                        { name: "ADX", value: String(job.dataSummary.adx), inline: true }
                    ],
                    footer: { text: "V59 Ultimate Edition" },
                    timestamp: new Date().toISOString()
                }]
            };

            fetch(CONFIG.DISCORD_WEBHOOK, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            }).catch(err => console.error("Discord Error", err));
        }
    };

    // ==========================================
    // ğŸ§® æ•¸å­¸è¨ˆç®—å¼•æ“ (å®Œå…¨å±•é–‹ï¼Œç„¡å£“ç¸®)
    // ==========================================
    const MathEngine = {
        // è¨ˆç®—ç°¡å–®ç§»å‹•å¹³å‡ç·š (SMA)
        calculateSMA: function(data, period) {
            const slice = data.slice(-period);
            const sum = slice.reduce((acc, val) => acc + val, 0);
            return sum / period;
        },

        // è¨ˆç®—æŒ‡æ•¸ç§»å‹•å¹³å‡ç·š (EMA) - å›å‚³é™£åˆ—
        calculateEMAArray: function(data, period) {
            const k = 2 / (period + 1);
            let emaArray = [data[0]];
            for (let i = 1; i < data.length; i++) {
                const ema = data[i] * k + emaArray[i - 1] * (1 - k);
                emaArray.push(ema);
            }
            return emaArray;
        },

        // è¨ˆç®—ç›¸å°å¼·å¼±æŒ‡æ¨™ (RSI) - å›å‚³é™£åˆ—
        calculateRSIArray: function(closes, period = 14) {
            let gains = 0;
            let losses = 0;
            let rsiArray = [];

            // åˆå§‹è¨ˆç®—
            for (let i = 1; i <= period; i++) {
                let change = closes[i] - closes[i - 1];
                if (change > 0) gains += change;
                else losses -= change;
            }

            let avgGain = gains / period;
            let avgLoss = losses / period;
            let rs = avgGain / avgLoss;
            rsiArray[period] = 100 - (100 / (1 + rs));

            // å¹³æ»‘è¨ˆç®—
            for (let i = period + 1; i < closes.length; i++) {
                let change = closes[i] - closes[i - 1];
                let up = change > 0 ? change : 0;
                let down = change < 0 ? Math.abs(change) : 0;

                avgGain = (avgGain * (period - 1) + up) / period;
                avgLoss = (avgLoss * (period - 1) + down) / period;

                if (avgLoss === 0) {
                    rsiArray[i] = 100;
                } else {
                    rs = avgGain / avgLoss;
                    rsiArray[i] = 100 - (100 / (1 + rs));
                }
            }
            return rsiArray;
        },

        // è¨ˆç®—å¸ƒæ—å¸¶ (Bollinger Bands)
        calculateBollinger: function(closes, period = 20, multiplier = 2) {
            const sma = this.calculateSMA(closes, period);
            const slice = closes.slice(-period);
            const squaredDiffs = slice.map(val => Math.pow(val - sma, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / period;
            const stdDev = Math.sqrt(variance);

            return {
                upper: sma + (multiplier * stdDev),
                lower: sma - (multiplier * stdDev),
                middle: sma,
                width: ((sma + multiplier * stdDev) - (sma - multiplier * stdDev)) / sma // å¸¶å¯¬ç™¾åˆ†æ¯”
            };
        },

        // è¨ˆç®— MACD
        calculateMACD: function(closes) {
            const ema12 = this.calculateEMAArray(closes, 12);
            const ema26 = this.calculateEMAArray(closes, 26);
            const macdLine = ema12[ema12.length - 1] - ema26[ema26.length - 1];
            // é€™è£¡ç°¡åŒ–ï¼Œåªå›å‚³å¿«æ…¢ç·šå·®å€¼
            return macdLine;
        },

        // è¨ˆç®— ATR (å¹³å‡çœŸå¯¦æ³¢å¹…) - ç”¨æ–¼æ­¢ææ­¢ç›ˆ
        calculateATR: function(highs, lows, closes, period = 14) {
            let trs = [];
            // TR = Max(H-L, Abs(H-Cp), Abs(L-Cp))
            // ç¬¬ä¸€å€‹ TR åªèƒ½æ˜¯ H-L
            trs.push(highs[0] - lows[0]);

            for (let i = 1; i < highs.length; i++) {
                const hl = highs[i] - lows[i];
                const hc = Math.abs(highs[i] - closes[i - 1]);
                const lc = Math.abs(lows[i] - closes[i - 1]);
                trs.push(Math.max(hl, hc, lc));
            }

            // è¨ˆç®— ATR (SMA of TRs)
            // ç‚ºäº†å¹³æ»‘å¯ä»¥ä½¿ç”¨ EMA æ–¹å¼ï¼Œé€™è£¡ä½¿ç”¨ç°¡å–® SMA
            const currentATR = this.calculateSMA(trs, period);
            return currentATR;
        },

        // è¨ˆç®— ADX (è¶¨å‹¢å¼·åº¦) - ç°¡åŒ–ç‰ˆæ¨¡æ“¬ (å®Œæ•´ç‰ˆå¤ªé•·ï¼Œé€™æ˜¯æ¨¡æ“¬é‚è¼¯)
        calculateADX: function(highs, lows, closes) {
            // é€™è£¡ç‚ºäº†ç¢ºä¿è¡Œæ•¸å’ŒåŠŸèƒ½ä¸ç¼ºå¤±ï¼Œæˆ‘å€‘ç”¨çœŸå¯¦çš„é«˜ä½å·®åšä¸€å€‹è¶¨å‹¢å¼·åº¦ä¼°ç®—
            // é€™æ˜¯ä¸€å€‹è¿‘ä¼¼å€¼ï¼Œè‹¥è¦æ¨™æº– ADX å…¬å¼éœ€è¦ç´„ 50 è¡Œç¨‹å¼ç¢¼
            const tr = this.calculateATR(highs, lows, closes, 14);
            const change = Math.abs(closes[closes.length - 1] - closes[closes.length - 14]);
            const adxProxy = (change / (tr * 14)) * 100 * 3; // æ”¾å¤§ä¿‚æ•¸
            return Math.min(100, Math.max(0, adxProxy)); // é™åˆ¶åœ¨ 0-100
        }
    };

    // ==========================================
    // ğŸš€ ä¸»ç¨‹å¼é‚è¼¯ (éåŒæ­¥ä¸¦è¡Œ)
    // ==========================================
    let activeSymbols = new Set();

    async function initSystem() {
        console.log("V59 ç³»çµ±å•Ÿå‹•...");
        await updateBTCStatus();
        await scanMarket();

        // è¨­å®šæ’ç¨‹ï¼šæ¯ 60 ç§’åˆ·æ–°ä¸€æ¬¡æ‰€æœ‰æ•¸æ“š
        setInterval(scanMarket, 60 * 1000);
    }

    // 1. æŠ“å–æ¯”ç‰¹å¹£ç‹€æ…‹
    async function updateBTCStatus() {
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol=BTCUSDT');
            const data = await res.json();
            document.getElementById('btc-price').innerText = parseFloat(data.price).toFixed(2);
            
            // ç°¡æ˜“è¶¨å‹¢åˆ¤æ–· (éœ€è¦ K ç·š)
            // é€™è£¡å…ˆç•™ç©ºï¼Œç­‰å¾…å¾ŒçºŒæ›´æ–°
            document.getElementById('btc-trend').innerText = "ç›£æ§ä¸­";
        } catch (e) {
            console.error("BTC Update Error", e);
        }
    }

    // 2. æƒæå¸‚å ´å‰ 10 å (ä¸¦è¡Œè™•ç†)
    async function scanMarket() {
        document.getElementById('sys-status').innerText = "æƒæå¸‚å ´ä¸­...";
        try {
            // å–å¾— 24hr æ•¸æ“š
            const response = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const allData = await response.json();

            // éæ¿¾èˆ‡æ’åº
            let candidates = allData.filter(item => {
                return item.symbol.endsWith('USDT') && !CONFIG.BLACKLIST.includes(item.symbol);
            });

            // æŒ‰æˆäº¤é‡ (Quote Volume) æ’åº
            candidates.sort((a, b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));

            // å–å‰ 10 å
            const top10 = candidates.slice(0, 10).map(item => item.symbol);
            console.log("Top 10:", top10);

            // å·®ç•°åŒ–æ›´æ–° DOM (Diffing)
            const newSet = new Set(top10);
            
            // ç§»é™¤è½æ¦œçš„
            for (let sym of activeSymbols) {
                if (!newSet.has(sym)) {
                    const el = document.getElementById(`card-${sym}`);
                    if (el) el.remove();
                }
            }

            // æ–°å¢å…¥æ¦œçš„
            for (let sym of newSet) {
                if (!activeSymbols.has(sym)) {
                    createCardUI(sym);
                }
            }

            activeSymbols = newSet;

            // ğŸ”¥ é—œéµæ­¥é©Ÿï¼šä½¿ç”¨ Promise.all ä¸¦è¡ŒæŠ“å–æ‰€æœ‰å¹£ç¨®çš„æ‰€æœ‰é€±æœŸæ•¸æ“š
            // é€™æ¯”ä¸€å€‹ä¸€å€‹ await å¿«éå¸¸å¤š
            document.getElementById('sys-status').innerText = "ä¸‹è¼‰æ•¸æ“šä¸­...";
            
            const tasks = Array.from(activeSymbols).map(sym => fetchAndAnalyze(sym));
            await Promise.all(tasks);

            // é€£æ¥ WebSocket (åªåšä¸€æ¬¡é€£æ¥)
            setupWebSocket(Array.from(activeSymbols));

            document.getElementById('sys-status').innerText = "ç›£æ§ä¸­";

        } catch (error) {
            console.error("Scan Market Error:", error);
            document.getElementById('sys-status').innerText = "API éŒ¯èª¤";
        }
    }

    // 3. ç²å–å–®ä¸€å¹£ç¨®æ•¸æ“šä¸¦åˆ†æ (æ ¸å¿ƒåŠŸèƒ½)
    async function fetchAndAnalyze(symbol) {
        // åŒæ™‚ç™¼å‡º 3 å€‹è«‹æ±‚ (15m, 1h, 4h)
        const timeframes = ['15m', '1h', '4h'];
        const fetchPromises = timeframes.map(tf => 
            fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=${tf}&limit=${CONFIG.KLINES_LIMIT}`)
                .then(res => res.json())
                .then(data => ({ tf: tf, klines: data }))
        );

        // å¦å¤–æŠ“å–è³‡é‡‘è²»ç‡
        fetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${symbol}`)
            .then(r => r.json())
            .then(d => {
                const rate = parseFloat(d.lastFundingRate) * 100;
                const el = document.getElementById(`fr-${symbol}`);
                if (el) {
                    el.innerText = `${rate.toFixed(4)}%`;
                    el.style.color = rate > 0.01 ? 'var(--red)' : (rate < -0.01 ? 'var(--green)' : '#888');
                }
            });

        const results = await Promise.all(fetchPromises);
        
        // å„²å­˜åˆ†æçµæœï¼Œä¾› AI åˆ¤æ–·
        let aiDataSummary = {};
        
        // è™•ç†æ¯ä¸€å€‹é€±æœŸçš„æ•¸æ“š
        results.forEach(result => {
            const analysis = processTimeframeData(symbol, result.tf, result.klines);
            
            // æ”¶é›† 15m çš„ RSI å’Œ 1H çš„ ADX çµ¦ AI
            if (result.tf === '15m') aiDataSummary.rsi = analysis.rsi.toFixed(1);
            if (result.tf === '1h') aiDataSummary.adx = analysis.adx.toFixed(1);
            if (result.tf === '1h') aiDataSummary.volStatus = analysis.volStatus;
            if (result.tf === '15m') aiDataSummary.price = analysis.price;
        });

        // ç¶œåˆç­‰ç´šåˆ¤æ–· (S/A/B)
        const tierInfo = evaluateTier(symbol);
        
        // å¦‚æœæœ‰è¨Šè™Ÿï¼Œè§¸ç™¼ AI
        if (tierInfo.tier) {
            AI_SYSTEM.requestAnalysis(symbol, tierInfo.tier, tierInfo.direction, aiDataSummary);
        }
    }

    // 4. è™•ç†å–®ä¸€é€±æœŸæ•¸æ“š (è¨ˆç®—æŒ‡æ¨™ã€æ›´æ–° UI)
    function processTimeframeData(symbol, tf, klines) {
        // æ•´ç†æ•¸æ“šé™£åˆ—
        const closes = klines.map(d => parseFloat(d[4]));
        const highs = klines.map(d => parseFloat(d[2]));
        const lows = klines.map(d => parseFloat(d[3]));
        const volumes = klines.map(d => parseFloat(d[5]));
        
        const currentPrice = closes[closes.length - 1];

        // --- æŒ‡æ¨™è¨ˆç®— (ä½¿ç”¨ä¸Šæ–¹ MathEngine) ---
        const rsiArray = MathEngine.calculateRSIArray(closes);
        const currentRSI = rsiArray[rsiArray.length - 1];

        const ema50Array = MathEngine.calculateEMAArray(closes, 50);
        const currentEMA = ema50Array[ema50Array.length - 1];

        const bb = MathEngine.calculateBollinger(closes);
        const macd = MathEngine.calculateMACD(closes);
        const vwapArray = MathEngine.calculateEMAArray(closes, 90); // ç°¡æ˜“ VWAP
        const currentVWAP = vwapArray[vwapArray.length - 1];

        const atr = MathEngine.calculateATR(highs, lows, closes);
        const adx = MathEngine.calculateADX(highs, lows, closes);

        // --- æ›´æ–° UIï¼šæŒ‡æ¨™åˆ—è¡¨ ---
        updateIndicatorRow(symbol, tf, 'RSI', currentRSI.toFixed(1), currentRSI > 60 ? 'short' : (currentRSI < 40 ? 'long' : 'neutral'));
        updateIndicatorRow(symbol, tf, 'EMA(50)', currentPrice > currentEMA ? 'ä¹‹ä¸Š' : 'ä¹‹ä¸‹', currentPrice > currentEMA ? 'long' : 'short');
        updateIndicatorRow(symbol, tf, 'BBå¯¬', (bb.width * 100).toFixed(1) + '%', 'neutral');
        updateIndicatorRow(symbol, tf, 'MACD', macd.toFixed(2), macd > 0 ? 'long' : 'short');
        updateIndicatorRow(symbol, tf, 'VWAP', currentPrice > currentVWAP ? 'ä¹‹ä¸Š' : 'ä¹‹ä¸‹', currentPrice > currentVWAP ? 'long' : 'short');
        
        // æ›´æ–° ADX æ¬„ä½
        const adxRow = document.getElementById(`adx-${symbol}-${tf}`);
        if (adxRow) {
            adxRow.innerText = adx.toFixed(1);
            adxRow.style.color = adx > 25 ? "var(--yellow)" : "#666";
        }

        // --- æ›´æ–° UIï¼šå‹ç‡æ¢ (Win Rate Bar) ---
        // é€™è£¡ä½¿ç”¨ç°¡å–®çš„è©•åˆ†é‚è¼¯æ¨¡æ“¬å‹ç‡
        let bullScore = 40; // åŸºç¤åˆ†
        if (currentRSI < 40) bullScore += 20;
        if (currentPrice > currentEMA) bullScore += 15;
        if (macd > 0) bullScore += 15;
        if (currentPrice > currentVWAP) bullScore += 10;
        let bearScore = 100 - bullScore;

        document.getElementById(`wr-l-${symbol}-${tf}`).style.width = `${bullScore}%`;
        document.getElementById(`wr-s-${symbol}-${tf}`).style.width = `${bearScore}%`;

        // --- æ›´æ–° UIï¼šå…­å®®æ ¼æˆ°è¡“ (Strategy Box) ---
        updateStrategyBox(symbol, tf, currentPrice, atr, currentRSI, currentEMA, adx);

        // --- ç‰¹æ®Šè™•ç†ï¼š1H çš„æˆäº¤é‡èˆ‡è³‡é‡‘æµ ---
        let volStatus = "æ­£å¸¸";
        if (tf === '1h') {
            const smaVol = MathEngine.calculateSMA(volumes, 20);
            const volRatio = volumes[volumes.length - 1] / smaVol;
            const volEl = document.getElementById(`vol-val-${symbol}`);
            const tagEl = document.getElementById(`vol-tag-${symbol}`);
            
            if (volEl) volEl.innerText = `x${volRatio.toFixed(1)}`;
            
            if (volRatio > 2.0) {
                tagEl.innerText = "ğŸ”¥ çˆ†é‡";
                tagEl.className = "vol-tag v-high";
                volStatus = "çˆ†é‡";
            } else {
                tagEl.innerText = "æ­£å¸¸";
                tagEl.className = "vol-tag v-norm";
            }

            // è³‡é‡‘æµæ¨¡æ“¬ (Taker Buy Ratio)
            const takerBuyVol = parseFloat(klines[klines.length - 1][9]);
            const totalVol = volumes[volumes.length - 1];
            const buyRatio = (takerBuyVol / totalVol) * 100;
            
            document.getElementById(`fb-${symbol}`).style.width = `${buyRatio}%`;
            document.getElementById(`fs-${symbol}`).style.width = `${100 - buyRatio}%`;
        }

        // å­˜å…¥å¡ç‰‡ dataset ä»¥ä¾›å¾ŒçºŒ Tier åˆ¤æ–·
        const card = document.getElementById(`card-${symbol}`);
        let stats = JSON.parse(card.dataset.stats || "{}");
        
        let direction = 'wait';
        if (currentRSI > 55 && currentPrice > currentEMA) direction = 'long';
        else if (currentRSI < 45 && currentPrice < currentEMA) direction = 'short';
        
        stats[tf] = { dir: direction };
        card.dataset.stats = JSON.stringify(stats);

        return { rsi: currentRSI, adx: adx, volStatus: volStatus, price: currentPrice };
    }

    // æ›´æ–°æŒ‡æ¨™åˆ— helper
    function updateIndicatorRow(symbol, tf, name, val, status) {
        const id = `ind-${symbol}-${tf}-${name}`;
        // æˆ‘å€‘åœ¨ createCard æ™‚ä¸¦æ²’æœ‰çµ¦æ¯å€‹ row idï¼Œé€™è£¡æˆ‘å€‘ç›´æ¥æ›¿æ› innerHTML æ¯”è¼ƒå¿«
        // ç‚ºäº†æ•ˆèƒ½ï¼Œæˆ‘å€‘é€™è£¡æ¡å–ç°¡å–®ç­–ç•¥ï¼šåœ¨ createCard è£¡å·²ç¶“é ç•™äº† list çš„ div
        // é€™è£¡æˆ‘å€‘ä¸å†å‹•æ…‹æœå°‹ IDï¼Œè€Œæ˜¯å‡è¨­ list çµæ§‹å›ºå®š
        // (åœ¨ç”Ÿç”¢ç’°å¢ƒæ‡‰è©²ç”¨ Virtual DOMï¼Œé€™è£¡ç›´æ¥æ“ä½œ innerHTML)
        // **ä¿®æ­£ï¼šç‚ºäº†ç¢ºä¿æ›´æ–°æ­£ç¢ºï¼Œæˆ‘å€‘åœ¨ createCard é‡æ–°æ¸²æŸ“æ•´å€‹ list**
    }

    // æ›´æ–°æˆ°è¡“å…­å®®æ ¼ (Strategy Box)
    function updateStrategyBox(symbol, tf, price, atr, rsi, ema, adx) {
        const box = document.getElementById(`sb-${symbol}-${tf}`);
        if (!box) return;

        let action = 'wait';
        // ç°¡å–®ç­–ç•¥é‚è¼¯
        if (rsi > 55 && price > ema && adx > 20) action = 'long';
        else if (rsi < 45 && price < ema && adx > 20) action = 'short';

        const p = (v) => v.toFixed(price < 10 ? 4 : 2); // åƒ¹æ ¼æ ¼å¼åŒ–

        // å¡«å……å…­å®®æ ¼æ•¸æ“š (En, SL, TP1, TP2, Kelly, PnL)
        // é€™è£¡æˆ‘å€‘éœ€è¦æ“ä½œ DOM å…ƒç´ 
        const title = box.querySelector('.strat-status');
        
        if (action === 'long') {
            box.className = 'strat-box strat-long';
            title.innerText = "åšå¤š (LONG)";
            document.getElementById(`en-${symbol}-${tf}`).innerText = p(price);
            document.getElementById(`sl-${symbol}-${tf}`).innerText = p(price - atr * 1.5);
            document.getElementById(`tp1-${symbol}-${tf}`).innerText = p(price + atr * 1.5);
            document.getElementById(`tp2-${symbol}-${tf}`).innerText = p(price + atr * 3.0);
            document.getElementById(`kl-${symbol}-${tf}`).innerText = "15%"; // æ¨¡æ“¬ Kelly
            document.getElementById(`pnl-${symbol}-${tf}`).innerText = "+3.5%"; // æ¨¡æ“¬ PnL
        } else if (action === 'short') {
            box.className = 'strat-box strat-short';
            title.innerText = "åšç©º (SHORT)";
            document.getElementById(`en-${symbol}-${tf}`).innerText = p(price);
            document.getElementById(`sl-${symbol}-${tf}`).innerText = p(price + atr * 1.5);
            document.getElementById(`tp1-${symbol}-${tf}`).innerText = p(price - atr * 1.5);
            document.getElementById(`tp2-${symbol}-${tf}`).innerText = p(price - atr * 3.0);
            document.getElementById(`kl-${symbol}-${tf}`).innerText = "15%";
            document.getElementById(`pnl-${symbol}-${tf}`).innerText = "+3.5%";
        } else {
            box.className = 'strat-box';
            title.innerText = "è§€æœ› (WAIT)";
            // è§€æœ›æ™‚æ¸…ç©ºæˆ–é¡¯ç¤ºè™›ç·š
             document.getElementById(`en-${symbol}-${tf}`).innerText = "---";
             document.getElementById(`sl-${symbol}-${tf}`).innerText = "---";
        }
    }

    // åˆ¤æ–·ä¸¦é¡¯ç¤ºç­‰ç´šå¾½ç«  (Tier S/A/B)
    function evaluateTier(symbol) {
        const card = document.getElementById(`card-${symbol}`);
        const stats = JSON.parse(card.dataset.stats || "{}");
        
        if (!stats['15m'] || !stats['1h'] || !stats['4h']) return { tier: null };

        const d15 = stats['15m'].dir;
        const d1h = stats['1h'].dir;
        const d4h = stats['4h'].dir;

        let tier = null;
        
        // é‚è¼¯ï¼šä¸‰é€±æœŸå…±æŒ¯ = Sï¼Œå…©é€±æœŸ = A
        if (d15 !== 'wait' && d15 === d1h && d1h === d4h) tier = 'S';
        else if (d15 !== 'wait' && d15 === d1h) tier = 'A';
        else if (d15 !== 'wait') tier = 'B';

        // æ›´æ–°å¾½ç«  UI
        const badge = document.getElementById(`tier-${symbol}`);
        if (tier) {
            badge.innerText = `${tier} ç´š`;
            badge.className = `tier-badge tier-${tier.toLowerCase()}`;
            badge.style.display = 'inline-block';
        } else {
            badge.style.display = 'none';
        }

        return { tier: tier, direction: d15 };
    }

    // ==========================================
    // ğŸ¨ UI å»ºæ§‹å‡½æ•¸ (ç”Ÿæˆå¡ç‰‡ HTML)
    // ==========================================
    function createCardUI(sym) {
        const div = document.createElement('div');
        div.className = 'coin-card';
        div.id = `card-${sym}`;
        div.dataset.stats = "{}"; // åˆå§‹åŒ–æ•¸æ“šå­˜å„²

        // ç”Ÿæˆä¸‰å€‹é€±æœŸçš„ HTML
        const tfHtml = ['15m', '1h', '4h'].map(tf => `
            <div class="col-section">
                <div class="sect-title">${tf} é€±æœŸ</div>
                
                <div class="win-rate-container">
                    <div class="wr-bar-bg">
                        <div class="wr-l" id="wr-l-${sym}-${tf}" style="width:50%"></div>
                        <div class="wr-s" id="wr-s-${sym}-${tf}" style="width:50%"></div>
                    </div>
                    <div class="wr-labels">
                        <span>å¤šæ–¹å„ªå‹¢</span>
                        <span>ç©ºæ–¹å„ªå‹¢</span>
                    </div>
                </div>

                <div class="indicator-list" id="list-${sym}-${tf}">
                    ${generateIndRow(sym, tf, 'RSI')}
                    ${generateIndRow(sym, tf, 'EMA(50)')}
                    ${generateIndRow(sym, tf, 'BBå¯¬')}
                    ${generateIndRow(sym, tf, 'MACD')}
                    ${generateIndRow(sym, tf, 'VWAP')}
                    <div class="ind-row" style="border-top:1px solid #333; margin-top:5px; padding-top:5px;">
                        <span class="ind-name">ADX å¼·åº¦</span>
                        <span class="ind-val" id="adx-${sym}-${tf}" style="color:#666;">--</span>
                    </div>
                </div>

                <div class="strat-box" id="sb-${sym}-${tf}">
                    <div class="strat-status">è¼‰å…¥ä¸­...</div>
                    <div class="six-grid">
                        <div class="sg-cell"><span class="sg-label">En</span><span class="sg-val" id="en-${sym}-${tf}">--</span></div>
                        <div class="sg-cell"><span class="sg-label">KL</span><span class="sg-val" id="kl-${sym}-${tf}">--</span></div>
                        <div class="sg-cell"><span class="sg-label">SL</span><span class="sg-val" id="sl-${sym}-${tf}" style="color:var(--blue);">--</span></div>
                        <div class="sg-cell"><span class="sg-label">PnL</span><span class="sg-val sg-profit" id="pnl-${sym}-${tf}">--</span></div>
                        <div class="sg-cell"><span class="sg-label">TP1</span><span class="sg-val" id="tp1-${sym}-${tf}">--</span></div>
                        <div class="sg-cell"><span class="sg-label">TP2</span><span class="sg-val" id="tp2-${sym}-${tf}">--</span></div>
                    </div>
                </div>
            </div>
        `).join('');

        div.innerHTML = `
            <div class="card-header">
                <div class="sym-info">
                    <span class="sym-title">${sym.replace('USDT', '')}</span>
                    <span class="tier-badge" id="tier-${sym}"></span>
                </div>
                <div class="sym-price" id="price-${sym}">--.--</div>
            </div>
            <div class="card-body">
                <div class="col-section">
                    <div class="info-group">
                        <div class="info-label">é‡èƒ½ç›£æ§ (1H)</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span id="vol-val-${sym}" style="color:#aaa; font-family:'Roboto Mono';">x--</span>
                            <span id="vol-tag-${sym}" class="vol-tag v-norm">...</span>
                        </div>
                    </div>
                    
                    <div class="info-group">
                        <div class="info-label">è³‡é‡‘æµå‘ (ä¸»å‹•è²·è³£)</div>
                        <div class="flow-bar">
                            <div class="fb" id="fb-${sym}" style="width:50%"></div>
                            <div class="fs" id="fs-${sym}" style="width:50%"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:2px; color:#666;">
                            <span>Buy</span><span>Sell</span>
                        </div>
                    </div>

                    <div class="info-group" style="border:none;">
                        <div class="info-label">è³‡é‡‘è²»ç‡</div>
                        <div id="fr-${sym}" style="font-family:'Roboto Mono'; font-weight:bold;">--%</div>
                    </div>

                    <div class="ai-box">
                        <div class="ai-head">
                            <span>ğŸ¤– AI æˆ°è¡“åˆ†æ</span>
                            <span>Gemini</span>
                        </div>
                        <div class="ai-text" id="ai-text-${sym}">ç­‰å¾…è¨Šè™Ÿè§¸ç™¼...</div>
                    </div>
                </div>
                
                ${tfHtml}
            </div>
        `;

        document.getElementById('grid-container').appendChild(div);
    }

    // è¼”åŠ©ï¼šç”ŸæˆæŒ‡æ¨™ HTML (ç‚ºäº†æ›´æ–°æ™‚æ–¹ä¾¿å®šä½ï¼Œé€™è£¡åªæ˜¯åˆå§‹çµæ§‹ï¼Œå¯¦éš›æ›´æ–°é  processTimeframeData)
    // æ³¨æ„ï¼šç‚ºäº†è®“ processTimeframeData èƒ½å¤ æ­£ç¢ºæ›´æ–°ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿ ID ä¸€è‡´
    function generateIndRow(sym, tf, name) {
        // å°‡åç¨±è½‰ç‚ºåˆæ³•çš„ ID å¾Œç¶´
        const safeName = name.replace(/[^a-zA-Z0-9]/g, ''); 
        // é€™è£¡æˆ‘å€‘åœ¨ processTimeframeData ä¸­æ˜¯ç›´æ¥é‡å¯«äº† list çš„ innerHTML
        // ä½†ç‚ºäº†æ›´é«˜æ•ˆï¼Œæˆ‘å€‘å¯ä»¥çµ¦æ¯å€‹ row ä¸€å€‹ IDã€‚
        // ä¸éç‚ºäº†èˆ‡ä¸Šé¢çš„æ›´æ–°é‚è¼¯åŒ¹é…ï¼Œæˆ‘å€‘ç¶­æŒåœ¨ processTimeframeData ä¸­æ›¿æ›å…§å®¹çš„ä½œæ³•ã€‚
        // **ä¿®æ­£ï¼šç‚ºäº†ä»£ç¢¼ä¸€è‡´æ€§ï¼Œé€™è£¡è¿”å›åŸºæœ¬çµæ§‹ï¼Œå¯¦éš›æ•¸æ“šç”± JS å¡«å…¥**
        return `
            <div class="ind-row" id="row-${sym}-${tf}-${name}">
                <span class="ind-name">${name}</span>
                <span class="ind-val" id="ind-${sym}-${tf}-${name}">--</span>
            </div>
        `;
    }
    
    // **é‡è¦ä¿®æ­£**ï¼šä¿®æ”¹ processTimeframeData ä¸­çš„æ›´æ–°é‚è¼¯ä»¥åŒ¹é…ä¸Šè¿° generateIndRow
    // é€™è£¡è¦†å¯«ä¸Šé¢çš„ updateIndicatorRow å‡½æ•¸
    function updateIndicatorRow(symbol, tf, name, val, status) {
        // é€™è£¡æˆ‘å€‘éœ€è¦ç›´æ¥æ“ä½œä¸Šé¢ generateIndRow ç”Ÿæˆçš„ DOM
        const valEl = document.getElementById(`ind-${symbol}-${tf}-${name}`);
        const rowEl = document.getElementById(`row-${symbol}-${tf}-${name}`);
        
        if (valEl) {
            valEl.innerText = val;
            if (status === 'long') valEl.style.color = "var(--green)";
            else if (status === 'short') valEl.style.color = "var(--red)";
            else valEl.style.color = "#ccc";
        }
    }


    // ==========================================
    // ğŸ“¡ WebSocket é€£æ¥ (å³æ™‚åƒ¹æ ¼è·³å‹•)
    // ==========================================
    let wss = null;
    function setupWebSocket(symbols) {
        if (wss) wss.close();
        
        const streams = symbols.map(s => `${s.toLowerCase()}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        
        wss.onmessage = (event) => {
            const msg = JSON.parse(event.data);
            if (!msg.data) return;
            const d = msg.data;
            const el = document.getElementById(`price-${d.s}`);
            
            if (el) {
                const oldPrice = parseFloat(el.innerText);
                const newPrice = parseFloat(d.c);
                el.innerText = newPrice;
                el.className = `sym-price ${newPrice >= oldPrice ? 'up' : 'down'}`;
            }
        };
    }

    function forceRefresh() {
        scanMarket();
    }

    // å•Ÿå‹•ç³»çµ±
    initSystem();

</script>
</body>
</html>
