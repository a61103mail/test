<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V19 è¡Œå‹•é æ¸¬ç‰ˆ)</title>
    <style>
        :root {
            --bg: #0b0e11;
            --card: #161a1e;
            --text-main: #eaecef;
            --text-sub: #848e9c;
            --green: #0ecb81;
            --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d;
            --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535;
            --yellow-bg: rgba(252, 213, 53, 0.1);
            --border: #2b3139;
            --header-bg: #2b3139;
        }
        body {
            background-color: var(--bg);
            color: var(--text-main);
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            margin: 0;
            padding: 8px;
            font-size: 13px;
        }
        
        .header {
            display: flex; justify-content: space-between; align-items: center;
            padding-bottom: 10px; margin-bottom: 10px; border-bottom: 2px solid var(--border);
        }
        .header h1 { margin: 0; font-size: 18px; }

        /* --- å¡ç‰‡å®¹å™¨ --- */
        .card {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        /* --- 1. æ‰‹æ©Ÿç‰ˆï¼šæ”¶åˆç‹€æ…‹çš„é ­éƒ¨ (Always Visible) --- */
        .card-header {
            padding: 12px;
            background: #20252b;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer; /* è®“ä½¿ç”¨è€…çŸ¥é“å¯ä»¥é» */
        }
        
        /* å·¦å´ï¼šå¹£ç¨®èˆ‡åƒ¹æ ¼ */
        .ch-info { display: flex; flex-direction: column; gap: 2px; }
        .sym-name { font-size: 18px; font-weight: 900; color: #fff; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 16px; }
        .up { color: var(--green); } .down { color: var(--red); }

        /* ä¸­é–“ï¼š15m é‡é»æ‘˜è¦ (Risk & Signal) */
        .ch-summary { text-align: right; display: flex; flex-direction: column; align-items: flex-end; gap: 4px; }
        .summary-tag { 
            font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block;
        }
        .st-long { background: var(--green-bg); color: var(--green); border: 1px solid var(--green); }
        .st-short { background: var(--red-bg); color: var(--red); border: 1px solid var(--red); }
        .st-wait { background: #333; color: #888; border: 1px solid #555; }
        
        /* çˆ†å€‰é¢¨éšªé æ¸¬å€¼ */
        .risk-val { font-size: 10px; color: #aaa; font-family: 'Roboto Mono'; }
        .risk-high { color: var(--yellow); font-weight: bold; animation: blink 1s infinite; }

        /* å³å´ï¼šå±•é–‹ç®­é ­ */
        .toggle-icon { margin-left: 10px; color: #666; transition: transform 0.3s; }
        .card.expanded .toggle-icon { transform: rotate(180deg); }

        /* --- 2. å±•é–‹å¾Œçš„å…§å®¹å€ (Hidden by default on mobile) --- */
        .card-body {
            display: none; /* é è¨­éš±è— */
            padding: 0;
            border-top: 1px solid var(--border);
        }
        .card.expanded .card-body { display: block; animation: slideDown 0.3s ease-out; }

        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes blink { 50% { opacity: 0.5; } }

        /* å…§å®¹ç¶²æ ¼ä½ˆå±€ */
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr; /* æ‰‹æ©Ÿå–®æ¬„ */
        }

        /* å€å¡Šæ¨£å¼ */
        .section { padding: 12px; border-bottom: 1px dashed #333; }
        .section:last-child { border-bottom: none; }
        .sec-title { font-size: 11px; color: #888; margin-bottom: 5px; font-weight: bold; display: flex; justify-content: space-between; }

        /* æ•¸æ“šæ¢ */
        .bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; }
        .bar-fill { height: 100%; transition: width 0.5s; }
        .bf-green { background: var(--green); } .bf-red { background: var(--red); }

        /* æŒ‡æ¨™åˆ—è¡¨ */
        .ind-row { display: flex; justify-content: space-between; font-size: 11px; margin-bottom: 4px; padding: 4px; background: rgba(255,255,255,0.03); border-radius: 4px;}
        .ind-l { color: #aaa; } .ind-r { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }

        /* ç­–ç•¥å€ */
        .strat-panel { background: #111; padding: 10px; text-align: center; }
        .sp-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; text-align: left; }
        .sp-item { display: flex; flex-direction: column; }
        .sp-lbl { font-size: 10px; color: #666; }
        .sp-val { font-family: 'Roboto Mono'; font-size: 12px; font-weight: bold; color: #eee; }

        /* çˆ†å€‰ç›£æ§ */
        .liq-alert { background: var(--red-bg); color: var(--red); border: 1px solid var(--red); padding: 5px; text-align: center; border-radius: 4px; font-weight: bold; margin-bottom: 5px; display: none; }

        /* é›»è…¦ç‰ˆé©é… (å¤§æ–¼ 900px æ™‚å¼·åˆ¶å±•é–‹ä¸¦æ©«å‘æ’åˆ—) */
        @media (min-width: 900px) {
            .card-header { display: none; } /* éš±è—æ‰‹æ©Ÿé ­éƒ¨ */
            .card-body { display: grid !important; grid-template-columns: 200px 1fr 1fr 1fr; } /* å¼·åˆ¶å±•é–‹ç‚º4æ¬„ */
            .section { border-bottom: none; border-right: 1px dashed #333; }
            .section:last-child { border-right: none; }
            /* è£œå……ï¼šé›»è…¦ç‰ˆéœ€è¦ä¸€å€‹é ‚éƒ¨è³‡è¨Šæ¬„ï¼Œé€™è£¡æ²¿ç”¨ V18 çš„é‚è¼¯ç¨å¾®èª¿æ•´ */
            .detail-grid { grid-template-columns: 200px 1fr 1fr 1fr; }
        }
    </style>
</head>
<body>

<div class="header">
    <div>
        <h1 style="margin:0;">V19 çˆ†å€‰é æ¸¬æ¨¡å‹</h1>
        <span style="color:#888; font-size:11px;">15m çŸ­ç·šç„¦é» | é»æ“Šå¡ç‰‡å±•é–‹è©³æƒ…</span>
    </div>
    <div id="sys-status" style="color:var(--yellow); font-weight:bold; font-size:12px;">é€£ç·šä¸­...</div>
</div>

<div id="card-container">
    <div style="text-align:center; padding:20px; color:#666;">
        æ­£åœ¨è¨ˆç®— ATR æ³¢å‹•ç‡èˆ‡çˆ†å€‰æ©Ÿç‡...
    </div>
</div>

<script>
    const SYMBOLS = ['btcusdt', 'ethusdt', 'adausdt', 'solusdt', 'xrpusdt', 'riverusdt', 'nxpcusdt'];
    const TFS = ['15m', '1h', '4h'];
    const LIMIT = 500; 
    
    // ç¿»è­¯èˆ‡æ•¸æ“šå­˜å„²
    const TRANS = { '15m': '15åˆ† (çŸ­)', '1h': '1æ™‚ (æ³¢)', '4h': '4æ™‚ (è¶¨)' };
    const store = {}; 

    // --- æ•¸å­¸å¼•æ“ ---
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        emaArray: (data, period) => {
            let k = 2 / (period + 1);
            let ema = [data[0]];
            for (let i = 1; i < data.length; i++) ema.push(data[i] * k + ema[i-1] * (1 - k));
            return ema;
        },
        rsiArray: (closes) => {
            let rsi = [];
            let gains = 0, losses = 0;
            for(let i=1; i<=14; i++) {
                let diff = closes[i] - closes[i-1];
                if(diff>0) gains+=diff; else losses-=diff;
            }
            let avgGain = gains/14; let avgLoss = losses/14;
            rsi[14] = 100 - (100/(1+avgGain/avgLoss));
            for(let i=15; i<closes.length; i++) {
                let diff = closes[i] - closes[i-1];
                if(diff>0) { avgGain=(avgGain*13+diff)/14; avgLoss=(avgLoss*13)/14; }
                else { avgGain=(avgGain*13)/14; avgLoss=(avgLoss*13-diff)/14; }
                rsi[i] = avgLoss===0 ? 100 : 100 - (100/(1+avgGain/avgLoss));
            }
            return rsi;
        },
        atr: (h, l, c, p=14) => {
            if(h.length < p) return 0;
            let trs = [];
            for(let i=1; i<h.length; i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p;
        },
        getWinRate: (signals, closes, type) => {
            let wins = 0, total = 0;
            const lookahead = 5; 
            for(let i=50; i<signals.length-lookahead; i++) {
                if(signals[i]) {
                    total++;
                    const entry = closes[i];
                    const exit = closes[i+lookahead];
                    if(type === 'long' && exit > entry * 1.001) wins++;
                    else if(type === 'short' && exit < entry * 0.999) wins++;
                }
            }
            return total === 0 ? 0 : Math.round((wins/total)*100);
        }
    };

    // --- åˆå§‹åŒ– UI ---
    function initUI() {
        const container = document.getElementById('card-container');
        container.innerHTML = ''; 

        SYMBOLS.forEach(sym => {
            store[sym] = {}; 
            
            // å»ºç«‹å¡ç‰‡çµæ§‹
            let html = `
            <div class="card" id="card-${sym}" onclick="toggleCard('${sym}')">
                <div class="card-header">
                    <div class="ch-info">
                        <span class="sym-name">${sym.toUpperCase().replace('USDT','')}</span>
                        <span class="sym-price" id="price-${sym}">---.--</span>
                    </div>
                    <div class="ch-summary">
                        <span class="summary-tag st-wait" id="head-signal-${sym}">è¼‰å…¥ä¸­</span>
                        <span class="risk-val" id="head-risk-${sym}">æ³¢å‹•é¢¨éšª: è¨ˆç®—ä¸­</span>
                    </div>
                    <div class="toggle-icon">â–¼</div>
                </div>

                <div class="card-body detail-grid">
                    
                    <div class="section">
                        <div class="liq-alert" id="liq-alert-${sym}">ğŸ’¥ ç›£æ¸¬åˆ°é€£ç’°çˆ†å€‰</div>
                        <div class="sec-title"><span>è¨‚å–®æµ (1h Taker)</span></div>
                        <div class="bar-bg">
                            <div class="bar-fill bf-green" id="flow-b-${sym}" style="width:50%"></div>
                            <div class="bar-fill bf-red" id="flow-s-${sym}" style="width:50%"></div>
                        </div>
                        <div style="display:flex; justify-content:space-between; font-size:10px; margin-top:2px;">
                            <span id="flow-bv-${sym}">è²· --%</span>
                            <span id="flow-sv-${sym}">è³£ --%</span>
                        </div>
                        <div style="margin-top:10px; font-size:11px; color:#aaa;">
                            çˆ†å€‰æ©Ÿç‡(ATR): <span id="atr-risk-${sym}" style="color:#fff; font-weight:bold;">--%</span>
                        </div>
                    </div>

                    <div class="section" id="sec-15m-${sym}"></div>

                    <div class="section" id="sec-1h-${sym}"></div>

                    <div class="section" id="sec-4h-${sym}"></div>

                </div>
            </div>`;
            container.insertAdjacentHTML('beforeend', html);
        });
    }

    // åˆ‡æ›å¡ç‰‡å±•é–‹/æ”¶åˆ
    window.toggleCard = function(sym) {
        // åªæœ‰åœ¨æ‰‹æ©Ÿç‰ˆ (å¯¬åº¦ < 900) æ‰æœ‰æ•ˆ
        if (window.innerWidth < 900) {
            const card = document.getElementById(`card-${sym}`);
            card.classList.toggle('expanded');
        }
    };

    // --- é‹ç®—é‚è¼¯ ---
    async function runAnalysis() {
        initUI();
        
        for(const sym of SYMBOLS) {
            try {
                const promises = TFS.map(tf => 
                    fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym.toUpperCase()}&interval=${tf}&limit=${LIMIT}`)
                    .then(res => res.json())
                );
                const results = await Promise.all(promises);

                if(results[0].code) { document.getElementById(`card-${sym}`).style.display='none'; continue; }

                results.forEach((data, i) => {
                    const tf = TFS[i];
                    data.pop(); 
                    processTimeframe(sym, tf, data);
                    if (tf === '1h') calculateFlow(sym, data);
                });
            } catch(e) { console.error(e); }
        }

        document.getElementById('sys-status').textContent = 'â— ç›£æ§ä¸­';
        document.getElementById('sys-status').style.color = '#0ecb81';
        connectWSS();
    }

    // è¨ˆç®—è¨‚å–®æµ
    function calculateFlow(sym, klines) {
        const recent = klines.slice(-24);
        let total = 0, buy = 0;
        recent.forEach(k => { total += parseFloat(k[5]); buy += parseFloat(k[9]); });
        const buyPct = (buy/total)*100;
        document.getElementById(`flow-b-${sym}`).style.width = `${buyPct}%`;
        document.getElementById(`flow-s-${sym}`).style.width = `${100-buyPct}%`;
        document.getElementById(`flow-bv-${sym}`).textContent = `è²·${buyPct.toFixed(0)}%`;
        document.getElementById(`flow-sv-${sym}`).textContent = `è³£${(100-buyPct).toFixed(0)}%`;
    }

    // è™•ç†æ™‚å€ä¸¦æ¸²æŸ“
    function processTimeframe(sym, tf, klines) {
        const closes = klines.map(d => parseFloat(d[4]));
        const highs = klines.map(d => parseFloat(d[2]));
        const lows = klines.map(d => parseFloat(d[3]));
        const last = closes.length - 1;
        const curPrice = closes[last];

        // è¨ˆç®— ATR èˆ‡ é¢¨éšªæ©Ÿç‡ (Volatility Risk)
        const atr = MathEngine.atr(highs, lows, closes);
        // å¦‚æœç•¶å‰Kç·šæŒ¯å¹…è¶…é 2å€ ATRï¼Œè¦–ç‚ºçˆ†å€‰é«˜é¢¨éšª
        const currentRange = highs[last] - lows[last];
        const riskScore = Math.min(100, Math.round((currentRange / atr) * 50)); 

        // æŒ‡æ¨™é‹ç®—
        const rsiArr = MathEngine.rsiArray(closes);
        const ema50Arr = MathEngine.emaArray(closes, 50);
        const sma20 = MathEngine.sma(closes, 20); // BOLL Mid
        const std = Math.sqrt(closes.slice(-20).map(x=>Math.pow(x-sma20,2)).reduce((a,b)=>a+b)/20);
        const upper = sma20 + 2*std;
        const lower = sma20 - 2*std;

        // å›æ¸¬ä¿¡è™Ÿ
        const sigs = {
            rsi_b: [], rsi_s: [], ema_b: [], ema_s: [], bb_b: [], bb_s: []
        };
        for(let i=50; i<=last; i++) {
            const c = closes[i];
            sigs.rsi_b[i] = rsiArr[i]<40; sigs.rsi_s[i] = rsiArr[i]>60;
            sigs.ema_b[i] = c>ema50Arr[i]; sigs.ema_s[i] = c<ema50Arr[i];
            sigs.bb_b[i] = c>upper; sigs.bb_s[i] = c<lower; // ç°¡åŒ–è™•ç†
        }

        const getWR = (b, s, isLong) => isLong ? MathEngine.getWinRate(b, closes, 'long') : MathEngine.getWinRate(s, closes, 'short');
        
        // æ¸²æŸ“æŒ‡æ¨™
        const isBull = {
            rsi: rsiArr[last] > 50,
            ema: curPrice > ema50Arr[last],
            bb: curPrice > sma20
        };

        const wr = {
            rsi: getWR(sigs.rsi_b, sigs.rsi_s, isBull.rsi),
            ema: getWR(sigs.ema_b, sigs.ema_s, isBull.ema)
        };

        const fVal = v => v<10 ? v.toFixed(4) : v.toFixed(2);

        // ç”Ÿæˆ HTML
        let html = `
            <div class="sec-title">
                <span>${TRANS[tf]}</span>
                <span style="font-family:Roboto Mono; color:#fff;">${wr.rsi}% å‹ç‡</span>
            </div>
            <div class="ind-row"><span class="ind-l">RSI</span><span class="ind-r" style="color:${isBull.rsi?'var(--green)':'var(--red)'}">${rsiArr[last].toFixed(1)}</span></div>
            <div class="ind-row"><span class="ind-l">EMA</span><span class="ind-r" style="color:${isBull.ema?'var(--green)':'var(--red)'}">${fVal(ema50Arr[last])}</span></div>
            <div class="ind-row"><span class="ind-l">BOLL</span><span class="ind-r">${curPrice>upper?'ä¸Šç ´':curPrice<lower?'ä¸‹ç ´':'å€é–“'}</span></div>
        `;

        // ç­–ç•¥å»ºè­° (åŒ…å«åœ¨å€å¡Šå…§)
        let signal = 'wait';
        let sigText = 'è§€æœ›';
        let sigClass = 'st-wait';

        // ç°¡å–®ç­–ç•¥ï¼šå‹ç‡é«˜ä¸”æ–¹å‘ä¸€è‡´
        if (isBull.rsi && isBull.ema && wr.rsi > 50) { signal='long'; sigText='åšå¤š'; sigClass='st-long'; }
        else if (!isBull.rsi && !isBull.ema && wr.rsi > 50) { signal='short'; sigText='åšç©º'; sigClass='st-short'; }

        // æ¸²æŸ“ç­–ç•¥å€
        if (signal !== 'wait') {
            const sl = signal=='long' ? curPrice - atr*1.5 : curPrice + atr*1.5;
            const tp = signal=='long' ? curPrice + atr*2 : curPrice - atr*2;
            html += `
            <div class="strat-panel" style="border:1px solid ${signal=='long'?'var(--green)':'var(--red)'}">
                <div style="font-weight:bold; color:${signal=='long'?'var(--green)':'var(--red)'}">å»ºè­°${sigText}</div>
                <div class="sp-grid">
                    <div class="sp-item"><span class="sp-lbl">é€²å ´</span><span class="sp-val">${fVal(curPrice)}</span></div>
                    <div class="sp-item"><span class="sp-lbl">æ­¢æ</span><span class="sp-val">${fVal(sl)}</span></div>
                </div>
            </div>`;
        } else {
            html += `<div class="strat-panel" style="color:#666;">æ•¸æ“šç›¤æ•´ä¸­ (å‹ç‡ä½)</div>`;
        }

        // æ³¨å…¥å…§å®¹åˆ°å°æ‡‰å€å¡Š
        document.getElementById(`sec-${tf}-${sym}`).innerHTML = html;

        // --- é—œéµï¼šæ›´æ–°æ‰‹æ©Ÿç‰ˆæ”¶åˆé ­éƒ¨ (åªç”¨15mæ•¸æ“š) ---
        if (tf === '15m') {
            const headSignal = document.getElementById(`head-signal-${sym}`);
            const headRisk = document.getElementById(`head-risk-${sym}`);
            
            headSignal.className = `summary-tag ${sigClass}`;
            headSignal.textContent = sigText + (signal!=='wait' ? ` (${wr.rsi}%)` : '');
            
            headRisk.textContent = `çˆ†å€‰é¢¨éšª: ${riskScore}%`;
            headRisk.className = `risk-val ${riskScore>70 ? 'risk-high' : ''}`;
            
            // åŒæ­¥æ›´æ–°å·¦å´æ¬„ä½çš„ ATR é¢¨éšªå€¼
            document.getElementById(`atr-risk-${sym}`).textContent = riskScore + '%';
        }
    }

    function connectWSS() {
        const streams = SYMBOLS.map(s => `${s}@ticker`).join('/');
        const ws = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        ws.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const sym = msg.data.s.toLowerCase();
            const price = parseFloat(msg.data.c);
            
            const el = document.getElementById(`price-${sym}`);
            if(el) {
                el.textContent = price;
                el.className = `sym-price ${parseFloat(msg.data.P)>=0?'up':'down'}`;
            }
        };
        // çˆ†å€‰ç›£æ§æµ
        const wsLiq = new WebSocket(`wss://fstream.binance.com/ws/!forceOrder@arr`);
        wsLiq.onmessage = (e) => {
            const msg = JSON.parse(e.data);
            const o = msg.o;
            const sym = o.s.toLowerCase();
            const amt = parseFloat(o.q) * parseFloat(o.p);
            if (store[sym] && amt > 10000) { // å¤§é¡çˆ†å€‰æ‰è­¦å ±
                const alert = document.getElementById(`liq-alert-${sym}`);
                alert.style.display = 'block';
                alert.textContent = `ğŸ’¥ ${o.S} çˆ†å€‰ $${(amt/1000).toFixed(1)}k`;
                setTimeout(()=>alert.style.display='none', 3000);
            }
        }
    }

    runAnalysis();
</script>
</body>
</html>
