<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨ç¶­åº¦æˆ°æƒ…å®¤ (V56 æŒ‡æ®å®˜é‡è£½ç‰ˆ)</title>
    <style>
        /* =========================================
           V56 åŸç‰ˆæ¨£å¼å¾©åˆ» (High Density UI)
           ========================================= */
        :root {
            --bg: #0b0e11; --card: #161a1e; --text-main: #eaecef; --text-sub: #848e9c;
            --green: #0ecb81; --green-bg: rgba(14, 203, 129, 0.15);
            --red: #f6465d; --red-bg: rgba(246, 70, 93, 0.15);
            --yellow: #fcd535; --yellow-bg: rgba(252, 213, 53, 0.1);
            --gold: #ffd700; --gold-bg: rgba(255, 215, 0, 0.25);
            --silver: #e0e0e0; --silver-bg: rgba(224, 224, 224, 0.15);
            --bronze: #ffad5e; --bronze-bg: rgba(255, 173, 94, 0.15);
            --blue: #2979ff; --blue-bg: rgba(41, 121, 255, 0.15);
            --purple: #bf5af2; --purple-bg: rgba(191, 90, 242, 0.2);
            --border: #2b3139; --modal-bg: #1e2329;
        }
        body { background-color: var(--bg); color: var(--text-main); font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif; margin: 0; padding: 15px; font-size: 13px; }

        /* Header & Status */
        .header { border-bottom: 2px solid var(--border); padding-bottom: 15px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .btc-bar { background: #1e2329; padding: 6px 12px; border-radius: 4px; border-left: 4px solid var(--yellow); font-size: 11px; display: flex; gap: 15px; align-items: center; }
        .timer-bar-bg { width: 100px; height: 4px; background: #333; border-radius: 2px; overflow: hidden; }
        .timer-bar-fill { height: 100%; background: var(--yellow); width: 0%; transition: width 0.5s linear; }

        /* Grid Layout */
        #grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 10px; }

        /* Card Styles */
        .coin-card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 10px; overflow: hidden; transition: all 0.2s ease; }
        .coin-card.expanded { border-color: #666; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .card-header { padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1e2329; border-bottom: 1px solid transparent; }
        .coin-card.expanded .card-header { border-bottom: 1px solid var(--border); background: #252a30; }

        .ch-left { display: flex; align-items: center; gap: 10px; }
        .sym-name { font-size: 16px; font-weight: 900; color: #fff; width: 80px; }
        .sym-price { font-family: 'Roboto Mono'; font-weight: bold; font-size: 15px; width: 85px; }
        .up { color: var(--green); } .down { color: var(--red); }
        
        .ch-right { display: flex; align-items: center; gap: 10px; }
        .risk-tag { font-size: 10px; padding: 2px 5px; border-radius: 3px; background: #333; color: #888; }
        .risk-high { background: var(--red-bg); color: var(--red); font-weight: bold; animation: blink 1s infinite; }
        
        /* å¾½ç«  */
        .tier-badge { font-size: 12px; padding: 3px 8px; border-radius: 4px; font-weight: bold; display: none; margin-left:5px; }
        .tier-s { background: var(--gold-bg); color: var(--gold); border: 1px solid var(--gold); display: inline-block; box-shadow: 0 0 8px rgba(255, 215, 0, 0.3); animation: pulse 2s infinite; }
        .tier-a { background: var(--silver-bg); color: var(--silver); border: 1px solid var(--silver); display: inline-block; }
        .tier-b { background: var(--bronze-bg); color: var(--bronze); border: 1px solid var(--bronze); display: inline-block; }
        .tier-q { background: var(--purple-bg); color: var(--purple); border: 1px solid var(--purple); display: inline-block; animation: pulse 2s infinite; }
        .tier-z { background: #333; color: #666; border: 1px dashed #555; display: inline-block; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* Card Body Layout */
        .card-body { display: none; padding: 10px; background: #111; grid-template-columns: 120px 1fr 1fr 1fr; gap: 5px; }
        .coin-card.expanded .card-body { display: grid; }

        /* Columns */
        .col-info { padding: 5px; border-right: 1px dashed #333; display: flex; flex-direction: column; gap: 8px; font-size: 11px; }
        .col-tf { padding: 5px; border-right: 1px dashed #333; display: flex; flex-direction: column; }
        .col-tf:last-child { border-right: none; }
        .tf-header { margin-bottom: 5px; border-bottom: 1px solid #333; padding-bottom: 3px; display: flex; justify-content: space-between; font-weight: bold; color: #fff; }

        /* å‹ç‡æ¢ */
        .wr-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; margin-bottom: 2px; }
        .wr-bar-long { height: 100%; background: var(--green); transition: width 0.5s; }
        .wr-bar-short { height: 100%; background: var(--red); transition: width 0.5s; }
        .wr-text { font-size: 9px; display: flex; justify-content: space-between; color: #888; margin-bottom: 5px; }

        /* æŒ‡æ¨™åˆ—è¡¨ */
        .ind-list { display: grid; grid-template-columns: 1fr; gap: 2px; margin-bottom: 8px; }
        .ind-item { display: flex; justify-content: space-between; font-size: 10px; padding: 2px 4px; background: rgba(255,255,255,0.03); border-radius: 2px; }
        .active-side { font-weight: bold; text-decoration: underline; }

        /* æˆ°è¡“å…­å®®æ ¼ */
        .strat-box { margin-top: auto; padding: 5px; border-radius: 4px; text-align: center; border: 1px solid transparent; background: #1a1a1a; }
        .strat-long { background: var(--green-bg); border-color: var(--green); }
        .strat-short { background: var(--red-bg); border-color: var(--red); }
        .strat-wait { background: #2b3139; border-color: #444; color: #888; }
        .strat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px; text-align: left; margin-top: 5px; }
        .sg-row { display: flex; justify-content: space-between; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 2px; }
        .sg-label { color: #888; font-size: 9px; }
        .sg-val { font-family: 'Roboto Mono'; font-weight: bold; color: #fff; }
        .sg-trailing { color: var(--blue); font-weight: bold; }
        .sg-profit { color: var(--gold); font-weight: bold; }

        /* Volume & Flow */
        .vol-box { padding-top: 5px; border-top: 1px dashed #333; }
        .flow-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 3px; overflow: hidden; display: flex; margin-bottom: 2px; }
        .flow-buy { height: 100%; background: var(--green); } .flow-sell { height: 100%; background: var(--red); }
        .vol-tag { padding: 1px 4px; border-radius: 2px; font-weight: bold; font-size: 10px; display: inline-block; margin-top: 2px;}
        .v-high { background: var(--yellow); color: #000; } .v-norm { background: #444; color: #ccc; } .v-low { background: #222; color: #666; }

        /* Loading Overlay */
        .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; display:flex; flex-direction:column; justify-content:center; align-items:center; color: #fff; }
        
        @media (max-width: 900px) { 
            .card-body { grid-template-columns: 1fr; gap: 10px; } 
            .col-info { border-right: none; border-bottom: 1px solid var(--border); padding-bottom: 10px; flex-direction: row; flex-wrap: wrap; justify-content: space-between; }
            .col-tf { border-right: none; border-bottom: 1px dashed #333; padding: 10px 0; }
            .ind-list { grid-template-columns: 1fr 1fr; gap: 5px; }
        }
    </style>
</head>
<body>

<div id="loading" class="loading-overlay">
    <h2>ğŸš€ V56 æŒ‡æ®å®˜ç³»çµ±å•Ÿå‹•ä¸­</h2>
    <p>æ­£åœ¨è¨ˆç®—å…¨å¸‚å ´å›æ¸¬æ•¸æ“šèˆ‡æŒ‡æ¨™...</p>
    <div style="margin-top:10px; font-size:12px; color:#aaa;" id="loading-detail">åˆå§‹åŒ–éšŠåˆ—...</div>
</div>

<div class="header">
    <div>
        <h1 style="margin:0; font-size:20px;">å…¨ç¶­åº¦æˆ°æƒ…å®¤ <span style="font-size:12px; color:var(--yellow); border:1px solid var(--yellow); padding:2px 5px; border-radius:3px;">V56 COMMANDER</span></h1>
    </div>
    <div class="btc-bar">
        <span>BTC éŒ¨å®š: <strong id="btc-trend" style="color:#888;">...</strong></span>
        <span>æ¬Šé‡: <strong id="btc-weight">x1.0</strong></span>
        <div class="timer-bar-bg" title="åˆ·æ–°å€’æ•¸"><div class="timer-bar-fill" id="timer-bar"></div></div>
        <button onclick="testDiscord()" style="background:#5865F2; border:none; color:#fff; cursor:pointer; font-size:10px; padding:2px 6px; border-radius:3px;">æ¸¬è©¦é€šçŸ¥</button>
    </div>
</div>

<div id="grid-container"></div>

<script>
    // ==========================================
    // âš™ï¸ è¨­å®šå€åŸŸ
    // ==========================================
    const CONFIG = {
        DISCORD_WEBHOOK: "", // å¡«å…¥ Webhook
        PROXY_URL: "https://corsproxy.io/?", // è§£æ±º CORS
        BAN_DELAY: 400, // é˜²å°é–å»¶é² (ms)
        LIMIT: 500 // Kç·šå›æ¸¬é•·åº¦
    };

    // ==========================================
    // ğŸš¦ æ ¸å¿ƒ: é˜²å°é– API éšŠåˆ—
    // ==========================================
    const API_QUEUE = {
        items: [],
        processing: false,
        add(fn) {
            return new Promise((resolve, reject) => {
                this.items.push({ fn, resolve, reject });
                this.process();
            });
        },
        async process() {
            if (this.processing || this.items.length === 0) return;
            this.processing = true;
            const { fn, resolve, reject } = this.items.shift();
            try {
                const res = await fn();
                resolve(res);
            } catch (e) {
                reject(e);
            }
            setTimeout(() => {
                this.processing = false;
                this.process();
            }, CONFIG.BAN_DELAY);
        }
    };

    async function safeFetch(url) {
        return API_QUEUE.add(() => fetch(CONFIG.PROXY_URL + encodeURIComponent(url)).then(r => {
            if(!r.ok) throw new Error(r.status);
            return r.json();
        }));
    }

    // ==========================================
    // ğŸ§® æ•¸å­¸å¼•æ“ (V56 å®Œæ•´ç‰ˆ)
    // ==========================================
    const MathEngine = {
        sma: (d, p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        emaArray: (d, p) => { let k=2/(p+1), e=[d[0]]; for(let i=1;i<d.length;i++) e.push(d[i]*k+e[i-1]*(1-k)); return e; },
        rsiArray: (c, p=14) => {
            let rsi=[], g=0, l=0;
            for(let i=1;i<=p;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/p, al=l/p; rsi[p]=100-(100/(1+ag/al));
            for(let i=p+1;i<c.length;i++){ let d=c[i]-c[i-1]; d>0?ag=(ag*(p-1)+d)/p:al=(al*(p-1)-d)/p; rsi[i]=al===0?100:100-(100/(1+ag/al)); }
            return rsi;
        },
        atrArray: (h, l, c, p=14) => {
            let trs = [h[0]-l[0]];
            for(let i=1; i<h.length; i++) trs.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
            let atr = [trs[0]];
            for(let i=1; i<trs.length; i++) if(i<p) atr.push((atr[i-1]*i+trs[i])/(i+1)); else atr.push((atr[i-1]*(p-1)+trs[i])/p);
            return atr;
        },
        adx: (h, l, c, p=14) => {
            let plusDM=[], minusDM=[], tr=[];
            for(let i=1;i<h.length;i++){
                tr.push(Math.max(h[i]-l[i], Math.abs(h[i]-c[i-1]), Math.abs(l[i]-c[i-1])));
                let up=h[i]-h[i-1], down=l[i-1]-l[i];
                plusDM.push((up>down && up>0)?up:0); minusDM.push((down>up && down>0)?down:0);
            }
            const smooth = (arr, len) => { let res=[], s=0; for(let i=0;i<arr.length;i++){ s+=arr[i]; if(i>=len) s-=arr[i-len]; res.push(i<len?s/(i+1):s/len); } return res; };
            let trS=smooth(tr,p), pS=smooth(plusDM,p), mS=smooth(minusDM,p), dx=[];
            for(let i=0;i<trS.length;i++){ let sum=pS[i]+mS[i], diff=Math.abs(pS[i]-mS[i]); dx.push(sum===0?0:(diff/sum)*100); }
            const adxArr = smooth(dx, p);
            return adxArr[adxArr.length-1];
        },
        bollinger: (c, p=20, mult=2) => {
            const sma = c.slice(-p).reduce((a,b)=>a+b,0)/p;
            const std = Math.sqrt(c.slice(-p).map(x=>Math.pow(x-sma,2)).reduce((a,b)=>a+b)/p);
            return { upper: sma+mult*std, lower: sma-mult*std, mid: sma, width: sma===0?0:(mult*std*2)/sma };
        },
        // å›æ¸¬å¼•æ“ï¼šè¨ˆç®—çœŸå¯¦å‹ç‡
        getRealisticWinRate: (signals, closes, highs, lows, atrs, direction) => {
            let wins=0, trades=0;
            if(signals.length < 50) return 50;
            for(let i=50; i<signals.length-24; i++){
                if(!signals[i]) continue;
                const entry = closes[i], curATR = atrs[i];
                const slDist = curATR * 1.5, tpDist = curATR * 2.0;
                let sl = direction==='long' ? entry - slDist : entry + slDist;
                let tp = direction==='long' ? entry + tpDist : entry - tpDist;
                let outcome = 'timeout';
                for(let k=1; k<=24; k++){
                    let h = highs[i+k], l = lows[i+k];
                    if(direction==='long'){ if(l <= sl) { outcome='loss'; break; } if(h >= tp) { outcome='win'; break; } } 
                    else { if(h >= sl) { outcome='loss'; break; } if(l <= tp) { outcome='win'; break; } }
                }
                if(outcome==='win') wins++; if(outcome!=='timeout') trades++;
            }
            return trades<3 ? 50 : Math.round((wins/trades)*100);
        },
        calcSmartScore: (metrics) => {
            let total=0, weight=0;
            for(let m of metrics) { if(m[0]>0) { total += m[0]*m[1]; weight += m[1]; } }
            return weight===0 ? 50 : total/weight;
        },
        kelly: (winRate, riskReward=2.0) => {
            const w = winRate / 100;
            return (w * riskReward - (1 - w)) / riskReward;
        }
    };

    // ==========================================
    // ğŸ§  ç³»çµ±ç‹€æ…‹èˆ‡é‚è¼¯
    // ==========================================
    let activeSymbols = new Set();
    let btcHistory = [];
    let btcTrendMultiplier = 1.0;
    let wss = null;
    let store = {}; // å­˜æ”¾æ‰€æœ‰è¨ˆç®—çµæœ

    // å•Ÿå‹•é»
    async function init() {
        await checkBTC();
        await updateTop10(); // æŠ“å‰10
        document.getElementById('loading').style.display = 'none';
        
        setInterval(updateTop10, 5 * 60 * 1000); // 5åˆ†é˜æ›´æ–°æ¦œå–®
        setInterval(refreshAll, 60 * 1000); // 1åˆ†é˜åˆ·æ–°æ•¸æ“š
        startTimer();
    }

    async function checkBTC() {
        try {
            const data = await safeFetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=50');
            btcHistory = data.map(d=>parseFloat(d[4]));
            const last=btcHistory[btcHistory.length-1], prev=btcHistory[btcHistory.length-2];
            const change = (last-prev)/prev;
            const el = document.getElementById('btc-trend');
            if(change > 0.003) { el.innerText="ğŸš€ ä¸Šæ¼²"; el.style.color="var(--green)"; btcTrendMultiplier=1.2; }
            else if(change < -0.003) { el.innerText="âš ï¸ ä¸‹è·Œ"; el.style.color="var(--red)"; btcTrendMultiplier=0.8; }
            else { el.innerText="âš–ï¸ éœ‡ç›ª"; el.style.color="var(--yellow)"; btcTrendMultiplier=1.0; }
            document.getElementById('btc-weight').innerText = `x${btcTrendMultiplier.toFixed(1)}`;
        } catch(e){}
    }

    // æŠ“æˆäº¤é‡å‰10 (åŒ…å«éæ¿¾ç©©å®šå¹£)
    async function updateTop10() {
        document.getElementById('loading-detail').innerText = "æƒææˆäº¤é‡æ¦œå–®...";
        try {
            const data = await safeFetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
            const blackList = ['USDCUSDT', 'USDPUSDT', 'TUSDUSDT', 'FDUSDUSDT', 'DAIUSDT'];
            let pairs = data.filter(t => t.symbol.endsWith('USDT') && !blackList.includes(t.symbol));
            pairs.sort((a,b) => parseFloat(b.quoteVolume) - parseFloat(a.quoteVolume));
            const newTop10 = new Set(pairs.slice(0, 10).map(t => t.symbol));

            // Diffing
            for(let s of activeSymbols) if(!newTop10.has(s)) removeCard(s);
            for(let s of newTop10) if(!activeSymbols.has(s)) { createCard(s); await initSymbol(s); }
            
            activeSymbols = newTop10;
            connectWSS(Array.from(activeSymbols));
        } catch(e) { console.error(e); }
    }

    function createCard(sym) {
        const c = document.getElementById('grid-container');
        const d = document.createElement('div');
        d.className = 'coin-card expanded'; // é è¨­å±•é–‹
        d.id = `card-${sym}`;
        // åŸæ±åŸå‘³çš„ V56 HTML çµæ§‹
        d.innerHTML = `
            <div class="card-header" onclick="this.parentElement.classList.toggle('expanded')">
                <div class="ch-left"><span class="sym-name">${sym.replace('USDT','')}</span><span class="tier-badge" id="tier-${sym}"></span><span class="sym-price" id="price-${sym}">--.--</span></div>
                <div class="ch-right"><span class="risk-tag" id="risk-${sym}">é¢¨éšªè¨ˆç®—ä¸­</span><span style="font-size:10px; color:#666;">â–¼</span></div>
            </div>
            <div class="card-body">
                <div class="col-info">
                    <div class="vol-box">
                        <div style="color:#aaa; display:flex; justify-content:space-between;"><span>é‡èƒ½(1H)</span><span id="vr-${sym}">--</span></div>
                        <span id="vt-${sym}" class="vol-tag v-norm">...</span>
                    </div>
                    <div style="margin-top:5px;">
                        <div style="color:#aaa; margin-bottom:2px;">ä¸»å‹•è²·è³£(1H)</div>
                        <div class="flow-bar-bg"><div class="flow-buy" id="fb-${sym}" style="width:50%"></div><div class="flow-sell" id="fs-${sym}" style="width:50%"></div></div>
                        <div style="display:flex; justify-content:space-between; font-size:9px;"><span id="fbv-${sym}" style="color:var(--green)">--</span><span id="fsv-${sym}" style="color:var(--red)">--</span></div>
                    </div>
                    <div style="border-top:1px dashed #333; padding-top:5px; margin-top:5px;">
                        <div>ADX: <span id="adx-${sym}" style="font-weight:bold;">--</span></div>
                        <div>è³‡é‡‘è²»: <span id="fr-${sym}">--</span></div>
                    </div>
                </div>
                ${['15m','1h','4h'].map(tf => `
                    <div class="col-tf">
                        <div class="tf-header"><span>${tf}</span><span id="cd-${sym}-${tf}" style="font-size:9px; color:#666;">--:--</span></div>
                        <div class="wr-bar-bg"><div class="wr-bar-long" id="wbl-${sym}-${tf}" style="width:50%"></div><div class="wr-bar-short" id="wbs-${sym}-${tf}" style="width:50%"></div></div>
                        <div class="wr-text"><span id="wtl-${sym}-${tf}">å¤š--%</span><span id="wts-${sym}-${tf}">ç©º--%</span></div>
                        <div class="ind-list" id="list-${sym}-${tf}"></div>
                        <div class="strat-box strat-wait" id="sb-${sym}-${tf}">
                            <div id="st-${sym}-${tf}" style="font-weight:bold; margin-bottom:2px;">è§€æœ›</div>
                            <div class="strat-grid">
                                <div class="sg-row"><span class="sg-label">En</span><span class="sg-val" id="en-${sym}-${tf}">--</span></div>
                                <div class="sg-row"><span class="sg-label">Kelly</span><span class="sg-val" id="k-${sym}-${tf}">--</span></div>
                                <div class="sg-row"><span class="sg-label">TP1</span><span class="sg-val" id="tp1-${sym}-${tf}">--</span></div>
                                <div class="sg-row"><span class="sg-label">TP2</span><span class="sg-val" id="tp2-${sym}-${tf}">--</span></div>
                                <div class="sg-row"><span class="sg-label">Trail</span><span class="sg-val sg-trailing" id="sl-${sym}-${tf}">--</span></div>
                                <div class="sg-row"><span class="sg-label">PnL</span><span class="sg-val sg-profit" id="pnl-${sym}-${tf}">--</span></div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
        c.appendChild(d);
    }

    function removeCard(sym) { const el=document.getElementById(`card-${sym}`); if(el) el.remove(); }

    // åˆå§‹åŒ–å–®ä¸€å¹£ç¨®æ•¸æ“š (é€™æ˜¯æœ€é‡çš„åœ°æ–¹)
    async function initSymbol(sym) {
        if(!store[sym]) store[sym] = {};
        
        // æŠ“è³‡é‡‘è²»ç‡
        safeFetch(`https://fapi.binance.com/fapi/v1/premiumIndex?symbol=${sym}`).then(d => {
            const r = parseFloat(d.lastFundingRate)*100;
            const el = document.getElementById(`fr-${sym}`);
            if(el) { el.innerText = r.toFixed(4)+'%'; el.style.color = r>0.01?'var(--red)':r<-0.01?'var(--green)':'#888'; }
        });

        // ä¾åºæŠ“ K ç·š (15m, 1h, 4h)
        for(let tf of ['15m', '1h', '4h']) {
            try {
                const klines = await safeFetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${sym}&interval=${tf}&limit=${CONFIG.LIMIT}`);
                processTimeframe(sym, tf, klines);
            } catch(e) { console.error(sym, tf, e); }
        }
        updateTier(sym);
    }

    async function refreshAll() {
        startTimer();
        for(let sym of activeSymbols) await initSymbol(sym);
    }

    // ==========================================
    // âš™ï¸ æ ¸å¿ƒé‹ç®—é‚è¼¯ (åŒ…å«æ‰€æœ‰æŒ‡æ¨™èˆ‡å›æ¸¬)
    // ==========================================
    function processTimeframe(sym, tf, klines) {
        // æº–å‚™æ•¸æ“š
        const c = klines.map(d=>parseFloat(d[4])), h=klines.map(d=>parseFloat(d[2])), l=klines.map(d=>parseFloat(d[3])), v=klines.map(d=>parseFloat(d[5]));
        const last = c.length-1, price = c[last];

        // 1. åŸºç¤æŒ‡æ¨™è¨ˆç®—
        const rsi = MathEngine.rsiArray(c);
        const atr = MathEngine.atrArray(h,l,c);
        const bb = MathEngine.bollinger(c);
        const ema50 = MathEngine.emaArray(c, 50);
        const adx = MathEngine.adx(h,l,c);
        const vwapArr = MathEngine.emaArray(c, 90); // ç°¡åŒ–æ¨¡æ“¬
        
        // 2. ç‰¹æ®Šç‹€æ…‹ (1H)
        if(tf==='1h') {
            // æ”¾é‡/ç¸®é‡
            const smaV = MathEngine.sma(v, 20);
            const r = v[last]/smaV;
            document.getElementById(`vr-${sym}`).innerText = `x${r.toFixed(1)}`;
            const vt = document.getElementById(`vt-${sym}`);
            if(r>2.5) { vt.innerText="ğŸ”¥çˆ†é‡"; vt.className="vol-tag v-high"; }
            else if(r>1.2) { vt.innerText="ğŸ“ˆæ”¾é‡"; vt.className="vol-tag v-norm"; }
            else if(r<0.6) { vt.innerText="ğŸ’¤ç¸®é‡"; vt.className="vol-tag v-low"; }
            else { vt.innerText="âš–ï¸æ­£å¸¸"; vt.className="vol-tag v-norm"; }

            // è³‡é‡‘æµ (Taker Buy)
            const buyVol = parseFloat(klines[last][9]);
            const buyRatio = (buyVol / v[last]) * 100;
            document.getElementById(`fb-${sym}`).style.width = `${buyRatio}%`;
            document.getElementById(`fs-${sym}`).style.width = `${100-buyRatio}%`;
            document.getElementById(`fbv-${sym}`).innerText = `è²·${buyRatio.toFixed(0)}%`;
            document.getElementById(`fsv-${sym}`).innerText = `è³£${(100-buyRatio).toFixed(0)}%`;

            // ADX èˆ‡ é¢¨éšª
            const adxEl = document.getElementById(`adx-${sym}`);
            adxEl.innerText = adx.toFixed(1);
            adxEl.style.color = adx>25 ? 'var(--yellow)' : '#666';

            // Risk: åƒ¹æ ¼åé›¢ VWAP ç¨‹åº¦ + æ³¢å‹•ç‡
            const dev = Math.abs(price - vwapArr[last]) / vwapArr[last] * 100;
            const risk = Math.min(99, Math.round(dev * 10 + (atr[last]/price*100)*5));
            const rEl = document.getElementById(`risk-${sym}`);
            rEl.innerText = `é¢¨éšª ${risk}%`;
            rEl.className = `risk-tag ${risk>70?'risk-high':''}`;
        }

        // 3. å›æ¸¬æ¨¡æ“¬ (ç”¢ç”Ÿä¿¡è™Ÿ)
        const sigs = {
            rsi: { b: c.map((p,i)=>rsi[i]<35), s: c.map((p,i)=>rsi[i]>65) },
            ema: { b: c.map((p,i)=>p>ema50[i]), s: c.map((p,i)=>p<ema50[i]) },
            boll: { b: c.map((p,i)=>p>bb.upper), s: c.map((p,i)=>p<bb.lower) }
        };
        
        // è¨ˆç®—çœŸå¯¦å‹ç‡
        const wrR = { l: MathEngine.getRealisticWinRate(sigs.rsi.b,c,h,l,atr,'long'), s: MathEngine.getRealisticWinRate(sigs.rsi.s,c,h,l,atr,'short') };
        const wrE = { l: MathEngine.getRealisticWinRate(sigs.ema.b,c,h,l,atr,'long'), s: MathEngine.getRealisticWinRate(sigs.ema.s,c,h,l,atr,'short') };
        const wrB = { l: MathEngine.getRealisticWinRate(sigs.boll.b,c,h,l,atr,'long'), s: MathEngine.getRealisticWinRate(sigs.boll.s,c,h,l,atr,'short') };

        // ç¶œåˆè©•åˆ†
        let scoreL = (wrR.l + wrE.l + wrB.l) / 3;
        let scoreS = (wrR.s + wrE.s + wrB.s) / 3;
        
        // å¦‚æœ BTC è¶¨å‹¢ä¸å¥½ï¼Œåšå¤šæ‰£åˆ†
        if(btcTrendMultiplier < 1.0) scoreL *= 0.9;
        if(btcTrendMultiplier > 1.0) scoreS *= 0.9;

        // æ›´æ–° UI: å‹ç‡æ¢
        document.getElementById(`wbl-${sym}-${tf}`).style.width = `${Math.min(100, scoreL)}%`;
        document.getElementById(`wbs-${sym}-${tf}`).style.width = `${Math.min(100, scoreS)}%`;
        document.getElementById(`wtl-${sym}-${tf}`).innerText = `å¤š${scoreL.toFixed(0)}%`;
        document.getElementById(`wts-${sym}-${tf}`).innerText = `ç©º${scoreS.toFixed(0)}%`;

        // æ›´æ–° UI: æŒ‡æ¨™åˆ—è¡¨ (å¾©åˆ»åŸç‰ˆ)
        const addI = (n, v, cond) => `<div class="ind-item"><span>${n}</span><span style="font-weight:bold; color:${cond==='l'?'var(--green)':cond==='s'?'var(--red)':'#888'}">${v}</span></div>`;
        const listHtml = 
            addI('RSI', rsi[last].toFixed(1), rsi[last]>60?'s':rsi[last]<40?'l':'n') +
            addI('EMA', price>ema50[last]?'ä¹‹ä¸Š':'ä¹‹ä¸‹', price>ema50[last]?'l':'s') +
            addI('BB', (bb.width*100).toFixed(2)+'%', bb.width<0.05?'n':'n'); // ç°¡åŒ–
        document.getElementById(`list-${sym}-${tf}`).innerHTML = listHtml;

        // 4. æˆ°è¡“å…­å®®æ ¼è¨ˆç®—
        const curAtr = atr[last];
        const slDist = curAtr * 1.5;
        const tpDist = curAtr * 2.5;
        let dir = 'wait';
        
        // ç°¡å–®çš„æ±ºç­–é‚è¼¯
        if (scoreL > 55 && scoreL > scoreS && adx > 20) dir = 'long';
        else if (scoreS > 55 && scoreS > scoreL && adx > 20) dir = 'short';

        // å„²å­˜æ±ºç­–ä¾› Tier åˆ¤æ–·
        store[sym][tf] = { dir, score: Math.max(scoreL, scoreS), adx };

        const box = document.getElementById(`sb-${sym}-${tf}`);
        const stTitle = document.getElementById(`st-${sym}-${tf}`);
        
        // å¡«å……æ•¸æ“š
        const p = (v) => v.toFixed(price<1?4:2);
        
        if (dir === 'long') {
            box.className = 'strat-box strat-long';
            stTitle.innerText = "å»ºè­°åšå¤š";
            document.getElementById(`en-${sym}-${tf}`).innerText = p(price);
            document.getElementById(`sl-${sym}-${tf}`).innerText = p(price - slDist);
            document.getElementById(`tp1-${sym}-${tf}`).innerText = p(price + curAtr);
            document.getElementById(`tp2-${sym}-${tf}`).innerText = p(price + tpDist);
            const k = MathEngine.kelly(scoreL, 2.0) * 100;
            document.getElementById(`k-${sym}-${tf}`).innerText = k>0 ? k.toFixed(0)+'%' : '0%';
            document.getElementById(`pnl-${sym}-${tf}`).innerText = `+${((tpDist/price)*100).toFixed(2)}%`;
        } else if (dir === 'short') {
            box.className = 'strat-box strat-short';
            stTitle.innerText = "å»ºè­°åšç©º";
            document.getElementById(`en-${sym}-${tf}`).innerText = p(price);
            document.getElementById(`sl-${sym}-${tf}`).innerText = p(price + slDist);
            document.getElementById(`tp1-${sym}-${tf}`).innerText = p(price - curAtr);
            document.getElementById(`tp2-${sym}-${tf}`).innerText = p(price - tpDist);
            const k = MathEngine.kelly(scoreS, 2.0) * 100;
            document.getElementById(`k-${sym}-${tf}`).innerText = k>0 ? k.toFixed(0)+'%' : '0%';
            document.getElementById(`pnl-${sym}-${tf}`).innerText = `+${((tpDist/price)*100).toFixed(2)}%`;
        } else {
            box.className = 'strat-box strat-wait';
            stTitle.innerText = "è§€æœ›";
            // è§€æœ›ä¹Ÿè¦é¡¯ç¤ºåƒè€ƒå€¼
            document.getElementById(`en-${sym}-${tf}`).innerText = p(price);
            document.getElementById(`sl-${sym}-${tf}`).innerText = "---";
        }
    }

    function updateTier(sym) {
        if(!store[sym] || !store[sym]['15m']) return;
        const d15 = store[sym]['15m'].dir;
        const d1h = store[sym]['1h'].dir;
        const d4h = store[sym]['4h'].dir;
        const adx = store[sym]['1h'].adx;

        let tier = '';
        if (d15 !== 'wait' && d15 === d1h && d1h === d4h) tier = 'S';
        else if (d15 !== 'wait' && d15 === d1h) tier = 'A';
        else if (d15 !== 'wait') tier = 'B';
        
        // æ“ å£“åˆ¤æ–· (BB Squeeze) - éœ€å¾ store å–ï¼Œé€™è£¡ç°¡åŒ–è™•ç†
        if (adx < 15) tier = 'Z';

        const b = document.getElementById(`tier-${sym}`);
        if(tier) {
            b.className = `tier-badge tier-${tier.toLowerCase()}`;
            b.innerText = tier === 'Z' ? 'ğŸ’¤ æ®­å±' : `${tier}ç´š`;
            b.style.display = 'inline-block';
        } else {
            b.style.display = 'none';
        }
    }

    // ==========================================
    // ğŸ“¡ WebSocket & Timer
    // ==========================================
    function connectWSS(symbols) {
        if(wss) wss.close();
        const streams = symbols.map(s => `${s.toLowerCase()}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = (e) => {
            const d = JSON.parse(e.data).data;
            const el = document.getElementById(`price-${d.s}`);
            if(el) {
                const old = parseFloat(el.innerText);
                const now = parseFloat(d.c);
                el.innerText = now;
                el.className = `sym-price ${now>=old?'up':'down'}`;
            }
        };
    }

    function startTimer() {
        const b = document.getElementById('timer-bar');
        b.style.width = '100%';
        setTimeout(() => b.style.width = '0%', 100);
        b.style.transition = 'width 60s linear';
    }
    
    function testDiscord() { alert("é€šçŸ¥åŠŸèƒ½éœ€é…ç½®å¾Œç«¯è½‰ç™¼ï¼ŒGitHub Pages æš«ä¸æ”¯æ´ç›´æ¥ç™¼é€ä»¥ä¿è­· Keyã€‚"); }

    // Start
    init();

</script>
</body>
</html>
