<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>戰情室 V29 (量化數學核心版)</title>
    <style>
        :root { --bg: #0b0e11; --card: #161a1e; --text: #eaecef; --green: #0ecb81; --red: #f6465d; --yellow: #fcd535; --border: #2b3139; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; font-size: 13px; }
        .header { border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .btn { background: #2b3139; color: #fff; border: 1px solid #444; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
        
        /* 數學數據儀表板 */
        .math-bar { display: flex; gap: 10px; font-size: 11px; margin-bottom: 5px; opacity: 0.8; }
        .math-tag { background: #1e2329; padding: 2px 5px; border-radius: 3px; border: 1px solid #333; }

        /* 卡片系統 */
        .card { background: var(--card); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; overflow: hidden; }
        .card-head { padding: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; background: #1e2329; }
        .card.exp .card-head { border-bottom: 1px solid var(--border); }
        .card-body { display: none; padding: 8px; background: #111; grid-template-columns: 180px 1fr 1fr 1fr; gap: 8px; }
        .card.exp .card-body { display: grid; }

        /* EV 與 信號標籤 */
        .sig-badge { padding: 3px 8px; border-radius: 4px; font-weight: bold; min-width: 80px; text-align: center; }
        .sb-long { background: rgba(14, 203, 129, 0.15); color: var(--green); border: 1px solid var(--green); }
        .sb-short { background: rgba(246, 70, 93, 0.15); color: var(--red); border: 1px solid var(--red); }
        .sb-wait { background: #333; color: #888; border: 1px solid #555; }
        
        .ev-val { font-family: 'Roboto Mono'; font-weight: bold; }
        .ev-pos { color: var(--green); } .ev-neg { color: var(--red); }

        /* 佈局細節 */
        .col-info { display: flex; flex-direction: column; gap: 5px; border-right: 1px dashed #333; padding-right: 5px; }
        .col-tf { display: flex; flex-direction: column; border-right: 1px dashed #333; padding: 0 5px; }
        .col-tf:last-child { border: none; }
        
        .ind-row { display: flex; justify-content: space-between; font-size: 11px; padding: 2px 0; border-bottom: 1px solid #222; }
        .strat-box { margin-top: auto; padding: 5px; border: 1px solid #444; border-radius: 4px; text-align: center; }
        
        /* Modal */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; justify-content:center; align-items:center; z-index:99; }
        .modal-box { background:#1e2329; width:90%; max-width:400px; padding:20px; border-radius:8px; }
        .coin-list { display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; max-height:300px; overflow-y:auto; margin:10px 0; }
        .c-opt { padding:5px; text-align:center; border:1px solid #444; border-radius:4px; cursor:pointer; }
        .c-opt.sel { border-color:var(--green); color:var(--green); }

        @media (max-width: 900px) { .card-body { grid-template-columns: 1fr; } .col-info, .col-tf { border-right: none; border-bottom: 1px dashed #333; padding-bottom: 10px; } }
    </style>
</head>
<body>

<div class="modal" id="modal">
    <div class="modal-box">
        <h3>選擇監控幣種</h3>
        <input type="text" id="search" placeholder="Search..." style="width:100%; padding:8px; background:#000; border:1px solid #444; color:#fff;" onkeyup="filterCoins()">
        <div class="coin-list" id="cList"></div>
        <button class="btn" style="width:100%; background:var(--green); border:none;" onclick="applyFilter()">確認</button>
    </div>
</div>

<div class="header">
    <div>
        <h2 style="margin:0; font-size:18px;">V29 量化數學核心</h2>
        <div style="font-size:11px; color:#888;">EV模型 | 動態Beta | 效率係數ER</div>
    </div>
    <button class="btn" onclick="openModal()">+ 幣種</button>
</div>

<div id="grid">
    <div style="text-align:center; padding:50px; color:#666;">正在計算大盤相關係數 ($\rho$) 與 期望值 (EV)...</div>
</div>

<script>
    const TFS = ['15m', '1h', '4h'];
    const DEFAULT = ['btcusdt', 'ethusdt', 'solusdt', 'adausdt', 'xrpusdt', 'riverusdt', 'nxpcusdt'];
    let active = new Set(DEFAULT);
    let allSyms = [];
    let btcData = {}; // 存儲 BTC 歷史數據用於計算相關性
    let wss = null;

    // --- 1. 數學引擎 (V29 核心) ---
    const MathCore = {
        sma: (d,p) => d.slice(-p).reduce((a,b)=>a+b,0)/p,
        ema: (d,p) => { let k=2/(p+1), e=[d[0]]; for(let i=1;i<d.length;i++) e.push(d[i]*k+e[i-1]*(1-k)); return e; },
        rsi: (c) => { 
            let r=[], g=0, l=0; for(let i=1;i<=14;i++){ let d=c[i]-c[i-1]; d>0?g+=d:l-=d; }
            let ag=g/14, al=l/14; r[14]=100-(100/(1+ag/al));
            for(let i=15;i<c.length;i++){ let d=c[i]-c[i-1]; d>0?ag=(ag*13+d)/14:al=(al*13-d)/14; r[i]=al===0?100:100-(100/(1+ag/al)); }
            return r;
        },
        atr: (h,l,c,p=14) => { 
            let trs=[]; for(let i=1;i<h.length;i++) trs.push(Math.max(h[i]-l[i],Math.abs(h[i]-c[i-1]),Math.abs(l[i]-c[i-1]))); 
            return trs.slice(-p).reduce((a,b)=>a+b,0)/p; 
        },
        // [新增] 效率係數 (Efficiency Ratio) - 判斷是趨勢還是震盪
        calcER: (closes, period=10) => {
            if(closes.length < period+1) return 0.5;
            const change = Math.abs(closes[closes.length-1] - closes[closes.length-period-1]);
            let volatility = 0;
            for(let i=closes.length-period; i<closes.length; i++) volatility += Math.abs(closes[i] - closes[i-1]);
            return volatility === 0 ? 0 : change / volatility;
        },
        // [新增] 皮爾森相關係數 (Pearson Correlation) - 計算動態 Beta
        calcCorrelation: (dataA, dataB, period=24) => {
            if(!dataB || dataB.length < period || dataA.length < period) return 1; // 預設完全相關
            const sliceA = dataA.slice(-period), sliceB = dataB.slice(-period);
            const avgA = sliceA.reduce((a,b)=>a+b,0)/period, avgB = sliceB.reduce((a,b)=>a+b,0)/period;
            let num=0, denA=0, denB=0;
            for(let i=0; i<period; i++) {
                let dA = sliceA[i]-avgA, dB = sliceB[i]-avgB;
                num += dA * dB; denA += dA*dA; denB += dB*dB;
            }
            return denA===0 || denB===0 ? 0 : num / Math.sqrt(denA * denB);
        },
        // [新增] 期望值計算 (Expected Value)
        calcEV: (winRate, entry, sl, tp) => {
            const reward = Math.abs(tp - entry) / entry; // 潛在獲利 %
            const risk = Math.abs(entry - sl) / entry;   // 潛在虧損 %
            const winP = winRate / 100;
            return (winP * reward) - ((1 - winP) * risk);
        },
        // 時間加權勝率
        weightedWR: (sigs, c, t) => {
            let wWins=0, totalW=0;
            for(let i=50; i<sigs.length-5; i++) {
                if(sigs[i]) {
                    const w = Math.pow(1.008, i); // 加重時間權重
                    totalW += w;
                    if((t=='long'&&c[i+5]>c[i]*1.002)||(t=='short'&&c[i+5]<c[i]*0.998)) wWins += w;
                }
            }
            return totalW===0 ? 0 : Math.round((wWins/totalW)*100);
        }
    };

    // --- 2. 系統初始化 ---
    async function init() {
        // 先抓 BTC 數據做錨定基準
        try {
            const res = await fetch('https://fapi.binance.com/fapi/v1/klines?symbol=BTCUSDT&interval=1h&limit=100');
            const data = await res.json();
            btcData['1h'] = data.map(d=>parseFloat(d[4])); // 存收盤價
        } catch(e) {}
        
        await fetchSyms();
        render();
    }

    async function fetchSyms() {
        try {
            const r = await fetch('https://fapi.binance.com/fapi/v1/exchangeInfo');
            const d = await r.json();
            allSyms = d.symbols.filter(s=>s.quoteAsset=='USDT' && s.status=='TRADING').map(s=>s.symbol.replace('USDT','').toLowerCase()).sort();
        } catch(e){}
    }

    // --- 3. 渲染與計算 ---
    async function render() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        if(wss) wss.close();
        for(const s of active) { await drawCard(s); await new Promise(r=>setTimeout(r,50)); }
        conWSS();
    }

    async function drawCard(s) {
        const grid = document.getElementById('grid');
        const div = document.createElement('div');
        div.className = 'card';
        div.id = `card-${s}`;
        div.innerHTML = `
            <div class="card-head" onclick="this.parentElement.classList.toggle('exp')">
                <div>
                    <span style="font-weight:bold; font-size:16px;">${s.toUpperCase()}</span>
                    <span id="p-${s}" style="font-family:monospace; margin-left:10px;">--.--</span>
                </div>
                <div>
                    <span id="beta-${s}" class="math-tag">Beta: --</span>
                    <span id="badge-${s}" class="sig-badge sb-wait">分析中</span>
                </div>
            </div>
            <div class="card-body">
                <div class="col-info">
                    <div style="color:#aaa; font-size:10px;">核心數據分析</div>
                    <div class="ind-row"><span>相關係數($\\rho$)</span><strong id="rho-${s}">--</strong></div>
                    <div class="ind-row"><span>趨勢效率(ER)</span><strong id="er-${s}">--</strong></div>
                    <div class="ind-row"><span>籌碼牆</span><strong id="wall-${s}" style="color:var(--yellow)">--</strong></div>
                    <div class="ind-row"><span>插針風險</span><strong id="risk-${s}">--%</strong></div>
                    <div style="margin-top:auto; text-align:right; cursor:pointer; color:#666;" onclick="rm('${s}')">移除</div>
                </div>
                ${TFS.map(tf => `<div class="col-tf" id="tf-${s}-${tf}"></div>`).join('')}
            </div>
        `;
        grid.appendChild(div);

        // Fetch Data
        try {
            const proms = TFS.map(tf => fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${s.toUpperCase()}USDT&interval=${tf}&limit=500`).then(r=>r.json()));
            const res = await Promise.all(proms);
            
            // 計算與 BTC 的相關性 (使用 1h 數據)
            const closes1h = res[1].map(d=>parseFloat(d[4]));
            const correlation = MathCore.calcCorrelation(closes1h, btcData['1h']);
            document.getElementById(`rho-${s}`).textContent = correlation.toFixed(2);
            document.getElementById(`beta-${s}`).textContent = `Corr: ${correlation.toFixed(2)}`;
            
            // 如果相關性高(>0.8)且BTC在跌，記錄為風險
            const btcDump = btcData['1h'][btcData['1h'].length-1] < btcData['1h'][btcData['1h'].length-5];
            const marketRisk = (correlation > 0.7 && btcDump);

            res.forEach((d, i) => process(s, TFS[i], d, marketRisk));
        } catch(e){}
    }

    function process(s, tf, data, marketRisk) {
        data.pop();
        const c=data.map(d=>parseFloat(d[4])), h=data.map(d=>parseFloat(d[2])), l=data.map(d=>parseFloat(d[3]));
        const last=c.length-1, cur=c[last];

        // 計算數學指標
        const er = MathCore.calcER(c, 14); // 效率係數
        if(tf==='1h') document.getElementById(`er-${s}`).textContent = er.toFixed(2);
        
        const atr = MathCore.atr(h,l,c);
        const rsi = MathCore.rsi(c), ema = MathCore.ema(c,50);
        const macdS=MathCore.ema(c,12), macdL=MathCore.ema(c,26), macd=macdS.map((v,i)=>v-macdL[i]);
        const vwap = MathCore.sma(c,90); 
        const bollM=MathCore.sma(c,20), std=Math.sqrt(c.slice(-20).map(x=>Math.pow(x-bollM,2)).reduce((a,b)=>a+b)/20);
        
        // 籌碼牆 & 風險
        if(tf==='1h') {
            const risk = Math.min(100, Math.round(Math.abs(cur-vwap)/vwap*600));
            const rEl = document.getElementById(`risk-${s}`);
            rEl.textContent = `${risk}%`; rEl.style.color = risk>70? 'var(--red)':'var(--text)';
            // 簡單籌碼牆模擬 (成交量最大處)
            let maxV=0, wall=0; 
            data.forEach(k=>{ let vol=parseFloat(k[5]); if(vol>maxV){maxV=vol; wall=parseFloat(k[4]);} });
            document.getElementById(`wall-${s}`).textContent = wall;
        }

        // 動態權重分配 (Regime Switching)
        // ER 高 (趨勢) -> EMA/MACD 權重高; ER 低 (震盪) -> RSI/BOLL 權重高
        const wTrend = er > 0.5 ? 1.5 : 0.8;
        const wOsc = er < 0.4 ? 1.5 : 0.8;

        // 回測信號
        const sL = { r:rsi.map(v=>v<40), e:c.map((v,i)=>v>ema[i]), m:macd.map(v=>v>0) };
        const sS = { r:rsi.map(v=>v>60), e:c.map((v,i)=>v<ema[i]), m:macd.map(v=>v<0) };
        
        const wrR = MathCore.weightedWR(sL.r, c, 'long');
        const wrE = MathCore.weightedWR(sL.e, c, 'long');
        const wrM = MathCore.weightedWR(sL.m, c, 'long');
        
        // 綜合評分 (Score)
        let scoreL = (wrR*wOsc + wrE*wTrend + wrM*wTrend) / (wOsc + wTrend*2);
        
        // 大盤博弈修正 (Dynamic Beta Correction)
        if(marketRisk) scoreL *= 0.6; // 如果高度相關且BTC在跌，做多得分打6折

        // 結構化止損
        const low15 = Math.min(...l.slice(-15)), high15 = Math.max(...h.slice(-15));
        const slLong = Math.min(cur - atr*1.5, low15*0.999);
        const slShort = Math.max(cur + atr*1.5, high15*1.001);
        
        // 期望值 (EV) 計算
        const tpLong = cur + atr*2.5;
        const evLong = MathCore.calcEV(scoreL, cur, slLong, tpLong);
        
        // 渲染 UI
        const tfDiv = document.getElementById(`tf-${s}-${tf}`);
        const evClass = evLong>0.5 ? 'ev-pos' : (evLong<-0.5 ? 'ev-neg' : '');
        
        // 策略判定
        let action = 'wait';
        if(scoreL > 55 && evLong > 0.2) action = 'long';
        
        // 15m 標籤更新
        if(tf==='15m') {
            const badge = document.getElementById(`badge-${s}`);
            if(action=='long') { badge.textContent=`做多 (EV+${evLong.toFixed(1)})`; badge.className='sig-badge sb-long'; }
            else { badge.textContent='觀望'; badge.className='sig-badge sb-wait'; }
        }

        tfDiv.innerHTML = `
            <div style="border-bottom:1px solid #333; margin-bottom:5px; font-weight:bold; display:flex; justify-content:space-between;">
                <span>${tf}</span>
                <span class="${evClass}">EV: ${evLong.toFixed(2)}%</span>
            </div>
            <div class="ind-row"><span>RSI (${wOsc.toFixed(1)})</span><span>${rsi[last].toFixed(1)}</span></div>
            <div class="ind-row"><span>EMA (${wTrend.toFixed(1)})</span><span>${cur>ema[last]?'上':'下'}</span></div>
            <div class="strat-box ${action=='long'?'sb-long':''}">
                <div style="font-weight:bold; margin-bottom:4px;">${action=='long'?'建議做多':'觀望'}</div>
                <div style="display:grid; grid-template-columns:1fr 1fr; font-size:10px;">
                    <div>En: ${cur}</div>
                    <div>SL: ${slLong.toFixed(2)}</div>
                    <div>TP: ${tpLong.toFixed(2)}</div>
                    <div>勝率: ${Math.round(scoreL)}%</div>
                </div>
            </div>
        `;
    }

    // --- UI Utils ---
    function openModal(){ 
        const list=document.getElementById('cList'); list.innerHTML='';
        allSyms.forEach(s=>{ 
            const d=document.createElement('div'); d.className=`c-opt ${active.has(s)?'sel':''}`; 
            d.textContent=s.toUpperCase(); d.onclick=()=>d.classList.toggle('sel'); d.dataset.s=s; list.appendChild(d);
        });
        document.getElementById('modal').style.display='flex'; 
    }
    function applyFilter(){ 
        active=new Set(Array.from(document.querySelectorAll('.c-opt.sel')).map(e=>e.dataset.s)); 
        document.getElementById('modal').style.display='none'; render(); 
    }
    function filterCoins(){ const t=document.getElementById('search').value.toUpperCase(); document.querySelectorAll('.c-opt').forEach(e=>e.style.display=e.textContent.includes(t)?'block':'none'); }
    function rm(s){ active.delete(s); document.getElementById(`card-${s}`).remove(); }
    function conWSS(){
        const streams = Array.from(active).map(s=>`${s}@ticker`).join('/');
        wss = new WebSocket(`wss://fstream.binance.com/stream?streams=${streams}`);
        wss.onmessage = e => {
            const d=JSON.parse(e.data).data; const el=document.getElementById(`p-${d.s.toLowerCase()}`);
            if(el) { el.textContent=parseFloat(d.c); el.style.color=parseFloat(d.P)>=0?'var(--green)':'var(--red)'; }
        }
    }

    init();
</script>
</body>
</html>
